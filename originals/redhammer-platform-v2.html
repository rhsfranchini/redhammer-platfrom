<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RedHammer Platform v2.0</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'rh-maroon': '#802629',
            'rh-maroon-dark': '#6b2022',
            'rh-gray': '#333',
            'rh-gray-light': '#555',
          }
        },
        fontFamily: {
          'sans': ['Segoe UI', 'Tahoma', 'Geneva', 'Verdana', 'sans-serif'],
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/expr-eval@2.0.2/dist/bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ⚠️ REPLACE THESE WITH YOUR SUPABASE PROJECT VALUES
    const SUPABASE_URL = 'https://vnnafzabklkucobvpxse.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZubmFmemFia2xrdWNvYnZweHNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzNTY5NTUsImV4cCI6MjA4NDkzMjk1NX0.bMHOpfyFLHdm0svhS0MK0RoyM8vI4z8C7XTPHmtZtwI';
  </script>
  <style>
    *,*::before,*::after{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important}
    body{background:#f5f5f5;margin:0}
    .steel-gradient{background:#333}
    .nav-active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:20px;background:#802629;border-radius:0 2px 2px 0}
    input,select,textarea,button,table,th,td,span,div,p,h1,h2,h3,h4,h5,h6,label,code{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important}
    input:focus,select:focus,textarea:focus{outline:none;box-shadow:0 0 0 2px rgba(128,38,41,0.3)}
    .task-row:hover{background:#F8FAFC}
    .expand-btn{transition:transform 0.15s}.expand-btn.open{transform:rotate(90deg)}
    .editable-cell input{background:transparent;border:1px solid transparent;padding:2px 4px;border-radius:3px}
    .editable-cell input:hover{border-color:#E5E7EB}
    .editable-cell input:focus{border-color:#802629;background:white}
    .box-table{width:100%;border-collapse:collapse;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important}
    .box-table th,.box-table td{padding:4px 6px;text-align:right;border-bottom:1px solid #E5E7EB;font-size:13px;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important}
    .box-table th{font-weight:600;color:#6B7280}
    .box-table td:first-child,.box-table th:first-child{text-align:left}
    .box-table input[type="number"]{width:48px;text-align:center;padding:3px;border:1px solid #D1D5DB;border-radius:3px;font-size:13px;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important}
    .level-toggle{cursor:pointer;transition:transform 0.15s}.level-toggle:hover{transform:scale(1.1)}
    .var-table{width:100%;border-collapse:collapse;font-size:12px}
    .var-table th,.var-table td{padding:6px 8px;text-align:right;border-bottom:1px solid #E5E7EB}
    .var-table th{font-weight:600;color:#6B7280;background:#F9FAFB}
    .var-table td:first-child,.var-table th:first-child{text-align:left}
    .var-table input{width:70px;text-align:right;padding:3px 6px;border:1px solid #D1D5DB;border-radius:4px;font-size:12px}
    .save-toast{position:fixed;bottom:20px;right:20px;background:#802629;color:white;padding:12px 24px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:1000}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal-content{background:white;border-radius:12px;max-width:700px;width:95%;max-height:90vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
    .formula-display{background:#1E1E1E;color:#D4D4D4;padding:16px;border-radius:8px;min-height:50px;font-size:14px}
    .formula-display .var{color:#9CDCFE}
    .formula-display .func{color:#DCDCAA}
    .formula-display .num{color:#B5CEA8}
    .formula-display .str{color:#CE9178}
    .builder-btn{padding:8px 12px;border-radius:6px;font-size:13px;font-weight:500;cursor:pointer;transition:all 0.15s;border:1px solid #E5E7EB}
    .builder-btn:hover{transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    .builder-btn.var{background:#DBEAFE;color:#1E40AF;border-color:#93C5FD}
    .builder-btn.op{background:#F3F4F6;color:#374151;border-color:#D1D5DB}
    .builder-btn.func{background:#FEF3C7;color:#92400E;border-color:#FCD34D}
    .builder-btn.num{background:#D1FAE5;color:#065F46;border-color:#6EE7B7}
    .builder-btn.action{background:#EDE9FE;color:#5B21B6;border-color:#C4B5FD}
    .section-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:#6B7280;margin-bottom:8px}
    .lookup-builder{background:#FFFBEB;border:1px solid #FCD34D;border-radius:8px;padding:12px}
    .lookup-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .lookup-row input,.lookup-row select{padding:6px 10px;border:1px solid #D1D5DB;border-radius:4px;font-size:13px}
    
    /* Responsive styles */
    @media (max-width: 1024px) {
      .hide-lg{display:none !important}
      .show-lg{display:block !important}
    }
    @media (max-width: 768px) {
      .hide-md{display:none !important}
      .show-md{display:block !important}
      .stack-md{flex-direction:column !important}
      .full-md{width:100% !important;min-width:0 !important}
      .px-md-2{padding-left:0.5rem !important;padding-right:0.5rem !important}
      .text-md-sm{font-size:0.875rem !important}
      .gap-md-2{gap:0.5rem !important}
    }
    @media (max-width: 640px) {
      .hide-sm{display:none !important}
      .show-sm{display:block !important}
      .stack-sm{flex-direction:column !important}
      .full-sm{width:100% !important;min-width:0 !important}
      .px-sm-2{padding-left:0.5rem !important;padding-right:0.5rem !important}
      .p-sm-3{padding:0.75rem !important}
      .text-sm-xs{font-size:0.75rem !important}
    }
    
    /* Mobile menu overlay */
    .mobile-menu-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:40;opacity:0;pointer-events:none;transition:opacity 0.2s}
    .mobile-menu-overlay.open{opacity:1;pointer-events:auto}
    .mobile-sidebar{position:fixed;left:0;top:0;bottom:0;width:200px;background:#333;z-index:50;transform:translateX(-100%);transition:transform 0.2s}
    .mobile-sidebar.open{transform:translateX(0)}
    
    /* Mobile header */
    .mobile-header{display:none;position:fixed;top:0;left:0;right:0;height:56px;background:#333;z-index:30;padding:0 16px;align-items:center;justify-content:space-between}
    @media (max-width: 768px) {
      .mobile-header{display:flex}
      .desktop-sidebar{display:none}
      main.main-content{padding-top:72px !important}
    }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useMemo,createContext,useContext,useEffect,useCallback}=React;

// Initialize Supabase client (only if configured)
const SUPABASE_CONFIGURED = SUPABASE_URL && SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_ANON_KEY && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY';
const supabase = SUPABASE_CONFIGURED ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

// Auth helper functions (no-op if not configured)
const SupabaseAuth = {
  async signUp(email, password, metadata = {}) {
    if(!supabase) return { data: null, error: { message: 'Supabase not configured' } };
    const { data, error } = await supabase.auth.signUp({ 
      email, 
      password,
      options: {
        data: metadata
      }
    });
    return { data, error };
  },
  async signIn(email, password) {
    if(!supabase) return { data: null, error: { message: 'Supabase not configured' } };
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    return { data, error };
  },
  async signOut() {
    if(!supabase) return { error: null };
    const { error } = await supabase.auth.signOut();
    return { error };
  },
  async getSession() {
    if(!supabase) return null;
    const { data: { session } } = await supabase.auth.getSession();
    return session;
  },
  onAuthStateChange(callback) {
    if(!supabase) return { data: { subscription: { unsubscribe: ()=>{} } } };
    return supabase.auth.onAuthStateChange(callback);
  }
};

// Quote storage functions
const QuoteStorage = {
  // LocalStorage fallback for when Supabase is not configured
  _getLocalQuotes() {
    try {
      return JSON.parse(localStorage.getItem('rh_quotes') || '[]');
    } catch { return []; }
  },
  _setLocalQuotes(quotes) {
    localStorage.setItem('rh_quotes', JSON.stringify(quotes));
  },
  
  async saveQuote(userId, quoteData) {
    if(!supabase) {
      // LocalStorage fallback
      const quotes = this._getLocalQuotes();
      const now = new Date().toISOString();
      const existingQuote = quotes.find(q=>q.id===quoteData.id);
      const newQuote = {
        id: quoteData.id || 'local_' + Date.now(),
        user_id: userId,
        title: quoteData.title || '',
        customer_name: quoteData.customerName || '',
        project_name: quoteData.projectName || '',
        globals: quoteData.globals,
        margins: quoteData.margins,
        box_inputs: quoteData.boxInputs,
        flex_tasks: quoteData.flexTasks,
        visible_levels: quoteData.visibleLevels,
        status: quoteData.status || 'Draft',
        version: quoteData.version || 1,
        is_template: quoteData.isTemplate || false,
        template_name: quoteData.templateName || '',
        template_description: quoteData.templateDescription || '',
        version_history: quoteData.versionHistory || [],
        created_at: existingQuote?.created_at || now,
        updated_at: now
      };
      const existingIdx = quotes.findIndex(q => q.id === quoteData.id);
      if (existingIdx >= 0) {
        quotes[existingIdx] = newQuote;
      } else {
        quotes.unshift(newQuote);
      }
      this._setLocalQuotes(quotes);
      return { data: newQuote, error: null };
    }
    const { data, error } = await supabase
      .from('quotes')
      .upsert({
        id: quoteData.id || undefined,
        user_id: userId,
        customer_name: quoteData.customerName,
        project_name: quoteData.projectName,
        globals: quoteData.globals,
        margins: quoteData.margins,
        box_inputs: quoteData.boxInputs,
        flex_tasks: quoteData.flexTasks,
        visible_levels: quoteData.visibleLevels,
        is_template: quoteData.isTemplate || false,
        updated_at: new Date().toISOString()
      }, { onConflict: 'id' })
      .select()
      .single();
    return { data, error };
  },
  
  async loadQuotes(userId, includeTemplates = false) {
    if(!supabase) {
      // LocalStorage fallback
      let quotes = this._getLocalQuotes().filter(q => q.user_id === userId);
      if (!includeTemplates) {
        quotes = quotes.filter(q => !q.is_template);
      }
      return { data: quotes, error: null };
    }
    let query = supabase
      .from('quotes')
      .select('*')
      .eq('user_id', userId);
    if (!includeTemplates) {
      query = query.eq('is_template', false);
    }
    const { data, error } = await query.order('updated_at', { ascending: false });
    return { data, error };
  },
  
  async loadTemplates(userId) {
    if(!supabase) {
      const quotes = this._getLocalQuotes().filter(q => q.user_id === userId && q.is_template);
      return { data: quotes, error: null };
    }
    const { data, error } = await supabase
      .from('quotes')
      .select('*')
      .eq('user_id', userId)
      .eq('is_template', true)
      .order('updated_at', { ascending: false });
    return { data, error };
  },
  
  async deleteQuote(quoteId) {
    if(!supabase) {
      // LocalStorage fallback
      const quotes = this._getLocalQuotes().filter(q => q.id !== quoteId);
      this._setLocalQuotes(quotes);
      return { error: null };
    }
    const { error } = await supabase
      .from('quotes')
      .delete()
      .eq('id', quoteId);
    return { error };
  }
};

// TemplateStorage is now part of QuoteStorage (uses is_template flag)

// Customer Storage with Supabase support
const CustomerStorage = {
  _getLocalCustomers() {
    try {
      return JSON.parse(localStorage.getItem('rh_customers') || '[]');
    } catch { return []; }
  },
  _setLocalCustomers(customers) {
    localStorage.setItem('rh_customers', JSON.stringify(customers));
  },
  
  async saveCustomer(userId, customerData) {
    if(!supabase) {
      const customers = this._getLocalCustomers();
      const now = new Date().toISOString();
      const existingCustomer = customers.find(c => c.id === customerData.id);
      const newCustomer = {
        id: customerData.id || 'local_' + Date.now(),
        user_id: userId,
        name: customerData.name || '',
        industry: customerData.industry || '',
        annual_revenue: customerData.annual_revenue || '',
        software: customerData.software || '',
        website: customerData.website || '',
        address: customerData.address || '',
        city: customerData.city || '',
        state: customerData.state || '',
        zip: customerData.zip || '',
        contacts: customerData.contacts || [],
        notes: customerData.notes || '',
        created_at: existingCustomer?.created_at || now,
        updated_at: now
      };
      const existingIdx = customers.findIndex(c => c.id === customerData.id);
      if (existingIdx >= 0) {
        customers[existingIdx] = newCustomer;
      } else {
        customers.unshift(newCustomer);
      }
      this._setLocalCustomers(customers);
      return { data: newCustomer, error: null };
    }
    const { data, error } = await supabase
      .from('customers')
      .upsert({
        id: customerData.id || undefined,
        user_id: userId,
        name: customerData.name,
        industry: customerData.industry,
        annual_revenue: customerData.annual_revenue,
        software: customerData.software,
        website: customerData.website,
        address: customerData.address,
        city: customerData.city,
        state: customerData.state,
        zip: customerData.zip,
        contacts: customerData.contacts,
        notes: customerData.notes,
        updated_at: new Date().toISOString()
      }, { onConflict: 'id' })
      .select()
      .single();
    return { data, error };
  },
  
  async loadCustomers(userId) {
    if(!supabase) {
      const customers = this._getLocalCustomers().filter(c => c.user_id === userId);
      return { data: customers, error: null };
    }
    const { data, error } = await supabase
      .from('customers')
      .select('*')
      .eq('user_id', userId)
      .order('name', { ascending: true });
    return { data, error };
  },
  
  async deleteCustomer(customerId) {
    if(!supabase) {
      const customers = this._getLocalCustomers().filter(c => c.id !== customerId);
      this._setLocalCustomers(customers);
      return { error: null };
    }
    const { error } = await supabase
      .from('customers')
      .delete()
      .eq('id', customerId);
    return { error };
  }
};

// Profile Storage
const ProfileStorage = {
  _getLocalProfile(userId) {
    try {
      const profiles = JSON.parse(localStorage.getItem('rh_profiles') || '{}');
      return profiles[userId] || null;
    } catch { return null; }
  },
  _setLocalProfile(userId, profile) {
    const profiles = JSON.parse(localStorage.getItem('rh_profiles') || '{}');
    profiles[userId] = profile;
    localStorage.setItem('rh_profiles', JSON.stringify(profiles));
  },
  
  async loadProfile(userId) {
    if(!supabase) {
      const profile = this._getLocalProfile(userId);
      return { data: profile, error: null };
    }
    const { data, error } = await supabase
      .from('user_profiles')
      .select('*')
      .eq('user_id', userId)
      .single();
    return { data, error };
  },
  
  async saveProfile(userId, profileData) {
    if(!supabase) {
      const now = new Date().toISOString();
      const profile = {
        user_id: userId,
        first_name: profileData.first_name || '',
        last_name: profileData.last_name || '',
        phone: profileData.phone || '',
        job_title: profileData.job_title || '',
        timezone: profileData.timezone || 'America/New_York',
        notifications_enabled: profileData.notifications_enabled !== false,
        updated_at: now
      };
      this._setLocalProfile(userId, profile);
      return { data: profile, error: null };
    }
    const { data, error } = await supabase
      .from('user_profiles')
      .upsert({
        user_id: userId,
        first_name: profileData.first_name,
        last_name: profileData.last_name,
        phone: profileData.phone,
        job_title: profileData.job_title,
        timezone: profileData.timezone,
        notifications_enabled: profileData.notifications_enabled,
        updated_at: new Date().toISOString()
      }, { onConflict: 'user_id' })
      .select()
      .single();
    return { data, error };
  }
};

// Formula Engine
const FormulaEngine={
  parser:null,
  init(){
    if(typeof exprEval!=='undefined'){
      this.parser=new exprEval.Parser();
      this.parser.functions.LOOKUP=this.LOOKUP;
      this.parser.functions.IF=(c,t,f)=>c?t:f;
      this.parser.functions.ROUND=(n,d=0)=>Math.round(n*Math.pow(10,d))/Math.pow(10,d);
      this.parser.functions.MIN=Math.min;
      this.parser.functions.MAX=Math.max;
      this.parser.functions.LOOKUP=this.LOOKUP.bind(this);
    }
  },
  LOOKUP(key,...pairs){
    for(let i=0;i<pairs.length-1;i+=2){if(key===pairs[i])return pairs[i+1]}
    return pairs.length%2===1?pairs[pairs.length-1]:0;
  },
  evaluate(formula,variables,varTables){
    if(!formula||!this.parser)return 0;
    try{
      const scope={...variables};
      const expr=this.parser.parse(formula);
      return expr.evaluate(scope);
    }catch(e){return 0}
  },
  validate(formula){
    if(!formula||!this.parser)return{valid:true};
    try{this.parser.parse(formula);return{valid:true}}catch(e){return{valid:false,error:e.message}}
  }
};
FormulaEngine.init();

// Default Data
const DEFAULT_ROLES={
  AT:{name:"Accounting Tech",cost_rate:12.60,color:"#00B894"},
  AC:{name:"Accountant",cost_rate:14.70,color:"#0984E3"},
  SA:{name:"Sr. Accountant",cost_rate:15.75,color:"#6C5CE7"},
  CO:{name:"Consultant",cost_rate:46.75,color:"#FDCB6E"},
  MA:{name:"Manager",cost_rate:66.00,color:"#C41E3A"}
};

const DEFAULT_SECTIONS={
  ap:{key:"ap",name:"A/P",color:"#C41E3A"},
  ar:{key:"ar",name:"A/R",color:"#0984E3"},
  cm:{key:"cm",name:"Cash Management",color:"#00B894"},
  fa:{key:"fa",name:"Fixed Assets",color:"#6C5CE7"},
  pr:{key:"pr",name:"Payroll",color:"#FDCB6E"},
  jc:{key:"jc",name:"Job Cost",color:"#E17055"},
  gl:{key:"gl",name:"General Ledger",color:"#636E72"},
  tx:{key:"tx",name:"Tax",color:"#2D3436"},
  me:{key:"me",name:"Month-End",color:"#A29BFE"},
  fr:{key:"fr",name:"Financial Reporting",color:"#74B9FF"},
  ye:{key:"ye",name:"Year-End",color:"#FD79A8"},
  oh:{key:"oh",name:"Overhead",color:"#802629"}
};

const DEFAULT_TASKS=[
  // ============================================
  // MODULE 1: ACCOUNTS PAYABLE (9 tasks)
  // ============================================
  {key:"ap_invoice_entry",section:"ap",name:"AP Invoice Entry",levels:{1:true,2:true,3:true},
    variables:[{key:"invoices",label:"Invoices/month",type:"number",default:150}],
    lookupType:"software",
    lookupTable:{key:"minutes_per_invoice",label:"Minutes per Invoice",rows:{"Computer Ease":{AT:5,AC:0,SA:0,CO:0,MA:0},"Foundation":{AT:5,AC:0,SA:0,CO:0,MA:0},"Quickbooks Desktop":{AT:5,AC:0,SA:0,CO:0,MA:0},"Quickbooks Online":{AT:5,AC:0,SA:0,CO:0,MA:0},"Sage 100 (Master Builder)":{AT:5,AC:0,SA:0,CO:0,MA:0},"Sage 300 (Timberline)":{AT:5,AC:0,SA:0,CO:0,MA:0},"Viewpoint":{AT:5,AC:0,SA:0,CO:0,MA:0},"Vista":{AT:5,AC:0,SA:0,CO:0,MA:0},"Other":{AT:5,AC:0,SA:0,CO:0,MA:0}}},
    formula:"invoices * minutes_per_invoice / 60",
    hammerTimeMapping:{AT:"AP.015",AC:"AP.015",SA:"AP.015",CO:"AP.015",MA:"AP.015"}},
  
  {key:"ap_approvals",section:"ap",name:"AP Approvals",levels:{1:true,2:true,3:true},
    variables:[{key:"invoices",label:"Invoices",type:"number",default:150},{key:"use_ap_automation",label:"Use AP Automation",type:"enum",options:["Yes","No"],default:"Yes"}],
    lookupType:"ap_automation",
    lookupTable:{key:"minutes_per_invoice",label:"Minutes per Invoice",rows:{"Yes":{AT:0,AC:0,SA:0,CO:0.5,MA:0},"No":{AT:0,AC:0,SA:0,CO:0,MA:0}}},
    formula:"invoices * minutes_per_invoice / 60",
    hammerTimeMapping:{AT:"AP.075",AC:"AP.075",SA:"AP.075",CO:"AP.075",MA:"AP.075"}},
  
  {key:"ap_credit_card",section:"ap",name:"Credit Card Entry",levels:{1:true,2:true,3:true},
    variables:[{key:"txns",label:"CC Transactions/month",type:"number",default:500}],
    lookupType:"software",
    lookupTable:{key:"minutes_per_txn",label:"Minutes per Transaction",rows:{"Computer Ease":{AT:0.5,AC:0,SA:0,CO:0,MA:0},"Foundation":{AT:2,AC:0,SA:0,CO:0,MA:0},"Quickbooks Desktop":{AT:0.5,AC:0,SA:0,CO:0,MA:0},"Quickbooks Online":{AT:0.5,AC:0,SA:0,CO:0,MA:0},"Sage 100 (Master Builder)":{AT:0.5,AC:0,SA:0,CO:0,MA:0},"Sage 300 (Timberline)":{AT:0.5,AC:0,SA:0,CO:0,MA:0},"Viewpoint":{AT:0.5,AC:0,SA:0,CO:0,MA:0},"Vista":{AT:0.5,AC:0,SA:0,CO:0,MA:0},"Other":{AT:0.5,AC:0,SA:0,CO:0,MA:0}}},
    formula:"txns * minutes_per_txn / 60",
    hammerTimeMapping:{AT:"AP.015",AC:"AP.015",SA:"AP.015",CO:"AP.015",MA:"AP.015"}},
  
  {key:"ap_recording_payments",section:"ap",name:"Recording Invoice Payments",levels:{1:true,2:true,3:true},
    variables:[{key:"payments",label:"Payments/month",type:"number",default:100},{key:"approval_required",label:"Approval Required",type:"enum",options:["Yes","No"],default:"Yes"},{key:"approval_type",label:"Approval Type",type:"enum",options:["Manual","Automated"],default:"Automated"},{key:"invoice_capture",label:"Use TimberScan/Bill.com",type:"enum",options:["Yes","No"],default:"No"},{key:"po_system",label:"PO System Utilized",type:"enum",options:["Yes","No"],default:"No"}],
    lookupType:"software",
    lookupTable:{key:"minutes_per_payment",label:"Minutes per Payment",rows:{"Computer Ease":{AT:5,AC:0,SA:0,CO:0,MA:0},"Foundation":{AT:5,AC:0,SA:0,CO:0,MA:0},"Quickbooks Desktop":{AT:5,AC:0,SA:0,CO:0,MA:0},"Quickbooks Online":{AT:5,AC:0,SA:0,CO:0,MA:0},"Sage 100 (Master Builder)":{AT:5,AC:0,SA:0,CO:0,MA:0},"Sage 300 (Timberline)":{AT:5,AC:0,SA:0,CO:0,MA:0},"Viewpoint":{AT:5,AC:0,SA:0,CO:0,MA:0},"Vista":{AT:5,AC:0,SA:0,CO:0,MA:0},"Other":{AT:5,AC:0,SA:0,CO:0,MA:0}}},
    formula:"payments * minutes_per_payment * LOOKUP(approval_required, \"Yes\", 1.2, \"No\", 1, 1) * LOOKUP(approval_type, \"Manual\", 1.2, \"Automated\", 1, 1) * LOOKUP(invoice_capture, \"Yes\", 0.5, \"No\", 1, 1) * LOOKUP(po_system, \"Yes\", 0.8, \"No\", 1, 1) / 60",
    hammerTimeMapping:{AT:"AP.016",AC:"AP.016",SA:"AP.016",CO:"AP.016",MA:"AP.016"}},
  
  {key:"ap_po_matching",section:"ap",name:"PO Matching",levels:{1:true,2:true,3:true},
    variables:[{key:"pos",label:"POs/month",type:"number",default:50}],
    lookupType:"software",
    lookupTable:{key:"minutes_per_po",label:"Minutes per PO",rows:{"Computer Ease":{AT:4,AC:0,SA:0,CO:0,MA:0},"Foundation":{AT:4,AC:0,SA:0,CO:0,MA:0},"Quickbooks Desktop":{AT:4,AC:0,SA:0,CO:0,MA:0},"Quickbooks Online":{AT:4,AC:0,SA:0,CO:0,MA:0},"Sage 100 (Master Builder)":{AT:4,AC:0,SA:0,CO:0,MA:0},"Sage 300 (Timberline)":{AT:4,AC:0,SA:0,CO:0,MA:0},"Viewpoint":{AT:4,AC:0,SA:0,CO:0,MA:0},"Vista":{AT:4,AC:0,SA:0,CO:0,MA:0},"Other":{AT:4,AC:0,SA:0,CO:0,MA:0}}},
    formula:"pos * minutes_per_po / 60",
    hammerTimeMapping:{AT:"AP.060",AC:"AP.060",SA:"AP.060",CO:"AP.060",MA:"AP.060"}},
  
  {key:"ap_vendor_statement",section:"ap",name:"Vendor Statement Reconciliation",levels:{1:true,2:true,3:true},
    variables:[{key:"vendors",label:"Vendors",type:"number",default:30}],
    lookupType:"role",
    lookupTable:{key:"minutes_per_vendor",label:"Minutes per Vendor",rows:{AT:20,AC:0,SA:0,CO:0,MA:0}},
    formula:"vendors * minutes_per_vendor / 60",
    hammerTimeMapping:{AT:"AP.130",AC:"AP.130",SA:"AP.130",CO:"AP.130",MA:"AP.130"}},
  
  {key:"ap_sub_compliance",section:"ap",name:"Subcontractor Compliance",levels:{1:true,2:true,3:true},
    variables:[{key:"subs",label:"Subcontractors",type:"number",default:50},{key:"method",label:"Method",type:"enum",options:["Software","Manual"],default:"Software"}],
    lookupType:"method",
    lookupTable:{key:"minutes_per_sub",label:"Minutes per Subcontractor",rows:{"Software":{AT:0,AC:0,SA:0,CO:10,MA:0},"Manual":{AT:0,AC:0,SA:0,CO:20,MA:0}}},
    formula:"subs * minutes_per_sub / 60",
    hammerTimeMapping:{AT:"AP.100",AC:"AP.100",SA:"AP.100",CO:"AP.100",MA:"AP.100"}},
  
  {key:"ap_vendor_maintenance",section:"ap",name:"Create/Maintain Vendors",levels:{1:true,2:true,3:true},
    variables:[{key:"new_vendors",label:"New Vendors/year",type:"number",default:24}],
    lookupType:"role",
    lookupTable:{key:"minutes_per_vendor",label:"Minutes per Vendor",rows:{AT:20,AC:0,SA:0,CO:0,MA:0}},
    formula:"new_vendors * minutes_per_vendor / 60 / 12",
    hammerTimeMapping:{AT:"AP.010",AC:"AP.010",SA:"AP.010",CO:"AP.010",MA:"AP.010"}},
  
  {key:"ap_aging_review",section:"ap",name:"AP Aging Review Meeting",levels:{1:true,2:true,3:true},
    variables:[{key:"freq",label:"Frequency",type:"enum",options:["Weekly","Monthly"],default:"Monthly"}],
    lookupType:"frequency",
    lookupTable:{key:"hours_per_period",label:"Hours per Period",rows:{"Weekly":{AT:8,AC:0,SA:0,CO:8,MA:2},"Monthly":{AT:2,AC:0,SA:0,CO:2,MA:0.5}}},
    formula:"hours_per_period",
    hammerTimeMapping:{AT:"AP.150",AC:"AP.150",SA:"AP.150",CO:"AP.150",MA:"AP.150"}},

  // ============================================
  // MODULE 2: ACCOUNTS RECEIVABLE (5 tasks)
  // ============================================
  {key:"ar_create_invoices",section:"ar",name:"Create Invoices",levels:{1:true,2:true,3:true},
    variables:[{key:"invoices",label:"Invoices/month",type:"number",default:100}],
    lookupType:"software",
    lookupTable:{key:"minutes_per_invoice",label:"Minutes per Invoice",rows:{"Computer Ease":{AT:10,AC:0,SA:0,CO:0,MA:0},"Foundation":{AT:10,AC:0,SA:0,CO:0,MA:0},"Quickbooks Desktop":{AT:10,AC:0,SA:0,CO:0,MA:0},"Quickbooks Online":{AT:10,AC:0,SA:0,CO:0,MA:0},"Sage 100 (Master Builder)":{AT:10,AC:0,SA:0,CO:0,MA:0},"Sage 300 (Timberline)":{AT:10,AC:0,SA:0,CO:0,MA:0},"Viewpoint":{AT:10,AC:0,SA:0,CO:0,MA:0},"Vista":{AT:10,AC:0,SA:0,CO:0,MA:0},"Other":{AT:10,AC:0,SA:0,CO:0,MA:0}}},
    formula:"invoices * minutes_per_invoice / 60",
    hammerTimeMapping:{AT:"AR.015",AC:"AR.015",SA:"AR.015",CO:"AR.015",MA:"AR.015"}},
  
  {key:"ar_customer_payments",section:"ar",name:"Record Customer Payments",levels:{1:true,2:true,3:true},
    variables:[{key:"payments",label:"Payments/month",type:"number",default:80},{key:"invoice_reference",label:"Remittances Reference Invoice",type:"enum",options:["Yes","No"],default:"Yes"}],
    lookupType:"software",
    lookupTable:{key:"minutes_per_payment",label:"Minutes per Payment",rows:{"Computer Ease":{AT:5,AC:0,SA:0,CO:0,MA:0},"Foundation":{AT:5,AC:0,SA:0,CO:0,MA:0},"Quickbooks Desktop":{AT:5,AC:0,SA:0,CO:0,MA:0},"Quickbooks Online":{AT:5,AC:0,SA:0,CO:0,MA:0},"Sage 100 (Master Builder)":{AT:5,AC:0,SA:0,CO:0,MA:0},"Sage 300 (Timberline)":{AT:5,AC:0,SA:0,CO:0,MA:0},"Viewpoint":{AT:5,AC:0,SA:0,CO:0,MA:0},"Vista":{AT:5,AC:0,SA:0,CO:0,MA:0},"Other":{AT:5,AC:0,SA:0,CO:0,MA:0}}},
    formula:"payments * minutes_per_payment * LOOKUP(invoice_reference, \"Yes\", 1, \"No\", 1.5, 1) / 60",
    hammerTimeMapping:{AT:"AR.045",AC:"AR.045",SA:"AR.045",CO:"AR.045",MA:"AR.045"}},
  
  {key:"ar_customer_deposits",section:"ar",name:"Record Customer Deposits",levels:{1:true,2:true,3:true},
    variables:[{key:"deposits",label:"Deposits/month",type:"number",default:20}],
    lookupType:"software",
    lookupTable:{key:"minutes_per_deposit",label:"Minutes per Deposit",rows:{"Computer Ease":{AT:2,AC:0,SA:0,CO:0,MA:0},"Foundation":{AT:2,AC:0,SA:0,CO:0,MA:0},"Quickbooks Desktop":{AT:2,AC:0,SA:0,CO:0,MA:0},"Quickbooks Online":{AT:2,AC:0,SA:0,CO:0,MA:0},"Sage 100 (Master Builder)":{AT:2,AC:0,SA:0,CO:0,MA:0},"Sage 300 (Timberline)":{AT:2,AC:0,SA:0,CO:0,MA:0},"Viewpoint":{AT:2,AC:0,SA:0,CO:0,MA:0},"Vista":{AT:2,AC:0,SA:0,CO:0,MA:0},"Other":{AT:2,AC:0,SA:0,CO:0,MA:0}}},
    formula:"deposits * minutes_per_deposit / 60",
    hammerTimeMapping:{AT:"AR.045",AC:"AR.045",SA:"AR.045",CO:"AR.045",MA:"AR.045"}},
  
  {key:"ar_new_customers",section:"ar",name:"Set Up New Customers",levels:{1:true,2:true,3:true},
    variables:[{key:"new_customers",label:"New Customers/month",type:"number",default:5}],
    lookupType:"software",
    lookupTable:{key:"minutes_per_customer",label:"Minutes per Customer",rows:{"Computer Ease":{AT:10,AC:0,SA:0,CO:0,MA:0},"Foundation":{AT:10,AC:0,SA:0,CO:0,MA:0},"Quickbooks Desktop":{AT:10,AC:0,SA:0,CO:0,MA:0},"Quickbooks Online":{AT:10,AC:0,SA:0,CO:0,MA:0},"Sage 100 (Master Builder)":{AT:10,AC:0,SA:0,CO:0,MA:0},"Sage 300 (Timberline)":{AT:10,AC:0,SA:0,CO:0,MA:0},"Viewpoint":{AT:10,AC:0,SA:0,CO:0,MA:0},"Vista":{AT:10,AC:0,SA:0,CO:0,MA:0},"Other":{AT:10,AC:0,SA:0,CO:0,MA:0}}},
    formula:"new_customers * minutes_per_customer / 60",
    hammerTimeMapping:{AT:"AR.080",AC:"AR.080",SA:"AR.080",CO:"AR.080",MA:"AR.080"}},
  
  {key:"ar_aging_review",section:"ar",name:"AR Aging Review Meeting",levels:{1:true,2:true,3:true},
    variables:[{key:"freq",label:"Frequency",type:"enum",options:["Weekly","Monthly"],default:"Monthly"}],
    lookupType:"frequency",
    lookupTable:{key:"hours_per_period",label:"Hours per Period",rows:{"Weekly":{AT:8,AC:0,SA:0,CO:8,MA:2},"Monthly":{AT:2,AC:0,SA:0,CO:2,MA:0.5}}},
    formula:"hours_per_period",
    hammerTimeMapping:{AT:"AR.090",AC:"AR.090",SA:"AR.090",CO:"AR.090",MA:"AR.090"}},

  // ============================================
  // MODULE 3: CASH MANAGEMENT (9 tasks)
  // ============================================
  {key:"cm_bank_recon",section:"cm",name:"Reconcile Bank Accounts",levels:{1:true,2:true,3:true},
    variables:[{key:"accounts",label:"Bank Accounts",type:"number",default:3},{key:"online_access",label:"Online Access",type:"enum",options:["Yes","No"],default:"Yes"}],
    lookupType:"online_access",
    lookupTable:{key:"minutes_per_account",label:"Minutes per Account",rows:{"Yes":{AT:150,AC:0,SA:0,CO:30,MA:0},"No":{AT:120,AC:0,SA:0,CO:0,MA:0}}},
    formula:"accounts * minutes_per_account / 60",
    hammerTimeMapping:{AT:"CM.085",AC:"CM.085",SA:"CM.085",CO:"CM.100",MA:"CM.100"}},
  
  {key:"cm_cc_recon",section:"cm",name:"Reconcile Credit Cards",levels:{1:true,2:true,3:true},
    variables:[{key:"cards",label:"Credit Cards",type:"number",default:2},{key:"online_access",label:"Online Access",type:"enum",options:["Yes","No"],default:"Yes"}],
    lookupType:"online_access",
    lookupTable:{key:"minutes_per_card",label:"Minutes per Card",rows:{"Yes":{AT:150,AC:0,SA:0,CO:30,MA:0},"No":{AT:120,AC:0,SA:0,CO:45,MA:0}}},
    formula:"cards * minutes_per_card / 60",
    hammerTimeMapping:{AT:"CM.085",AC:"CM.085",SA:"CM.085",CO:"CM.100",MA:"CM.100"}},
  
  {key:"cm_loan_recon",section:"cm",name:"Reconcile Loans",levels:{1:true,2:true,3:true},
    variables:[{key:"loans",label:"Loans",type:"number",default:1},{key:"online_access",label:"Online Access",type:"enum",options:["Yes","No"],default:"Yes"}],
    lookupType:"online_access",
    lookupTable:{key:"minutes_per_loan",label:"Minutes per Loan",rows:{"Yes":{AT:0,AC:30,SA:0,CO:0,MA:0},"No":{AT:0,AC:30,SA:0,CO:10,MA:0}}},
    formula:"loans * minutes_per_loan / 60",
    hammerTimeMapping:{AT:"LN.030",AC:"LN.030",SA:"LN.030",CO:"LN.010",MA:"LN.010"}},
  
  {key:"cm_investment_recon",section:"cm",name:"Reconcile Investments",levels:{1:true,2:true,3:true},
    variables:[{key:"investments",label:"Investment Accounts",type:"number",default:0},{key:"online_access",label:"Online Access",type:"enum",options:["Yes","No"],default:"Yes"}],
    lookupType:"online_access",
    lookupTable:{key:"minutes_per_inv",label:"Minutes per Account",rows:{"Yes":{AT:0,AC:120,SA:0,CO:30,MA:0},"No":{AT:0,AC:150,SA:0,CO:45,MA:0}}},
    formula:"investments * minutes_per_inv / 60",
    hammerTimeMapping:{AT:"CM.065",AC:"CM.065",SA:"CM.065",CO:"CM.100",MA:"CM.100"}},
  
  {key:"cm_new_bank",section:"cm",name:"Set Up New Bank Account",levels:{1:true,2:true,3:true},
    variables:[{key:"new_accounts",label:"New Accounts/year",type:"number",default:1}],
    lookupType:"role",
    lookupTable:{key:"minutes_per_account",label:"Minutes per Account",rows:{AT:0,AC:0,SA:0,CO:20,MA:0}},
    formula:"new_accounts * minutes_per_account / 60 / 12",
    hammerTimeMapping:{AT:"CM.065",AC:"CM.065",SA:"CM.065",CO:"CM.065",MA:"CM.065"}},
  
  {key:"cm_new_cc",section:"cm",name:"Set Up New Credit Card",levels:{1:true,2:true,3:true},
    variables:[{key:"new_cards",label:"New Cards/year",type:"number",default:1}],
    lookupType:"role",
    lookupTable:{key:"minutes_per_card",label:"Minutes per Card",rows:{AT:0,AC:0,SA:0,CO:20,MA:0}},
    formula:"new_cards * minutes_per_card / 60 / 12",
    hammerTimeMapping:{AT:"CM.065",AC:"CM.065",SA:"CM.065",CO:"CM.065",MA:"CM.065"}},
  
  {key:"cm_new_investment",section:"cm",name:"Set Up New Investment Account",levels:{1:true,2:true,3:true},
    variables:[{key:"new_investments",label:"New Accounts/year",type:"number",default:0}],
    lookupType:"role",
    lookupTable:{key:"minutes_per_account",label:"Minutes per Account",rows:{AT:0,AC:0,SA:0,CO:20,MA:0}},
    formula:"new_investments * minutes_per_account / 60 / 12",
    hammerTimeMapping:{AT:"CM.065",AC:"CM.065",SA:"CM.065",CO:"CM.065",MA:"CM.065"}},
  
  {key:"cm_new_loan",section:"cm",name:"Set Up New Loans",levels:{1:true,2:true,3:true},
    variables:[{key:"new_loans",label:"New Loans/year",type:"number",default:0}],
    lookupType:"role",
    lookupTable:{key:"minutes_per_loan",label:"Minutes per Loan",rows:{AT:0,AC:0,SA:0,CO:20,MA:0}},
    formula:"new_loans * minutes_per_loan / 60 / 12",
    hammerTimeMapping:{AT:"LN.020",AC:"LN.020",SA:"LN.020",CO:"LN.020",MA:"LN.020"}},
  
  {key:"cm_forecast",section:"cm",name:"Cash Forecasting",levels:{1:true,2:true,3:true},
    variables:[{key:"freq",label:"Frequency",type:"enum",options:["Weekly","Monthly"],default:"Monthly"}],
    lookupType:"frequency",
    lookupTable:{key:"hours_per_period",label:"Hours per Period",rows:{"Weekly":{AT:0,AC:0,SA:0,CO:4,MA:0},"Monthly":{AT:0,AC:0,SA:0,CO:1,MA:0}}},
    formula:"hours_per_period",
    hammerTimeMapping:{AT:"CM.040",AC:"CM.040",SA:"CM.040",CO:"CM.040",MA:"CM.040"}},

  // ============================================
  // MODULE 4: FIXED ASSETS (2 tasks)
  // ============================================
  {key:"fa_depreciation",section:"fa",name:"Calculate & Record Depreciation",levels:{1:true,2:true,3:true},
    variables:[{key:"assets",label:"Fixed Assets",type:"number",default:20}],
    lookupType:"role",
    lookupTable:{key:"minutes_per_asset",label:"Minutes per Asset",rows:{AT:0,AC:5,SA:0,CO:0,MA:0}},
    formula:"assets * minutes_per_asset / 60",
    hammerTimeMapping:{AT:"FA.030",AC:"FA.030",SA:"FA.030",CO:"FA.010",MA:"FA.030"}},
  
  {key:"fa_new_assets",section:"fa",name:"Set Up New Fixed Assets/Dispose",levels:{1:true,2:true,3:true},
    variables:[{key:"new_assets",label:"New Assets/year",type:"number",default:5}],
    lookupType:"role",
    lookupTable:{key:"minutes_per_asset",label:"Minutes per Asset",rows:{AT:0,AC:60,SA:0,CO:0,MA:0}},
    formula:"new_assets * minutes_per_asset / 60 / 12",
    hammerTimeMapping:{AT:"FA.020",AC:"FA.020",SA:"FA.020",CO:"FA.010",MA:"FA.020"}},

  // ============================================
  // MODULE 5: PAYROLL (12 tasks)
  // ============================================
  {key:"pr_time_entry",section:"pr",name:"Payroll Time Entry",levels:{1:true,2:true,3:true},
    variables:[{key:"timekeeping_software",label:"Use Timekeeping Software",type:"enum",options:["Yes","No"],default:"Yes"}],
    lookupType:"software",
    lookupTable:{key:"minutes_per_employee",label:"Minutes per Employee",rows:{"Computer Ease":{AT:4,AC:0,SA:0,CO:0.8,MA:0},"Foundation":{AT:4,AC:0,SA:0,CO:0.8,MA:0},"Quickbooks Desktop":{AT:4,AC:0,SA:0,CO:0.8,MA:0},"Quickbooks Online":{AT:4,AC:0,SA:0,CO:0.8,MA:0},"Sage 100 (Master Builder)":{AT:4,AC:0,SA:0,CO:0.8,MA:0},"Sage 300 (Timberline)":{AT:4,AC:0,SA:0,CO:0.8,MA:0},"Viewpoint":{AT:4,AC:0,SA:0,CO:0.8,MA:0},"Vista":{AT:4,AC:0,SA:0,CO:0.8,MA:0},"Other":{AT:4,AC:0,SA:0,CO:0.8,MA:0}}},
    formula:"employees * minutes_per_employee * LOOKUP(timekeeping_software, \"Yes\", 1, \"No\", 1.5, 1) * payroll_freq_mult / 60",
    hammerTimeMapping:{AT:"PR.035",AC:"PR.035",SA:"PR.035",CO:"PR.035",MA:"PR.035"}},
  
  {key:"pr_processing",section:"pr",name:"Process Payroll",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"software",
    lookupTable:{key:"minutes_per_employee",label:"Minutes per Employee",rows:{"Computer Ease":{AT:4,AC:0,SA:0,CO:0.8,MA:0},"Foundation":{AT:4,AC:0,SA:0,CO:0.8,MA:0},"Quickbooks Desktop":{AT:4,AC:0,SA:0,CO:0.8,MA:0},"Quickbooks Online":{AT:4,AC:0,SA:0,CO:0.8,MA:0},"Sage 100 (Master Builder)":{AT:4,AC:0,SA:0,CO:0.8,MA:0},"Sage 300 (Timberline)":{AT:4,AC:0,SA:0,CO:0.8,MA:0},"Viewpoint":{AT:4,AC:0,SA:0,CO:0.8,MA:0},"Vista":{AT:4,AC:0,SA:0,CO:0.8,MA:0},"Other":{AT:4,AC:0,SA:0,CO:0.8,MA:0}}},
    formula:"employees * minutes_per_employee * payroll_freq_mult / 60",
    hammerTimeMapping:{AT:"PR.035",AC:"PR.035",SA:"PR.035",CO:"PR.035",MA:"PR.035"}},
  
  {key:"pr_tax_filings",section:"pr",name:"Payroll Tax Filings & Deposits",levels:{1:true,2:true,3:true},
    variables:[{key:"payroll_states",label:"No. of Payroll States",type:"number",default:1}],
    lookupType:"role",
    lookupTable:{key:"minutes_per_state",label:"Minutes per State",rows:{AT:0,AC:0,SA:0,CO:60,MA:0}},
    formula:"payroll_states * minutes_per_state / 60",
    hammerTimeMapping:{AT:"PR.085",AC:"PR.085",SA:"PR.085",CO:"PR.085",MA:"PR.085"}},
  
  {key:"pr_journal_entry",section:"pr",name:"Third-Party Payroll Journal Entry",levels:{1:true,2:true,3:true},
    variables:[{key:"integration",label:"Third-Party Integration",type:"enum",options:["Yes","No"],default:"No"}],
    lookupType:"integration",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{"Yes":{AT:0,AC:60,SA:0,CO:0,MA:0},"No":{AT:0,AC:120,SA:0,CO:0,MA:0}}},
    formula:"minutes_per_period * payroll_freq_mult / 60",
    hammerTimeMapping:{AT:"PR.130",AC:"PR.130",SA:"PR.130",CO:"PR.130",MA:"PR.130"}},
  
  {key:"pr_new_employees",section:"pr",name:"Setup New Employees",levels:{1:true,2:true,3:true},
    variables:[{key:"new_employees",label:"New Employees/month",type:"number",default:2}],
    lookupType:"software",
    lookupTable:{key:"minutes_per_employee",label:"Minutes per Employee",rows:{"Computer Ease":{AT:0,AC:0,SA:0,CO:20,MA:0},"Foundation":{AT:0,AC:0,SA:0,CO:20,MA:0},"Quickbooks Desktop":{AT:0,AC:0,SA:0,CO:20,MA:0},"Quickbooks Online":{AT:0,AC:0,SA:0,CO:20,MA:0},"Sage 100 (Master Builder)":{AT:0,AC:0,SA:0,CO:20,MA:0},"Sage 300 (Timberline)":{AT:0,AC:0,SA:0,CO:20,MA:0},"Viewpoint":{AT:0,AC:0,SA:0,CO:20,MA:0},"Vista":{AT:0,AC:0,SA:0,CO:20,MA:0},"Other":{AT:0,AC:0,SA:0,CO:20,MA:0}}},
    formula:"new_employees * minutes_per_employee / 60",
    hammerTimeMapping:{AT:"PR.120",AC:"PR.120",SA:"PR.120",CO:"PR.120",MA:"PR.120"}},
  
  {key:"pr_union_reports",section:"pr",name:"Union Reports",levels:{1:true,2:true,3:true},
    variables:[{key:"unions",label:"Number of Unions",type:"number",default:0}],
    lookupType:"role",
    lookupTable:{key:"minutes_per_union",label:"Minutes per Union",rows:{AT:0,AC:0,SA:0,CO:120,MA:0}},
    formula:"unions * minutes_per_union / 60",
    hammerTimeMapping:{AT:"PR.150",AC:"PR.150",SA:"PR.150",CO:"PR.150",MA:"PR.150"}},
  
  {key:"pr_benefits",section:"pr",name:"Benefits Enrollment",levels:{1:true,2:true,3:true},
    variables:[{key:"new_employees",label:"New Employees/month",type:"number",default:2}],
    lookupType:"role",
    lookupTable:{key:"minutes_per_employee",label:"Minutes per Employee",rows:{AT:0,AC:0,SA:0,CO:60,MA:0}},
    formula:"new_employees * minutes_per_employee / 60",
    hammerTimeMapping:{AT:"PR.020",AC:"PR.020",SA:"PR.020",CO:"PR.020",MA:"PR.020"}},
  
  {key:"pr_tax_recon",section:"pr",name:"Reconcile Payroll Taxes",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{AT:0,AC:240,SA:120,CO:30,MA:0}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"PR.110",AC:"PR.110",SA:"PR.110",CO:"PR.110",MA:"PR.110"}},
  
  {key:"pr_certified",section:"pr",name:"Certified Payroll Reports",levels:{1:true,2:true,3:true},
    variables:[{key:"projects",label:"Certified Projects",type:"number",default:0}],
    lookupType:"role",
    lookupTable:{key:"minutes_per_project",label:"Minutes per Project",rows:{AT:0,AC:0,SA:0,CO:120,MA:30}},
    formula:"projects * minutes_per_project / 60",
    hammerTimeMapping:{AT:"PR.030",AC:"PR.030",SA:"PR.030",CO:"PR.030",MA:"PR.030"}},
  
  {key:"pr_401k",section:"pr",name:"401K Processing",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{AT:0,AC:0,SA:0,CO:60,MA:0}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"PR.010",AC:"PR.010",SA:"PR.010",CO:"PR.010",MA:"PR.010"}},
  
  {key:"pr_garnishments",section:"pr",name:"Garnishments & Other Deductions",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{AT:0,AC:0,SA:0,CO:60,MA:0}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"PR.160",AC:"PR.160",SA:"PR.160",CO:"PR.160",MA:"PR.160"}},
  
  {key:"pr_ocip",section:"pr",name:"OCIP/CCIP Support",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{AT:0,AC:0,SA:0,CO:60,MA:0}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"PR.170",AC:"PR.170",SA:"PR.170",CO:"PR.170",MA:"PR.170"}},

  // ============================================
  // MODULE 6: JOB COST (7 tasks)
  // ============================================
  {key:"jc_estimates",section:"jc",name:"Enter Cost Estimates",levels:{1:true,2:true,3:true},
    variables:[{key:"jobs",label:"Jobs/month",type:"number",default:5}],
    lookupType:"software",
    lookupTable:{key:"minutes_per_job",label:"Minutes per Job",rows:{"Computer Ease":{AT:0,AC:0,SA:0,CO:12,MA:0},"Foundation":{AT:0,AC:0,SA:0,CO:12,MA:0},"Quickbooks Desktop":{AT:0,AC:0,SA:0,CO:12,MA:0},"Quickbooks Online":{AT:0,AC:0,SA:0,CO:12,MA:0},"Sage 100 (Master Builder)":{AT:0,AC:0,SA:0,CO:12,MA:0},"Sage 300 (Timberline)":{AT:0,AC:0,SA:0,CO:12,MA:0},"Viewpoint":{AT:0,AC:0,SA:0,CO:12,MA:0},"Vista":{AT:0,AC:0,SA:0,CO:12,MA:0},"Other":{AT:0,AC:0,SA:0,CO:12,MA:0}}},
    formula:"jobs * minutes_per_job / 60",
    hammerTimeMapping:{AT:"JC.060",AC:"JC.060",SA:"JC.060",CO:"JC.060",MA:"JC.060"}},
  
  {key:"jc_contracts",section:"jc",name:"Enter Contracts & Change Orders",levels:{1:true,2:true,3:true},
    variables:[{key:"jobs",label:"Jobs/month",type:"number",default:5}],
    lookupType:"software",
    lookupTable:{key:"minutes_per_job",label:"Minutes per Job",rows:{"Computer Ease":{AT:0,AC:0,SA:0,CO:12,MA:0},"Foundation":{AT:0,AC:0,SA:0,CO:12,MA:0},"Quickbooks Desktop":{AT:0,AC:0,SA:0,CO:12,MA:0},"Quickbooks Online":{AT:0,AC:0,SA:0,CO:12,MA:0},"Sage 100 (Master Builder)":{AT:0,AC:0,SA:0,CO:12,MA:0},"Sage 300 (Timberline)":{AT:0,AC:0,SA:0,CO:12,MA:0},"Viewpoint":{AT:0,AC:0,SA:0,CO:12,MA:0},"Vista":{AT:0,AC:0,SA:0,CO:12,MA:0},"Other":{AT:0,AC:0,SA:0,CO:12,MA:0}}},
    formula:"jobs * minutes_per_job / 60",
    hammerTimeMapping:{AT:"JC.070",AC:"JC.070",SA:"JC.070",CO:"JC.070",MA:"JC.070"}},
  
  {key:"jc_new_jobs",section:"jc",name:"Setup New Jobs",levels:{1:true,2:true,3:true},
    variables:[{key:"new_jobs",label:"New Jobs/month",type:"number",default:3}],
    lookupType:"software",
    lookupTable:{key:"minutes_per_job",label:"Minutes per Job",rows:{"Computer Ease":{AT:10,AC:0,SA:0,CO:0,MA:0},"Foundation":{AT:10,AC:0,SA:0,CO:0,MA:0},"Quickbooks Desktop":{AT:10,AC:0,SA:0,CO:0,MA:0},"Quickbooks Online":{AT:10,AC:0,SA:0,CO:0,MA:0},"Sage 100 (Master Builder)":{AT:10,AC:0,SA:0,CO:0,MA:0},"Sage 300 (Timberline)":{AT:10,AC:0,SA:0,CO:0,MA:0},"Viewpoint":{AT:10,AC:0,SA:0,CO:0,MA:0},"Vista":{AT:10,AC:0,SA:0,CO:0,MA:0},"Other":{AT:10,AC:0,SA:0,CO:0,MA:0}}},
    formula:"new_jobs * minutes_per_job / 60",
    hammerTimeMapping:{AT:"JC.010",AC:"JC.010",SA:"JC.010",CO:"JC.010",MA:"JC.010"}},
  
  {key:"jc_wip_adjustments",section:"jc",name:"WIP Adjustment Entries",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{AT:0,AC:240,SA:60,CO:60,MA:120}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"JC.100",AC:"JC.100",SA:"JC.100",CO:"JC.120",MA:"JC.120"}},
  
  {key:"jc_indirect_cost",section:"jc",name:"Indirect Cost Allocations",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{AT:0,AC:125,SA:0,CO:0,MA:0}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"JC.090",AC:"JC.090",SA:"JC.090",CO:"JC.090",MA:"JC.090"}},
  
  {key:"jc_reports",section:"jc",name:"Job Cost Reports",levels:{1:true,2:true,3:true},
    variables:[{key:"freq",label:"Frequency",type:"enum",options:["Weekly","Monthly"],default:"Monthly"}],
    lookupType:"frequency",
    lookupTable:{key:"hours_per_period",label:"Hours per Period",rows:{"Weekly":{AT:8,AC:0,SA:0,CO:8,MA:0},"Monthly":{AT:2,AC:0,SA:0,CO:2,MA:0}}},
    formula:"hours_per_period",
    hammerTimeMapping:{AT:"JC.050",AC:"JC.050",SA:"JC.050",CO:"JC.050",MA:"JC.050"}},
  
  {key:"jc_meetings",section:"jc",name:"Job Cost Meetings",levels:{1:true,2:true,3:true},
    variables:[{key:"freq",label:"Frequency",type:"enum",options:["Weekly","Monthly"],default:"Monthly"}],
    lookupType:"frequency",
    lookupTable:{key:"hours_per_period",label:"Hours per Period",rows:{"Weekly":{AT:0,AC:0,SA:0,CO:1,MA:0},"Monthly":{AT:0,AC:0,SA:0,CO:4,MA:0}}},
    formula:"hours_per_period",
    hammerTimeMapping:{AT:"JC.080",AC:"JC.080",SA:"JC.080",CO:"JC.080",MA:"JC.080"}},

  // ============================================
  // MODULE 7: GENERAL LEDGER (5 tasks)
  // ============================================
  {key:"gl_journal_entries",section:"gl",name:"Prepaid/Accrual/Journal Entries",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"software",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{"Computer Ease":{AT:0,AC:60,SA:60,CO:0,MA:30},"Foundation":{AT:0,AC:60,SA:60,CO:0,MA:30},"Quickbooks Desktop":{AT:0,AC:60,SA:60,CO:0,MA:30},"Quickbooks Online":{AT:0,AC:60,SA:60,CO:0,MA:30},"Sage 100 (Master Builder)":{AT:0,AC:60,SA:60,CO:0,MA:30},"Sage 300 (Timberline)":{AT:0,AC:60,SA:60,CO:0,MA:30},"Viewpoint":{AT:0,AC:60,SA:60,CO:0,MA:30},"Vista":{AT:0,AC:60,SA:60,CO:0,MA:30},"Other":{AT:0,AC:60,SA:60,CO:0,MA:30}}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"GL.130",AC:"GL.130",SA:"GL.130",CO:"GL.130",MA:"GL.130"}},
  
  {key:"gl_intercompany",section:"gl",name:"Intercompany Reconciliations",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{AT:0,AC:60,SA:60,CO:60,MA:0}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"GL.090",AC:"GL.090",SA:"GL.090",CO:"GL.090",MA:"GL.090"}},
  
  {key:"gl_inventory",section:"gl",name:"Record Inventory",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{AT:0,AC:60,SA:60,CO:60,MA:0}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"GL.100",AC:"GL.100",SA:"GL.100",CO:"GL.100",MA:"GL.100"}},
  
  {key:"gl_management",section:"gl",name:"General Ledger Management",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{AT:0,AC:120,SA:0,CO:0,MA:0}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"GL.130",AC:"GL.130",SA:"GL.130",CO:"GL.130",MA:"GL.130"}},
  
  {key:"gl_new_accounts",section:"gl",name:"Setup New GL Accounts",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{AT:0,AC:60,SA:0,CO:0,MA:0}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"GL.010",AC:"GL.010",SA:"GL.010",CO:"GL.010",MA:"GL.010"}},

  // ============================================
  // MODULE 8: TAX COMPLIANCE (2 tasks)
  // ============================================
  {key:"tx_use_tax",section:"tx",name:"Calculate and Process Use Tax",levels:{1:true,2:true,3:true},
    variables:[{key:"use_tax_states",label:"No. of Use Tax States",type:"number",default:1}],
    lookupType:"role",
    lookupTable:{key:"minutes_per_state",label:"Minutes per State",rows:{AT:60,AC:0,SA:0,CO:120,MA:0}},
    formula:"use_tax_states * minutes_per_state / 60",
    hammerTimeMapping:{AT:"TX.005",AC:"TX.005",SA:"TX.005",CO:"TX.060",MA:"TX.005"}},
  
  {key:"tx_cpa_coordination",section:"tx",name:"Coordinate with CPA",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{AT:0,AC:120,SA:60,CO:140,MA:60}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"TX.020",AC:"TX.020",SA:"TX.020",CO:"TX.020",MA:"TX.020"}},

  // ============================================
  // MODULE 9: MONTH-END RECONCILIATIONS (11 tasks)
  // ============================================
  {key:"me_recon_ap",section:"me",name:"Reconcile AP to GL",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{AT:0,AC:40,SA:21,CO:0,MA:0}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"AP.150",AC:"AP.150",SA:"AP.150",CO:"FS.032",MA:"FS.032"}},
  
  {key:"me_recon_ar",section:"me",name:"Reconcile AR to GL",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{AT:0,AC:46,SA:24,CO:0,MA:0}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"AR.090",AC:"AR.090",SA:"AR.090",CO:"FS.032",MA:"FS.032"}},
  
  {key:"me_recon_cash",section:"me",name:"Reconcile Cash to GL",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{AT:0,AC:108,SA:58,CO:0,MA:0}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"CM.115",AC:"CM.115",SA:"CM.115",CO:"FS.032",MA:"FS.032"}},
  
  {key:"me_recon_payroll",section:"me",name:"Reconcile Payroll to GL",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{AT:0,AC:130,SA:70,CO:0,MA:0}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"PR.180",AC:"PR.180",SA:"PR.180",CO:"FS.032",MA:"FS.032"}},
  
  {key:"me_recon_jc",section:"me",name:"Reconcile Job Cost to GL",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{AT:0,AC:140,SA:75,CO:0,MA:0}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"JC.130",AC:"JC.130",SA:"JC.130",CO:"FS.032",MA:"FS.032"}},
  
  {key:"me_recon_fa",section:"me",name:"Reconcile Fixed Assets to GL",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{AT:0,AC:58,SA:31,CO:0,MA:0}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"FA.040",AC:"FA.040",SA:"FA.040",CO:"FS.032",MA:"FS.032"}},
  
  {key:"me_recon_prepaid",section:"me",name:"Reconcile Prepaid",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{AT:0,AC:76,SA:41,CO:0,MA:0}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"GL.130",AC:"GL.130",SA:"GL.130",CO:"FS.032",MA:"FS.032"}},
  
  {key:"me_recon_prepaid_gl",section:"me",name:"Reconcile Prepaid Entries to GL",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{AT:0,AC:64,SA:34,CO:0,MA:0}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"GL.130",AC:"GL.130",SA:"GL.130",CO:"FS.032",MA:"FS.032"}},
  
  {key:"me_recon_taxes",section:"me",name:"Reconcile Taxes to GL",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{AT:0,AC:47,SA:25,CO:0,MA:0}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"TX.090",AC:"TX.090",SA:"TX.090",CO:"FS.032",MA:"FS.032"}},
  
  {key:"me_recon_other",section:"me",name:"Reconcile Other BS Accounts to GL",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{AT:0,AC:83,SA:45,CO:0,MA:0}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"GL.110",AC:"GL.110",SA:"GL.110",CO:"FS.032",MA:"FS.032"}},
  
  {key:"me_close",section:"me",name:"Close Month",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{AT:0,AC:0,SA:0,CO:30,MA:0}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"FS.032",AC:"FS.032",SA:"FS.032",CO:"FS.032",MA:"FS.032"}},

  // ============================================
  // MODULE 10: FINANCIAL REPORTING (3 tasks)
  // ============================================
  {key:"fr_reports",section:"fr",name:"Generate & Review Financial Reports",levels:{1:true,2:true,3:true},
    variables:[{key:"freq",label:"Frequency",type:"enum",options:["Monthly","Quarterly"],default:"Monthly"}],
    lookupType:"frequency",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{"Monthly":{AT:0,AC:240,SA:60,CO:60,MA:60},"Quarterly":{AT:0,AC:80,SA:20,CO:20,MA:20}}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"FS.065",AC:"FS.065",SA:"FS.065",CO:"FS.065",MA:"FS.065"}},
  
  {key:"fr_wip",section:"fr",name:"Generate WIP",levels:{1:true,2:true,3:true},
    variables:[{key:"freq",label:"Frequency",type:"enum",options:["Monthly","Quarterly"],default:"Monthly"}],
    lookupType:"frequency",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{"Monthly":{AT:0,AC:240,SA:60,CO:60,MA:60},"Quarterly":{AT:0,AC:80,SA:20,CO:20,MA:20}}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"JC.115",AC:"JC.115",SA:"JC.115",CO:"JC.115",MA:"JC.115"}},
  
  {key:"fr_budget",section:"fr",name:"Quarterly Budget Updates",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{AT:0,AC:0,SA:0,CO:120,MA:0}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"FS.100",AC:"FS.100",SA:"FS.100",CO:"FS.100",MA:"FS.100"}},

  // ============================================
  // MODULE 11: YEAR-END (3 tasks)
  // ============================================
  {key:"ye_1099s",section:"ye",name:"Generate 1099s",levels:{1:true,2:true,3:true},
    variables:[{key:"vendors_1099",label:"1099 Vendors",type:"number",default:20},{key:"vendors_flagged",label:"Vendors Flagged in System",type:"enum",options:["Yes","No"],default:"Yes"}],
    lookupType:"flagged",
    lookupTable:{key:"hours_per_vendor",label:"Hours per Vendor",rows:{"Yes":{AT:0,AC:0,SA:0,CO:0,MA:0},"No":{AT:0,AC:5,SA:0,CO:0,MA:0}}},
    formula:"vendors_1099 * hours_per_vendor / 12",
    hammerTimeMapping:{AT:"YE.040",AC:"YE.040",SA:"YE.040",CO:"YE.040",MA:"YE.040"}},
  
  {key:"ye_w2s",section:"ye",name:"Generate W-2s",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"software",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{"Computer Ease":{AT:0,AC:0,SA:0,CO:15,MA:0},"Foundation":{AT:0,AC:0,SA:0,CO:15,MA:0},"Quickbooks Desktop":{AT:0,AC:0,SA:0,CO:15,MA:0},"Quickbooks Online":{AT:0,AC:0,SA:0,CO:15,MA:0},"Sage 100 (Master Builder)":{AT:0,AC:0,SA:0,CO:15,MA:0},"Sage 300 (Timberline)":{AT:0,AC:0,SA:0,CO:15,MA:0},"Viewpoint":{AT:0,AC:0,SA:0,CO:15,MA:0},"Vista":{AT:0,AC:0,SA:0,CO:15,MA:0},"Other":{AT:0,AC:0,SA:0,CO:15,MA:0}}},
    formula:"minutes_per_period * payroll_freq_mult / 60",
    hammerTimeMapping:{AT:"YE.050",AC:"YE.050",SA:"YE.050",CO:"YE.050",MA:"YE.050"}},
  
  {key:"ye_close",section:"ye",name:"Year-End Close",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_period",label:"Minutes per Period",rows:{AT:0,AC:20,SA:20,CO:10,MA:10}},
    formula:"minutes_per_period / 60",
    hammerTimeMapping:{AT:"YE.060",AC:"YE.060",SA:"YE.060",CO:"YE.030",MA:"YE.030"}},

  // ============================================
  // MODULE 12: OVERHEAD (7 tasks)
  // ============================================
  {key:"oh_weekly_status",section:"oh",name:"Weekly Status Calls",levels:{1:true,2:true,3:true},
    variables:[{key:"calls_per_month",label:"Calls/month",type:"number",default:4}],
    lookupType:"role",
    lookupTable:{key:"minutes_per_call",label:"Minutes per Call",rows:{AT:0,AC:15,SA:30,CO:30,MA:15}},
    formula:"calls_per_month * minutes_per_call / 60",
    hammerTimeMapping:{AT:"OH.010",AC:"OH.010",SA:"OH.010",CO:"OH.010",MA:"OH.010"}},
  
  {key:"oh_email_comm",section:"oh",name:"Email/Slack Communication",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_month",label:"Minutes per Month",rows:{AT:60,AC:30,SA:60,CO:120,MA:30}},
    formula:"minutes_per_month / 60",
    hammerTimeMapping:{AT:"OH.020",AC:"OH.020",SA:"OH.020",CO:"OH.020",MA:"OH.020"}},
  
  {key:"oh_internal_coord",section:"oh",name:"Internal Team Coordination",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_month",label:"Minutes per Month",rows:{AT:30,AC:30,SA:60,CO:60,MA:30}},
    formula:"minutes_per_month / 60",
    hammerTimeMapping:{AT:"OH.030",AC:"OH.030",SA:"OH.030",CO:"OH.030",MA:"OH.030"}},
  
  {key:"oh_client_training",section:"oh",name:"Client Training/Q&A",levels:{1:true,2:true,3:true},
    variables:[{key:"sessions_per_month",label:"Sessions/month",type:"number",default:2}],
    lookupType:"role",
    lookupTable:{key:"minutes_per_session",label:"Minutes per Session",rows:{AT:0,AC:30,SA:60,CO:30,MA:15}},
    formula:"sessions_per_month * minutes_per_session / 60",
    hammerTimeMapping:{AT:"OH.040",AC:"OH.040",SA:"OH.040",CO:"OH.040",MA:"OH.040"}},
  
  {key:"oh_issue_resolution",section:"oh",name:"Issue Resolution Buffer",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_month",label:"Minutes per Month",rows:{AT:60,AC:30,SA:60,CO:30,MA:15}},
    formula:"minutes_per_month / 60",
    hammerTimeMapping:{AT:"OH.050",AC:"OH.050",SA:"OH.050",CO:"OH.050",MA:"OH.050"}},
  
  {key:"oh_month_end_review",section:"oh",name:"Month-End Review Meeting",levels:{1:true,2:true,3:true},
    variables:[],
    lookupType:"role",
    lookupTable:{key:"minutes_per_month",label:"Minutes per Month",rows:{AT:0,AC:30,SA:60,CO:60,MA:30}},
    formula:"minutes_per_month / 60",
    hammerTimeMapping:{AT:"OH.060",AC:"OH.060",SA:"OH.060",CO:"OH.060",MA:"OH.060"}},
  
  {key:"oh_adhoc",section:"oh",name:"Ad-Hoc Requests Buffer",levels:{1:true,2:true,3:true},
    variables:[{key:"buffer_hours",label:"Buffer Hours/month",type:"number",default:2}],
    lookupType:"role",
    lookupTable:{key:"allocation_pct",label:"Allocation %",rows:{AT:0.3,AC:0.2,SA:0.2,CO:0.2,MA:0.1}},
    formula:"buffer_hours * allocation_pct",
    hammerTimeMapping:{AT:"OH.070",AC:"OH.070",SA:"OH.070",CO:"OH.070",MA:"OH.070"}}
];

const DEFAULT_HAMMERTIME_TASKS=[
  {id:"AD.010",task:"AD - Business Development",module:"AD"},
  {id:"AD.020",task:"AD - Holiday",module:"AD"},
  {id:"AD.080",task:"AD - Information Technology",module:"AD"},
  {id:"AD.030",task:"AD - Internal Meetings",module:"AD"},
  {id:"AD.040",task:"AD - Internal Misc",module:"AD"},
  {id:"AD.050",task:"AD - Internal Training",module:"AD"},
  {id:"AD.090",task:"AD - Marketing",module:"AD"},
  {id:"AD.100",task:"AD - Onboarding New Employee",module:"AD"},
  {id:"AD.091",task:"AD - Power/Internet Outage",module:"AD"},
  {id:"AD.060",task:"AD - PTO",module:"AD"},
  {id:"AD.070",task:"AD - Recruiting",module:"AD"},
  {id:"AD.081",task:"AD - Travel",module:"AD"},
  {id:"AP.010",task:"AP - Create New Vendor",module:"AP"},
  {id:"AP.060",task:"AP - PO Matching",module:"AP"},
  {id:"AP.075",task:"AP - Approvals",module:"AP"},
  {id:"AP.015",task:"AP - Enter AP/CC Invoices",module:"AP"},
  {id:"AP.016",task:"AP - Enter AP/CC Payments",module:"AP"},
  {id:"AP.150",task:"AP - Reconcile AP to GL",module:"AP"},
  {id:"AP.100",task:"AP - Subcontractor Compliance",module:"AP"},
  {id:"AP.130",task:"AP - Vendor Statement Reconciliation",module:"AP"},
  {id:"AR.080",task:"AR - Customer Maintenance",module:"AR"},
  {id:"AR.015",task:"AR - Enter AR Invoices",module:"AR"},
  {id:"AR.045",task:"AR - Enter Payments/Deposits",module:"AR"},
  {id:"AR.090",task:"AR - Reconcile AR to GL",module:"AR"},
  {id:"AU.010",task:"AU – Financial Audit",module:"AU"},
  {id:"AU.020",task:"AU - Insurance",module:"AU"},
  {id:"AU.030",task:"AU - Tax Audit",module:"AU"},
  {id:"AU.040",task:"AU - Worker Comp Audit",module:"AU"},
  {id:"CM.040",task:"CM - Cash Forecasting",module:"CM"},
  {id:"CM.100",task:"CM - Gather CM RFI",module:"CM"},
  {id:"CM.085",task:"CM - Missing Transactions",module:"CM"},
  {id:"CM.065",task:"CM - Reconcile Bank/CC/Investments",module:"CM"},
  {id:"CM.115",task:"CM - Reconcile CM to GL",module:"CM"},
  {id:"FA.030",task:"FA - Calculate & Record Depreciation",module:"FA"},
  {id:"FA.010",task:"FA - Gather Fixed Asset RFI",module:"FA"},
  {id:"FA.040",task:"FA - Reconcile Fixed Assets to GL",module:"FA"},
  {id:"FA.020",task:"FA - Record Fixed Asset Additions/Disposals",module:"FA"},
  {id:"FS.032",task:"FS - Complete Work Papers",module:"FS"},
  {id:"FS.035",task:"FS - Complete Work Papers",module:"FS"},
  {id:"FS.045",task:"FS - Final Financial Review",module:"FS"},
  {id:"FS.055",task:"FS - Financial Verification",module:"FS"},
  {id:"FS.065",task:"FS - Generate/Analyze Financial Reports",module:"FS"},
  {id:"FS.100",task:"FS - Quarterly Budget Updates",module:"FS"},
  {id:"GL.045",task:"GL - Gather GL RFI",module:"GL"},
  {id:"GL.060",task:"GL - GL/COA Setup",module:"GL"},
  {id:"GL.080",task:"GL - Monitor/Resolve GL Issues",module:"GL"},
  {id:"GL.090",task:"GL - Reconcile Intercompany Transactions",module:"GL"},
  {id:"GL.100",task:"GL - Reconcile Inventory",module:"GL"},
  {id:"GL.110",task:"GL - Reconcile Other Balance Sheet Accounts",module:"GL"},
  {id:"GL.130",task:"GL - Reconcile Prepaid Entries to GL",module:"GL"},
  {id:"GL.010",task:"GL - Setup New GL Accounts",module:"GL"},
  {id:"IM.075",task:"IM - Billable Hours",module:"IM"},
  {id:"IM.070",task:"IM - Client Training",module:"IM"},
  {id:"IM.810",task:"IM - Data Conversion",module:"IM"},
  {id:"IM.820",task:"IM - Generate/Analyze Financial Reports",module:"IM"},
  {id:"IM.830",task:"IM - Integrations",module:"IM"},
  {id:"IM.890",task:"IM - Meetings",module:"IM"},
  {id:"IM.630",task:"IM - Payroll",module:"IM"},
  {id:"IM.840",task:"IM - Process Optimization",module:"IM"},
  {id:"IM.990",task:"IM - Project Management",module:"IM"},
  {id:"IM.850",task:"IM - Reconciliations",module:"IM"},
  {id:"IM.065",task:"IM - Requirements Gathering",module:"IM"},
  {id:"IM.860",task:"IM - Setup/ Gather RFI",module:"IM"},
  {id:"IM.870",task:"IM - System Setup",module:"IM"},
  {id:"IM.880",task:"IM - Work Paper Setup/Review",module:"IM"},
  {id:"JC.070",task:"JC - Enter Contracts & Change Orders",module:"JC"},
  {id:"JC.030",task:"JC - Gather JC RFI",module:"JC"},
  {id:"JC.050",task:"JC - Generate/Review Job Cost Reports",module:"JC"},
  {id:"JC.115",task:"JC - Generate/Review WIP",module:"JC"},
  {id:"JC.090",task:"JC - Indirect Cost Allocations",module:"JC"},
  {id:"JC.080",task:"JC - Monthly Job Cost Meetings",module:"JC"},
  {id:"JC.130",task:"JC - Reconcile Job Cost to GL",module:"JC"},
  {id:"JC.120",task:"JC - Review and Confirm WIP with Client",module:"JC"},
  {id:"JC.010",task:"JC - Setup New Jobs",module:"JC"},
  {id:"JC.060",task:"JC - Update Cost Estimates",module:"JC"},
  {id:"JC.100",task:"JC - WIP Adjustment Entries",module:"JC"},
  {id:"LN.010",task:"LN - Gather Loan RFI",module:"LN"},
  {id:"LN.030",task:"LN - Reconcile Loans to GL",module:"LN"},
  {id:"LN.020",task:"LN - Setup New Loans",module:"LN"},
  {id:"OH.010",task:"OH - Ad Hoc Client Activities",module:"OH"},
  {id:"OH.040",task:"OH - Client Training",module:"OH"},
  {id:"OH.100",task:"OH - Communication with Client",module:"OH"},
  {id:"OH.060",task:"OH - Gather RFI Items",module:"OH"},
  {id:"OH.050",task:"OH - Information Technology",module:"OH"},
  {id:"OH.110",task:"OH - Internal Client Training",module:"OH"},
  {id:"OH.090",task:"OH - Internal Meetings",module:"OH"},
  {id:"OH.080",task:"OH - Onboarding/Offboarding Employee to Client (Shadowing)",module:"OH"},
  {id:"OH.130",task:"OH - Project Management",module:"OH"},
  {id:"OH.030",task:"OH - Scheduled Client Meetings",module:"OH"},
  {id:"OH.070",task:"OH - Unscheduled Client Meetings",module:"OH"},
  {id:"PR.010",task:"PR - 401K Processing",module:"PR"},
  {id:"PR.020",task:"PR - Benefit Enrollment",module:"PR"},
  {id:"PR.030",task:"PR - Certified Payroll Reports",module:"PR"},
  {id:"PR.150",task:"PR - File Union Reports",module:"PR"},
  {id:"PR.140",task:"PR - Gather Payroll RFI",module:"PR"},
  {id:"PR.060",task:"PR - Generate Requested Reports for PR Audits",module:"PR"},
  {id:"PR.170",task:"PR - OCIP/CCIP Support",module:"PR"},
  {id:"PR.035",task:"PR - Payroll Time Entry, Process & Review",module:"PR"},
  {id:"PR.160",task:"PR - Process Garnishments & Other Deductions",module:"PR"},
  {id:"PR.085",task:"PR - Process Payroll Taxes",module:"PR"},
  {id:"PR.110",task:"PR - Reconcile Payroll Taxes",module:"PR"},
  {id:"PR.180",task:"PR - Reconcile Payroll to GL",module:"PR"},
  {id:"PR.120",task:"PR - Setup New Employees",module:"PR"},
  {id:"PR.130",task:"PR - Third Party Integration/JEs",module:"PR"},
  {id:"TX.005",task:"TX - Calculate/Process Use Tax",module:"TX"},
  {id:"TX.020",task:"TX - Coordinate Tax Filings with External CPA",module:"TX"},
  {id:"TX.060",task:"TX - Gather Tax RFI",module:"TX"},
  {id:"TX.070",task:"TX - Generate Reports for Income Taxes",module:"TX"},
  {id:"TX.030",task:"TX - Process Estimated Tax Payments",module:"TX"},
  {id:"TX.090",task:"TX - Reconcile Taxes to GL",module:"TX"},
  {id:"TX.080",task:"TX - Review Tax Filings",module:"TX"},
  {id:"YE.040",task:"YE - Generate 1099s",module:"YE"},
  {id:"YE.050",task:"YE - Generate W-2s",module:"YE"},
  {id:"YE.030",task:"YE - Review Year End Reports",module:"YE"},
  {id:"YE.060",task:"YE - Year-End Close",module:"YE"},
  {id:"OH.010",task:"OH - Weekly Status Calls",module:"OH"},
  {id:"OH.020",task:"OH - Email/Slack Communication",module:"OH"},
  {id:"OH.030",task:"OH - Internal Team Coordination",module:"OH"},
  {id:"OH.040",task:"OH - Client Training/Q&A",module:"OH"},
  {id:"OH.050",task:"OH - Issue Resolution Buffer",module:"OH"},
  {id:"OH.060",task:"OH - Month-End Review Meeting",module:"OH"},
  {id:"OH.070",task:"OH - Ad-Hoc Requests Buffer",module:"OH"},
  {id:"OH.080",task:"OH - Ad-Hoc/Flex Task",module:"OH"}
];

const DEFAULT_VARIABLES={
  client:{label:"Client Questionnaire",color:"#2D3436",tables:{
    software:{label:"Accounting Software",type:"options",options:["Computer Ease","Foundation","Quickbooks Desktop","Quickbooks Online","Sage 100 (Master Builder)","Sage 300 (Timberline)","Viewpoint","Vista","Other"]},
    staff_quality:{label:"Quality of Accounting Staff",type:"multiplier",rows:{"Excellent":0,"Average":0.05,"No Skills/Good Attitude":0.10,"No Staff":0.15,"Bad Attitude":0.20}},
    annual_revenue:{label:"Annual Revenue",type:"multiplier",rows:{"Under $3M":1,"$3M - $5M":1.1,"$5M - $10M":1.15,"$10M - $20M":1.2,"$20M +":1.3}}
  }},
  payroll:{label:"Payroll",color:"#333",tables:{
    payroll_frequency:{label:"Payroll Frequency",type:"multiplier",rows:{"Weekly":4,"Twice Monthly":2,"Monthly":1}}
  }},
  jobcost:{label:"Job Costing",color:"#0891B2",tables:{
    concurrent_jobs:{label:"Avg # Concurrent Jobs",type:"multiplier",rows:{"0-10":60,"10-25":90,"25-50":120,"50+":180}}
  }}
};

const AppContext=createContext();
const DEFAULT_LEVELS={
  1:{name:'Basic',color:'#6B7280',bgColor:'#F9FAFB',gross_margin:40},
  2:{name:'Standard',color:'#802629',bgColor:'#F9FAFB',gross_margin:45},
  3:{name:'Premium',color:'#4A1516',bgColor:'#F9FAFB',gross_margin:50}
};

// Construction Industries - General/Developer first, then subcontractors alphabetically
const DEFAULT_INDUSTRIES=[
  // Primary - at top
  'General Contractor',
  'Developer',
  'Design-Build',
  'Construction Manager',
  // Subcontractors - alphabetical
  'Acoustical Ceiling',
  'Asbestos Abatement',
  'Asphalt Paving',
  'Bridge Construction',
  'Cabinetry & Millwork',
  'Carpentry - Finish',
  'Carpentry - Framing',
  'Carpentry - Rough',
  'Caulking & Waterproofing',
  'Civil Engineering',
  'Concrete - Decorative',
  'Concrete - Flatwork',
  'Concrete - Foundations',
  'Concrete - Precast',
  'Concrete - Structural',
  'Concrete Cutting & Coring',
  'Curtain Wall',
  'Damp Proofing',
  'Demolition',
  'Drywall & Plaster',
  'Earthwork & Excavation',
  'Electrical - Commercial',
  'Electrical - Industrial',
  'Electrical - Residential',
  'Electrical - Low Voltage',
  'Elevator & Escalator',
  'Environmental Remediation',
  'Erosion Control',
  'Fencing',
  'Fire Protection & Sprinkler',
  'Fire Stopping',
  'Flooring - Carpet',
  'Flooring - Hardwood',
  'Flooring - Resilient',
  'Flooring - Tile & Stone',
  'Foundation Repair',
  'Garage Doors',
  'Glass & Glazing',
  'Grading',
  'Gutter & Downspout',
  'Hazardous Material Removal',
  'HVAC - Commercial',
  'HVAC - Industrial',
  'HVAC - Residential',
  'HVAC Controls',
  'Insulation - Building',
  'Insulation - Mechanical',
  'Interior Finishing',
  'Irrigation',
  'Kitchen & Bath',
  'Land Clearing',
  'Landscaping',
  'Lathing',
  'Lead Abatement',
  'Masonry - Brick',
  'Masonry - Block',
  'Masonry - Stone',
  'Mechanical Contractor',
  'Metal Buildings',
  'Metal Fabrication',
  'Metal Studs & Framing',
  'Painting - Commercial',
  'Painting - Industrial',
  'Painting - Residential',
  'Piling & Shoring',
  'Plumbing - Commercial',
  'Plumbing - Industrial',
  'Plumbing - Residential',
  'Post-Tension',
  'Rebar & Reinforcing Steel',
  'Retaining Walls',
  'Roofing - Commercial',
  'Roofing - Industrial',
  'Roofing - Residential',
  'Roofing - Metal',
  'Roofing - Shingle',
  'Roofing - TPO/EPDM',
  'Scaffolding',
  'Security Systems',
  'Septic Systems',
  'Sheet Metal',
  'Siding',
  'Signage',
  'Site Utilities',
  'Site Work',
  'Solar Installation',
  'Specialty Contractor',
  'Spray Fireproofing',
  'Steel Erection',
  'Stucco & EIFS',
  'Swimming Pool',
  'Telecommunications',
  'Terrazzo',
  'Tile - Ceramic',
  'Tile - Stone',
  'Traffic Control',
  'Tree Service',
  'Trenching',
  'Underground Utilities',
  'Waterproofing',
  'Welding',
  'Well Drilling',
  'Window Installation',
  'Wood Flooring',
  'Other'
];

// Software options used across customer and quote forms
const DEFAULT_SOFTWARE=[
  'Quickbooks Online',
  'Quickbooks Desktop',
  'Intuit Enterprise Suite',
  'Sage 100 Contractor',
  'Sage 300 CRE',
  'Foundation Software',
  'Viewpoint Vista',
  'Viewpoint Spectrum',
  'CMiC',
  'Procore',
  'NetSuite',
  'Other'
];

// Icons
const ChevronRight=()=><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 18l6-6-6-6"/></svg>;
const Hammer=()=><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M2 19.63L13.43 8.2l-.71-.7 1.42-1.43 3.54 3.54-1.42 1.41-.71-.7L4.13 21.75l-2.12-2.12zM20.71 7l-3.54-3.54 1.41-1.41 3.54 3.54L20.71 7z"/></svg>;
const CommentIcon=()=><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>;
const TeamIcon=()=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
const SendIcon=()=><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>;
const AtIcon=()=><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M16 8v5a3 3 0 0 0 6 0v-1a10 10 0 1 0-3.92 7.94"/></svg>;

// Menu Icons
const ChartIcon=()=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>;
const ReportIcon=()=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>;
const HomeIcon=()=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>;
const GearIcon=()=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>;
const SettingsIcon=()=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>;
const HamburgerIcon=()=><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>;
const CloseIcon=()=><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;

// Number formatting helpers
const fmt=(n,decimals=2)=>n.toLocaleString(undefined,{minimumFractionDigits:decimals,maximumFractionDigits:decimals});
const fmtInt=(n)=>Math.round(n).toLocaleString();
const fmtCurrency=(n,decimals=2)=>'$'+Math.abs(n).toLocaleString(undefined,{minimumFractionDigits:decimals,maximumFractionDigits:decimals});
const fmtCurrencyInt=(n)=>'$'+Math.abs(Math.round(n)).toLocaleString();
const fmtDateTime=(dateStr)=>{
  if(!dateStr)return '-';
  const d=new Date(dateStr);
  return d.toLocaleDateString()+' '+d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
};
const PlusIcon=()=><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 5v14M5 12h14"/></svg>;
const TrashIcon=()=><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>;
const SaveIcon=()=><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/></svg>;
const EditIcon=()=><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>;
const BackspaceIcon=()=><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 4H8l-7 8 7 8h13a2 2 0 002-2V6a2 2 0 00-2-2z"/><line x1="18" y1="9" x2="12" y2="15"/><line x1="12" y1="9" x2="18" y2="15"/></svg>;

// Visual Formula Builder Popup
function FormulaBuilderPopup({formula,variables,task,onSave,onClose}){
  const{variables:varTables,roles}=useContext(AppContext);
  const[tokens,setTokens]=useState([]);
  const[mode,setMode]=useState('simple');
  const[lookupConfig,setLookupConfig]=useState({variable:'',pairs:[{key:'',value:''}],defaultValue:''});
  const[customNumber,setCustomNumber]=useState('');
  const[error,setError]=useState(null);
  const[testResult,setTestResult]=useState(null);
  const[directEdit,setDirectEdit]=useState(false);
  const[directFormula,setDirectFormula]=useState('');
  const[varPickerOpen,setVarPickerOpen]=useState(false);

  useEffect(()=>{
    if(formula&&typeof formula==='string'&&formula.trim()){
      try{
        const parts=formula.match(/([a-zA-Z_][a-zA-Z0-9_]*|"[^"]*"|\d+\.?\d*|[+\-*/(),]|\s+)/g)||[];
        const toks=parts.filter(p=>p&&p.trim()).map(p=>{
          if(/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(p)){
            if(['LOOKUP','IF','ROUND','MIN','MAX'].includes(p))return{type:'func',value:p};
            return{type:'var',value:p};
          }
          if(/^".*"$/.test(p))return{type:'str',value:p};
          if(/^\d+\.?\d*$/.test(p))return{type:'num',value:p};
          return{type:'op',value:p};
        });
        setTokens(toks);
        setDirectFormula(formula);
      }catch(e){setTokens([]);setDirectFormula('')}
    }else{setTokens([]);setDirectFormula('')}
  },[]);

  const buildFormula=useCallback(()=>{
    if(directEdit)return directFormula;
    return tokens.map(t=>t.value).join(' ').replace(/\s+/g,' ').replace(/\(\s+/g,'(').replace(/\s+\)/g,')').replace(/\s+,/g,',').replace(/,\s+/g,', ').trim();
  },[tokens,directEdit,directFormula]);

  useEffect(()=>{
    const f=buildFormula();
    if(!f){setError(null);setTestResult(null);return}
    const validation=FormulaEngine.validate(f);
    setError(validation.valid?null:validation.error);
    if(validation.valid&&variables&&variables.length>0){
      try{
        const testVars={};
        variables.forEach(v=>{testVars[v.key]=v.default||10});
        const result=FormulaEngine.evaluate(f,testVars,varTables);
        setTestResult(typeof result==='number'?result:null);
      }catch(e){setTestResult(null)}
    }else{setTestResult(null)}
  },[tokens,directFormula,directEdit,variables,varTables,buildFormula]);

  const addToken=(type,value)=>{setDirectEdit(false);setTokens(prev=>[...prev,{type,value}])};
  const removeLastToken=()=>{setDirectEdit(false);setTokens(prev=>prev.slice(0,-1))};
  const clearTokens=()=>{setDirectEdit(false);setTokens([]);setDirectFormula('')};
  const addNumber=()=>{if(customNumber&&!isNaN(parseFloat(customNumber))){addToken('num',customNumber);setCustomNumber('')}};

  const handleDirectFormulaChange=(newFormula)=>{
    setDirectFormula(newFormula);
    setDirectEdit(true);
  };

  const buildLookup=()=>{
    if(!lookupConfig.variable)return;
    setDirectEdit(false);
    const toks=[{type:'func',value:'LOOKUP'},{type:'op',value:'('},{type:'var',value:lookupConfig.variable}];
    lookupConfig.pairs.forEach(p=>{
      if(p.key&&p.value){
        toks.push({type:'op',value:','},{type:'str',value:`"${p.key}"`},{type:'op',value:','},{type:'num',value:p.value});
      }
    });
    if(lookupConfig.defaultValue){toks.push({type:'op',value:','},{type:'num',value:lookupConfig.defaultValue})}
    toks.push({type:'op',value:')'});
    setTokens(prev=>[...prev,...toks]);
    setLookupConfig({variable:'',pairs:[{key:'',value:''}],defaultValue:''});
    setMode('simple');
  };

  const getOptionsForVariable=(varKey)=>{
    const v=(variables||[]).find(x=>x.key===varKey);
    if(!v?.optionsKey)return[];
    const tables=varTables?.client?.tables||{};
    return tables[v.optionsKey]?.options||[];
  };

  const renderFormula=()=>{
    const f=buildFormula();
    if(!f)return<span className="text-gray-500 italic">Click buttons below or type directly...</span>;
    if(directEdit)return<span className="text-white">{f}</span>;
    return tokens.map((t,i)=>{
      const cls=t.type==='var'?'var':t.type==='func'?'func':t.type==='num'?'num':t.type==='str'?'str':'op';
      return<span key={i} className={cls}>{t.value} </span>;
    });
  };

  const enumVariables=(variables||[]).filter(v=>v.type==='enum');
  const numberVariables=(variables||[]).filter(v=>v.type==='number');

  // Collect all variable table keys for the picker
  const allTableVars=[];
  Object.entries(varTables||{}).forEach(([catKey,cat])=>{
    if(cat.tables){
      Object.entries(cat.tables).forEach(([tblKey,tbl])=>{
        allTableVars.push({category:cat.label,catKey,tableKey:tblKey,label:tbl.label,type:tbl.type});
      });
    }
  });

  return(
    <div className="modal-overlay" onClick={e=>e.target===e.currentTarget&&onClose()}>
      <div className="modal-content">
        {/* Header */}
        <div className="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gray-50">
          <div>
            <h2 className="text-lg font-bold text-gray-800">Formula Builder</h2>
            <p className="text-sm text-gray-500">{task?.name||'Task'}</p>
          </div>
          <button onClick={onClose} className="p-2 hover:bg-gray-200 rounded-lg"><CloseIcon/></button>
        </div>
        
        {/* Formula Display - Now Editable */}
        <div className="px-6 py-4 border-b border-gray-200">
          <div className="relative">
            {directEdit?(
              <textarea value={directFormula} onChange={e=>handleDirectFormulaChange(e.target.value)}
                className="w-full bg-gray-900 text-green-400 p-4 rounded-lg text-sm min-h-[60px] resize-none border-2 border-rh-maroon"
                placeholder="Type formula directly..."/>
            ):(
              <div className="formula-display cursor-text min-h-[60px]" onClick={()=>{setDirectEdit(true);setDirectFormula(buildFormula())}}>
                {renderFormula()}
                <span className="absolute top-2 right-2 text-xs text-gray-500">click to edit</span>
              </div>
            )}
          </div>
          <div className="flex items-center justify-between mt-3">
            <div className="flex gap-2">
              <button onClick={removeLastToken} className="builder-btn action flex items-center gap-1" disabled={directEdit}><BackspaceIcon/> Undo</button>
              <button onClick={clearTokens} className="builder-btn action">Clear All</button>
              {directEdit&&<button onClick={()=>setDirectEdit(false)} className="builder-btn action">Back to Builder</button>}
            </div>
            {error?<div className="text-red-600 text-sm bg-red-50 px-3 py-1 rounded">⚠ {error}</div>:
             testResult!==null?<div className="text-green-600 text-sm bg-gray-100 px-3 py-1 rounded">✓ Result: {testResult.toFixed(2)} hrs</div>:null}
          </div>
        </div>
        
        {/* Mode Tabs */}
        <div className="px-6 pt-4">
          <div className="flex gap-2 border-b border-gray-200">
            {[{id:'simple',label:'Simple Math'},{id:'lookup',label:'If/Then (LOOKUP)'},{id:'variables',label:'Variables'},{id:'advanced',label:'Advanced'}].map(m=>(
              <button key={m.id} onClick={()=>setMode(m.id)} className={`px-4 py-2 text-sm font-medium border-b-2 ${mode===m.id?'border-rh-maroon text-rh-maroon':'border-transparent text-gray-500 hover:text-gray-700'}`}>{m.label}</button>
            ))}
          </div>
        </div>
        
        {/* Builder Content */}
        <div className="px-6 py-4 max-h-72 overflow-y-auto">
          {mode==='simple'&&(
            <div className="space-y-4">
              {variables&&variables.length>0&&(
                <div>
                  <div className="section-label">Task Variables</div>
                  <div className="flex flex-wrap gap-2">
                    {variables.map(v=><button key={v.key} onClick={()=>addToken('var',v.key)} className="builder-btn var">{v.label} ({v.key})</button>)}
                  </div>
                </div>
              )}
              <div>
                <div className="section-label">➕ Math Operations</div>
                <div className="flex flex-wrap gap-2">
                  {[{l:'+ Add',v:'+'},{l:'− Subtract',v:'-'},{l:'× Multiply',v:'*'},{l:'÷ Divide',v:'/'},{l:'( Open',v:'('},{l:') Close',v:')'}].map(op=>
                    <button key={op.v} onClick={()=>addToken('op',op.v)} className="builder-btn op">{op.l}</button>
                  )}
                </div>
              </div>
              <div>
                <div className="section-label">🔢 Numbers</div>
                <div className="flex flex-wrap gap-2 items-center">
                  {['60','12','4','1','0.5'].map(n=><button key={n} onClick={()=>addToken('num',n)} className="builder-btn num">{n}</button>)}
                  <input type="number" value={customNumber} onChange={e=>setCustomNumber(e.target.value)} placeholder="Custom" className="w-20 px-2 py-1.5 border rounded text-sm" onKeyDown={e=>e.key==='Enter'&&addNumber()}/>
                  <button onClick={addNumber} className="builder-btn num">Add #</button>
                </div>
              </div>
              {numberVariables.length>0&&(
                <div>
                  <div className="section-label">⚡ Quick Templates</div>
                  <div className="flex flex-wrap gap-2">
                    <button onClick={()=>{clearTokens();setTokens([{type:'var',value:numberVariables[0].key},{type:'op',value:'*'},{type:'num',value:'5'},{type:'op',value:'/'},{type:'num',value:'60'}])}} className="builder-btn action">📝 Count × Minutes ÷ 60</button>
                    <button onClick={()=>{clearTokens();setTokens([{type:'var',value:numberVariables[0].key},{type:'op',value:'*'},{type:'num',value:'1'}])}} className="builder-btn action">📝 Direct Hours</button>
                  </div>
                </div>
              )}
            </div>
          )}
          
          {mode==='variables'&&(
            <div className="space-y-4">
              <div className="bg-red-50 border border-red-200 rounded-lg p-3 text-sm text-rh-maroon">
                Click any variable table key to insert it into your formula. These reference the assumption tables in Admin → Variables.
              </div>
              {Object.entries(varTables||{}).map(([catKey,cat])=>(
                <div key={catKey}>
                  <div className="section-label" style={{color:cat.color}}>{cat.label}</div>
                  <div className="flex flex-wrap gap-2">
                    {cat.tables&&Object.entries(cat.tables).map(([tblKey,tbl])=>(
                      <button key={tblKey} onClick={()=>addToken('var',tblKey)} className="builder-btn var text-xs" title={tbl.label}>
                        {tblKey} <span className="text-gray-400 ml-1">({tbl.type})</span>
                      </button>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          )}
          
          {mode==='lookup'&&(
            <div className="space-y-4">
              <div className="bg-gray-100 border border-gray-300 rounded-lg p-3 text-sm text-gray-700">
                <strong>LOOKUP</strong> returns different values based on a selection. Example: "Weekly" → 18 hours, "Monthly" → 4.5 hours
              </div>
              {enumVariables.length===0?<div className="text-gray-500 text-sm">No dropdown variables available for this task. Add an enum variable first.</div>:(
                <div className="lookup-builder">
                  <div className="mb-3">
                    <label className="section-label">Variable to Check</label>
                    <select value={lookupConfig.variable} onChange={e=>{
                      setLookupConfig(prev=>({...prev,variable:e.target.value,pairs:getOptionsForVariable(e.target.value).map(opt=>({key:opt,value:''}))}));
                    }} className="w-full px-3 py-2 border rounded">
                      <option value="">Select variable...</option>
                      {enumVariables.map(v=><option key={v.key} value={v.key}>{v.label}</option>)}
                    </select>
                  </div>
                  {lookupConfig.variable&&(
                    <>
                      <div className="section-label">When value is... return hours:</div>
                      {lookupConfig.pairs.map((pair,i)=>(
                        <div key={i} className="lookup-row">
                          <span className="text-sm text-gray-600 w-8">If</span>
                          <input type="text" value={pair.key} onChange={e=>{const newPairs=[...lookupConfig.pairs];newPairs[i].key=e.target.value;setLookupConfig(prev=>({...prev,pairs:newPairs}))}} placeholder="Value" className="flex-1"/>
                          <span className="text-sm text-gray-600">→</span>
                          <input type="number" value={pair.value} onChange={e=>{const newPairs=[...lookupConfig.pairs];newPairs[i].value=e.target.value;setLookupConfig(prev=>({...prev,pairs:newPairs}))}} placeholder="Hours" className="w-20"/>
                          <button onClick={()=>{const newPairs=lookupConfig.pairs.filter((_,j)=>j!==i);setLookupConfig(prev=>({...prev,pairs:newPairs}))}} className="text-red-500 p-1"><TrashIcon/></button>
                        </div>
                      ))}
                      <button onClick={()=>setLookupConfig(prev=>({...prev,pairs:[...prev.pairs,{key:'',value:''}]}))} className="text-rh-maroon text-sm hover:underline mt-2">+ Add condition</button>
                      <div className="lookup-row mt-3 pt-3 border-t border-gray-300">
                        <span className="text-sm text-gray-600">Default:</span>
                        <input type="number" value={lookupConfig.defaultValue} onChange={e=>setLookupConfig(prev=>({...prev,defaultValue:e.target.value}))} placeholder="Hours" className="w-20"/>
                      </div>
                      <button onClick={buildLookup} className="mt-4 px-4 py-2 bg-gray-1000 text-white rounded-lg hover:bg-gray-700">Add LOOKUP to Formula</button>
                    </>
                  )}
                </div>
              )}
            </div>
          )}
          
          {mode==='advanced'&&(
            <div className="space-y-4">
              <div>
                <div className="section-label">🔧 Functions</div>
                <div className="flex flex-wrap gap-2">
                  {['IF','MIN','MAX','ROUND'].map(fn=><button key={fn} onClick={()=>{addToken('func',fn);addToken('op','(')}} className="builder-btn func">{fn}()</button>)}
                </div>
              </div>
              <div>
                <div className="section-label">⚖️ Comparisons</div>
                <div className="flex flex-wrap gap-2">
                  {[{l:'>',v:'>'},{l:'<',v:'<'},{l:'>=',v:'>='},{l:'<=',v:'<='},{l:'==',v:'=='},{l:'!=',v:'!='}].map(op=>
                    <button key={op.v} onClick={()=>addToken('op',op.v)} className="builder-btn op">{op.l}</button>
                  )}
                </div>
              </div>
              <div>
                <div className="section-label">Other</div>
                <button onClick={()=>addToken('op',',')} className="builder-btn op">, (comma)</button>
              </div>
              <div className="bg-gray-100 rounded-lg p-3 text-sm">
                <strong>Example IF:</strong> <code className="text-rh-maroon">IF ( count > 100 , count * 0.8 , count )</code>
              </div>
            </div>
          )}
        </div>
        
        {/* Footer */}
        <div className="flex items-center justify-between px-6 py-4 border-t border-gray-200 bg-gray-50">
          <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium">Cancel</button>
          <button onClick={()=>{onSave(buildFormula());onClose()}} disabled={!!error}
            className={`px-6 py-2 rounded-lg font-medium ${error?'bg-gray-300 text-gray-500 cursor-not-allowed':'bg-rh-maroon text-white hover:bg-rh-maroon-dark'}`}>
            Save Formula
          </button>
        </div>
      </div>
    </div>
  );
}

// Role Allocation Editor
function RoleAllocationEditor({allocation,roles,onChange}){
  const total=Object.values(allocation||{}).reduce((a,b)=>a+b,0);
  return(
    <div className="flex flex-wrap gap-3 items-center">
      {Object.keys(roles).map(r=>(
        <div key={r} className="flex items-center gap-1.5">
          <span className="w-3 h-3 rounded-full" style={{backgroundColor:roles[r].color}}></span>
          <span className="text-sm font-medium text-gray-700">{r}:</span>
          <input type="number" step="0.1" min="0" max="1" value={allocation?.[r]||0} onChange={e=>onChange({...allocation,[r]:parseFloat(e.target.value)||0})} className="w-14 px-2 py-1 border rounded text-sm text-center font-mono"/>
        </div>
      ))}
      <span className={`text-sm font-bold ${Math.abs(total-1)<0.01?'text-green-600':'text-red-500'}`}>= {(total*100).toFixed(0)}%</span>
    </div>
  );
}

// Admin View
function AdminView({initialTab='profile',setAdminTab}){
  const{roles,setRoles,variables,setVariables,tasks,setTasks,levels,setLevels,sections,setSaveVersion,adminHasChanges,setAdminHasChanges,settings,setSettings,auditLog,setAuditLog,logAudit,industries,setIndustries,user}=useContext(AppContext);
  const[tab,setTabLocal]=useState(initialTab);
  const setTab=(t)=>{setTabLocal(t);if(setAdminTab)setAdminTab(t);};
  
  // Sync with initialTab when it changes
  React.useEffect(()=>{setTabLocal(initialTab);},[initialTab]);
  
  // Profile state
  const[profile,setProfile]=useState({first_name:'',last_name:'',phone:'',job_title:'',timezone:'America/New_York',notifications_enabled:true});
  const[profileLoading,setProfileLoading]=useState(true);
  const[profileSaving,setProfileSaving]=useState(false);
  const[profileSaved,setProfileSaved]=useState(false);
  
  // Load profile on mount
  useEffect(()=>{
    if(user?.id){
      ProfileStorage.loadProfile(user.id).then(({data})=>{
        if(data){
          setProfile({
            first_name:data.first_name||user?.user_metadata?.first_name||'',
            last_name:data.last_name||user?.user_metadata?.last_name||'',
            phone:data.phone||user?.user_metadata?.phone||'',
            job_title:data.job_title||'',
            timezone:data.timezone||'America/New_York',
            notifications_enabled:data.notifications_enabled!==false
          });
        }else{
          // No profile yet, use auth metadata
          setProfile({
            first_name:user?.user_metadata?.first_name||'',
            last_name:user?.user_metadata?.last_name||'',
            phone:user?.user_metadata?.phone||'',
            job_title:'',
            timezone:'America/New_York',
            notifications_enabled:true
          });
        }
        setProfileLoading(false);
      });
    }
  },[user]);
  
  const saveProfile=async()=>{
    setProfileSaving(true);
    await ProfileStorage.saveProfile(user.id,profile);
    setProfileSaving(false);
    setProfileSaved(true);
    setTimeout(()=>setProfileSaved(false),2000);
    logAudit('profile_updated','user',user.id,null,null,'Updated user profile');
  };
  
  // Team members state
  const[teamMembers,setTeamMembers]=useState([]);
  const[teamLoading,setTeamLoading]=useState(true);
  const[editingMember,setEditingMember]=useState(null);
  const[inviteEmail,setInviteEmail]=useState('');
  const[inviteRole,setInviteRole]=useState('Viewer');
  const[userToast,setUserToast]=useState(null); // {type:'success'|'error', message:'...'}
  
  const showUserToast=(type,message)=>{
    setUserToast({type,message});
    setTimeout(()=>setUserToast(null),4000);
  };
  
  // Load team members with profiles
  useEffect(()=>{
    if(user?.id && tab==='users'){
      loadTeamMembers();
    }
  },[user,tab]);
  
  const loadTeamMembers=async()=>{
    setTeamLoading(true);
    // Load current user's profile as owner
    const ownerProfile = await ProfileStorage.loadProfile(user.id);
    const owner = {
      id: user.id,
      email: user.email,
      first_name: ownerProfile.data?.first_name || profile.first_name || '',
      last_name: ownerProfile.data?.last_name || profile.last_name || '',
      role: 'owner',
      status: 'active',
      last_active: new Date().toISOString()
    };
    
    // Load team members from team_members table
    if(supabase){
      const{data:members}=await supabase.from('team_members').select('*').eq('team_owner_id',user.id);
      // For each member, try to get their profile
      const membersWithProfiles = await Promise.all((members||[]).map(async m=>{
        if(m.member_user_id){
          const{data:memberProfile}=await supabase.from('user_profiles').select('*').eq('user_id',m.member_user_id).single();
          return{...m,first_name:memberProfile?.first_name||'',last_name:memberProfile?.last_name||''};
        }
        return{...m,first_name:'',last_name:''};
      }));
      setTeamMembers([owner,...membersWithProfiles]);
    }else{
      setTeamMembers([owner]);
    }
    setTeamLoading(false);
  };
  
  const inviteUser=async()=>{
    if(!inviteEmail.trim()){
      showUserToast('error','Please enter an email address');
      return;
    }
    if(!supabase){
      showUserToast('error','Team invitations require Supabase connection');
      return;
    }
    try{
      const emailLower = inviteEmail.trim().toLowerCase();
      const capitalizedRole = inviteRole.charAt(0).toUpperCase() + inviteRole.slice(1);
      
      // First, add to team_members table
      const{data:memberData,error:memberError}=await supabase.from('team_members').insert({
        team_owner_id:user.id,
        email:emailLower,
        role:capitalizedRole,
        status:'pending'
      }).select().single();
      
      if(memberError){
        if(memberError.code==='23505'){
          showUserToast('error','This user has already been invited');
        }else{
          showUserToast('error','Error sending invite: '+memberError.message);
        }
        return;
      }
      
      // Create user account with temporary password
      const tempPassword = 'RedHammer_' + Math.random().toString(36).slice(2,10) + '_' + Date.now();
      const{data:signUpData,error:signUpError}=await supabase.auth.signUp({
        email:emailLower,
        password:tempPassword,
        options:{
          data:{
            invited_by:user.id,
            team_role:capitalizedRole,
            first_name:'',
            last_name:'',
            phone:''
          }
        }
      });
      
      if(signUpError){
        // User might already exist - that's ok
        if(!signUpError.message.includes('already registered')){
          console.log('SignUp note:',signUpError.message);
        }
      }
      
      // Send password reset email so they can set their own password
      const{error:resetError}=await supabase.auth.resetPasswordForEmail(emailLower,{
        redirectTo:window.location.origin
      });
      
      if(resetError){
        console.log('Reset email note:',resetError.message);
        // Still show success - the team member record was created
      }
      
      // Link user ID if we got one
      if(signUpData?.user?.id){
        await supabase.from('team_members')
          .update({member_user_id:signUpData.user.id})
          .eq('id',memberData.id);
      }
      
      logAudit('user_invited','user',memberData?.id,null,{email:emailLower,role:capitalizedRole},`Invited ${emailLower} as ${capitalizedRole}`);
      showUserToast('success',`Invitation sent to ${emailLower}! They'll receive an email to set their password.`);
      setInviteEmail('');
      loadTeamMembers();
    }catch(err){
      showUserToast('error','Error: '+err.message);
    }
  };
  
  const updateMemberRole=async(memberId,newRole)=>{
    if(supabase){
      const capitalizedRole = newRole.charAt(0).toUpperCase() + newRole.slice(1);
      await supabase.from('team_members').update({role:capitalizedRole}).eq('id',memberId);
      loadTeamMembers();
      logAudit('user_role_changed','user',memberId,null,{role:capitalizedRole},`Changed role to ${capitalizedRole}`);
    }
  };
  
  const updateMemberStatus=async(memberId,newStatus)=>{
    if(supabase){
      await supabase.from('team_members').update({status:newStatus}).eq('id',memberId);
      loadTeamMembers();
      logAudit('user_status_changed','user',memberId,null,{status:newStatus},`Changed status to ${newStatus}`);
    }
  };
  
  const removeMember=async(memberId)=>{
    if(supabase && confirm('Are you sure you want to remove this team member?')){
      await supabase.from('team_members').delete().eq('id',memberId);
      loadTeamMembers();
      logAudit('user_removed','user',memberId,null,null,'Removed team member');
    }
  };
  
  const[activeVarCat,setActiveVarCat]=useState('client');
  const[newRoleCode,setNewRoleCode]=useState('');
  const[expandedSections,setExpandedSections]=useState(new Set());
  const[showSaveToast,setShowSaveToast]=useState(false);
  const[formulaBuilderTask,setFormulaBuilderTask]=useState(null);
  const[newRowKey,setNewRowKey]=useState({});
  const[variablesExpanded,setVariablesExpanded]=useState(false);
  
  // HammerTime tasks state
  const[hammertimeTasks,setHammertimeTasks]=useState(DEFAULT_HAMMERTIME_TASKS);
  const[htFilter,setHtFilter]=useState('');
  const[htModuleFilter,setHtModuleFilter]=useState('');
  const[editingHtTask,setEditingHtTask]=useState(null);
  const[newHtTask,setNewHtTask]=useState({id:'',task:'',module:''});
  
  // Use the lifted hasChanges state
  const hasChanges=adminHasChanges;
  const setHasChanges=setAdminHasChanges;

  const toProperCase=(str)=>str.split('_').map(w=>w.charAt(0).toUpperCase()+w.slice(1).toLowerCase()).join(' ');

  const toggleSection=k=>{setExpandedSections(p=>{const n=new Set(p);n.has(k)?n.delete(k):n.add(k);return n})};
  const updateRole=(c,f,v)=>{setRoles(p=>({...p,[c]:{...p[c],[f]:f==='name'||f==='color'?v:parseFloat(v)||0}}));setHasChanges(true)};
  const addRole=()=>{if(!newRoleCode||roles[newRoleCode.toUpperCase()])return;const c=newRoleCode.toUpperCase().slice(0,3);setRoles(p=>({...p,[c]:{name:`New ${c}`,cost_rate:20,color:'#888888'}}));setNewRoleCode('');setHasChanges(true)};
  const removeRole=c=>{if(Object.keys(roles).length<=1)return;setRoles(p=>{const n={...p};delete n[c];return n});setHasChanges(true)};
  
  // Level settings functions
  const updateLevel=(l,field,value)=>{
    setLevels(p=>({...p,[l]:{...p[l],[field]:value}}));
    setHasChanges(true);
  };
  
  // State for software added popup
  const[softwareAddedPopup,setSoftwareAddedPopup]=useState(null);
  
  const addOptionToTable=(cat,tblKey,newOpt)=>{
    if(!newOpt.trim())return;
    
    // If adding a new software option, propagate to all software-type tasks
    if(cat==='client'&&tblKey==='software'){
      const affectedTasks=[];
      setTasks(p=>p.map(t=>{
        if(t.lookupType==='software'&&t.lookupTable){
          // Copy values from Quickbooks Online as default
          const qboValues=t.lookupTable.rows?.['Quickbooks Online']||{};
          affectedTasks.push(t.name);
          return{
            ...t,
            lookupTable:{
              ...t.lookupTable,
              rows:{...t.lookupTable.rows,[newOpt]:{...qboValues}}
            }
          };
        }
        return t;
      }));
      
      // Show popup with affected tasks
      if(affectedTasks.length>0){
        setSoftwareAddedPopup({software:newOpt,tasks:affectedTasks});
      }
    }
    
    setVariables(p=>{
      const tbl=p[cat].tables[tblKey];
      if(tbl.type==='options'){
        // Add new option and sort alphabetically
        const newOptions=[...tbl.options,newOpt].sort((a,b)=>a.localeCompare(b));
        return{...p,[cat]:{...p[cat],tables:{...p[cat].tables,[tblKey]:{...tbl,options:newOptions}}}};
      }
      return p;
    });
    setHasChanges(true);
  };
  
  const removeOptionFromTable=(cat,tblKey,opt)=>{
    setVariables(p=>{
      const tbl=p[cat].tables[tblKey];
      if(tbl.type==='options'){return{...p,[cat]:{...p[cat],tables:{...p[cat].tables,[tblKey]:{...tbl,options:tbl.options.filter(o=>o!==opt)}}}}}
      return p;
    });
    setHasChanges(true);
  };

  const updateVariableValue=(cat,tblKey,rowKey,roleKey,value)=>{
    setVariables(p=>{
      const tbl=p[cat].tables[tblKey];
      const newRows={...tbl.rows,[rowKey]:{...tbl.rows[rowKey],[roleKey]:parseFloat(value)||0}};
      return{...p,[cat]:{...p[cat],tables:{...p[cat].tables,[tblKey]:{...tbl,rows:newRows}}}};
    });
    setHasChanges(true);
  };

  const updateMultiplierValue=(cat,tblKey,rowKey,value)=>{
    setVariables(p=>{
      const tbl=p[cat].tables[tblKey];
      const newRows={...tbl.rows,[rowKey]:parseFloat(value)||0};
      return{...p,[cat]:{...p[cat],tables:{...p[cat].tables,[tblKey]:{...tbl,rows:newRows}}}};
    });
    setHasChanges(true);
  };

  const addTableRow=(cat,tblKey,rowKey)=>{
    if(!rowKey.trim())return;
    setVariables(p=>{
      const tbl=p[cat].tables[tblKey];
      if(tbl.rows[rowKey])return p;
      let newRow;
      if(tbl.type==='multiplier')newRow=1.0;
      else newRow={};
      // Add new row and sort keys alphabetically
      const allRows={...tbl.rows,[rowKey]:newRow};
      const sortedKeys=Object.keys(allRows).sort((a,b)=>a.localeCompare(b));
      const newRows={};
      sortedKeys.forEach(k=>{newRows[k]=allRows[k];});
      return{...p,[cat]:{...p[cat],tables:{...p[cat].tables,[tblKey]:{...tbl,rows:newRows}}}};
    });
    setNewRowKey(p=>({...p,[`${cat}_${tblKey}`]:''}));
    setHasChanges(true);
  };

  const removeTableRow=(cat,tblKey,rowKey)=>{
    setVariables(p=>{
      const tbl=p[cat].tables[tblKey];
      const newRows={...tbl.rows};
      delete newRows[rowKey];
      return{...p,[cat]:{...p[cat],tables:{...p[cat].tables,[tblKey]:{...tbl,rows:newRows}}}};
    });
    setHasChanges(true);
  };
  
  const handleSave=()=>{setSaveVersion(v=>v+1);setHasChanges(false);setShowSaveToast(true);setTimeout(()=>setShowSaveToast(false),2000);logAudit('settings_updated','settings',tab,null,null,`Updated ${tab} settings`);};
  const removeTask=tk=>{setTasks(p=>p.filter(t=>t.key!==tk));setHasChanges(true)};
  const updateTaskFormula=(tk,formula)=>{setTasks(p=>p.map(t=>t.key===tk?{...t,formula}:t));setHasChanges(true)};
  const updateTaskAllocation=(tk,roleAllocation)=>{setTasks(p=>p.map(t=>t.key===tk?{...t,roleAllocation}:t));setHasChanges(true)};
  const updateTaskName=(tk,name)=>{setTasks(p=>p.map(t=>t.key===tk?{...t,name}:t));setHasChanges(true)};
  // For software lookup type: update specific role value within a software row
  const updateTaskLookupValue=(tk,rowKey,value,role)=>{
    setTasks(p=>p.map(t=>{
      if(t.key!==tk||!t.lookupTable)return t;
      const currentRow=t.lookupTable.rows[rowKey]||{};
      const newRow={...currentRow,[role]:parseFloat(value)||0};
      return{...t,lookupTable:{...t.lookupTable,rows:{...t.lookupTable.rows,[rowKey]:newRow}}};
    }));
    setHasChanges(true);
  };
  // For role lookup type: update role minutes directly
  const updateTaskLookupValueByRole=(tk,role,value)=>{
    setTasks(p=>p.map(t=>{
      if(t.key!==tk||!t.lookupTable)return t;
      return{...t,lookupTable:{...t.lookupTable,rows:{...t.lookupTable.rows,[role]:parseFloat(value)||0}}};
    }));
    setHasChanges(true);
  };
  // Toggle between role and software lookup types
  const toggleTaskToSoftware=(tk)=>{
    const softwareList=variables.client?.tables?.software?.options||['Quickbooks Online','Other'];
    setTasks(p=>p.map(t=>{
      if(t.key!==tk||!t.lookupTable)return t;
      // Convert role-based rows to software-based rows
      const roleValues=t.lookupTable.rows;
      const newRows={};
      softwareList.forEach(sw=>{
        newRows[sw]={...roleValues};
      });
      return{...t,lookupType:'software',lookupTable:{...t.lookupTable,rows:newRows}};
    }));
    setHasChanges(true);
  };
  const toggleTaskToRole=(tk)=>{
    setTasks(p=>p.map(t=>{
      if(t.key!==tk||!t.lookupTable)return t;
      // Convert software-based rows to role-based rows (use first software as default)
      const firstSoftware=Object.keys(t.lookupTable.rows)[0];
      const roleValues=t.lookupTable.rows[firstSoftware]||{};
      const newRows={};
      Object.keys(roles).forEach(r=>{
        newRows[r]=roleValues[r]||0;
      });
      return{...t,lookupType:'role',lookupTable:{...t.lookupTable,rows:newRows}};
    }));
    setHasChanges(true);
  };
  const addTaskLookupRow=(tk,rowKey)=>{
    if(!rowKey.trim())return;
    setTasks(p=>p.map(t=>{
      if(t.key!==tk||!t.lookupTable||t.lookupTable.rows[rowKey])return t;
      // For software type, new row is an empty object for roles
      const newRow=t.lookupType==='software'?{}:0;
      return{...t,lookupTable:{...t.lookupTable,rows:{...t.lookupTable.rows,[rowKey]:newRow}}};
    }));
    setNewRowKey(p=>({...p,[`task_${tk}`]:''}));
    setHasChanges(true);
  };
  const removeTaskLookupRow=(tk,rowKey)=>{
    setTasks(p=>p.map(t=>{
      if(t.key!==tk||!t.lookupTable)return t;
      const newRows={...t.lookupTable.rows};
      delete newRows[rowKey];
      return{...t,lookupTable:{...t.lookupTable,rows:newRows}};
    }));
    setHasChanges(true);
  };

  const varCats=Object.entries(variables);
  const curCat=variables[activeVarCat];
  const tasksBySection={};Object.keys(sections).forEach(s=>tasksBySection[s]=[]);tasks.forEach(t=>{if(tasksBySection[t.section])tasksBySection[t.section].push(t)});

  return(
    <div className="max-w-6xl mx-auto space-y-4">
      <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
        <h1 className="text-lg sm:text-xl font-bold text-gray-800">Admin — Settings & Configuration</h1>
        <div className="flex items-center gap-3">
          {hasChanges&&<span className="text-xs sm:text-sm text-gray-600 flex items-center gap-1"><span className="w-2 h-2 bg-gray-1000 rounded-full animate-pulse"></span><span className="hidden sm:inline">Unsaved changes</span></span>}
          <button 
            onClick={handleSave} 
            disabled={!hasChanges}
            className={`px-3 sm:px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 ${hasChanges?'bg-green-600 text-white hover:bg-green-700 shadow-sm':'bg-gray-200 text-gray-400 cursor-not-allowed'}`}
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
            <span className="hidden sm:inline">Save Changes</span><span className="sm:hidden">Save</span>
          </button>
        </div>
      </div>
      <div className="bg-white rounded-lg border border-gray-200 overflow-hidden">
        <div className="flex overflow-x-auto border-b border-gray-200">
          {['profile','settings','rates','tasks','hammertime','security','users'].map(t=>(
            <button key={t} onClick={()=>setTab(t)} className={`px-3 sm:px-5 py-3 font-medium text-xs sm:text-sm capitalize whitespace-nowrap ${tab===t?'text-rh-maroon border-b-2 border-rh-maroon bg-gray-100':'text-gray-500 hover:text-gray-700'}`}>{t==='hammertime'?'HammerTime':t==='profile'?'My Profile':t}</button>
          ))}
        </div>
        <div className="p-5">
          {tab==='profile'&&(
            <div className="max-w-2xl">
              <div className="flex justify-between items-center mb-6">
                <div>
                  <h3 className="font-bold text-gray-800 text-lg">My Profile</h3>
                  <p className="text-sm text-gray-500">Manage your account information</p>
                </div>
                {profileSaved&&<span className="text-green-600 text-sm font-medium">✓ Saved!</span>}
              </div>
              
              {profileLoading?(
                <div className="text-center py-8 text-gray-500">Loading profile...</div>
              ):(
                <div className="space-y-6">
                  {/* Account Info */}
                  <div className="bg-gray-50 rounded-lg p-4">
                    <h4 className="font-semibold text-gray-700 mb-3">Account</h4>
                    <div className="text-sm">
                      <div className="flex justify-between py-2 border-b border-gray-200">
                        <span className="text-gray-500">Email</span>
                        <span className="font-medium">{user?.email}</span>
                      </div>
                      <div className="flex justify-between py-2">
                        <span className="text-gray-500">Member since</span>
                        <span className="font-medium">{user?.created_at ? new Date(user.created_at).toLocaleDateString() : '-'}</span>
                      </div>
                    </div>
                  </div>
                  
                  {/* Personal Info */}
                  <div>
                    <h4 className="font-semibold text-gray-700 mb-3">Personal Information</h4>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                        <input type="text" value={profile.first_name} onChange={e=>setProfile(p=>({...p,first_name:e.target.value}))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rh-maroon focus:border-transparent"/>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                        <input type="text" value={profile.last_name} onChange={e=>setProfile(p=>({...p,last_name:e.target.value}))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rh-maroon focus:border-transparent"/>
                      </div>
                    </div>
                  </div>
                  
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                      <input type="tel" value={profile.phone} onChange={e=>setProfile(p=>({...p,phone:e.target.value}))} placeholder="(555) 123-4567" className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rh-maroon focus:border-transparent"/>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Job Title</label>
                      <input type="text" value={profile.job_title} onChange={e=>setProfile(p=>({...p,job_title:e.target.value}))} placeholder="e.g. Senior Accountant" className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rh-maroon focus:border-transparent"/>
                    </div>
                  </div>
                  
                  {/* Preferences */}
                  <div>
                    <h4 className="font-semibold text-gray-700 mb-3">Preferences</h4>
                    <div className="space-y-3">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Timezone</label>
                        <select value={profile.timezone} onChange={e=>setProfile(p=>({...p,timezone:e.target.value}))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rh-maroon focus:border-transparent">
                          <option value="America/New_York">Eastern Time (ET)</option>
                          <option value="America/Chicago">Central Time (CT)</option>
                          <option value="America/Denver">Mountain Time (MT)</option>
                          <option value="America/Phoenix">Arizona Time (AZ)</option>
                          <option value="America/Los_Angeles">Pacific Time (PT)</option>
                          <option value="America/Anchorage">Alaska Time (AK)</option>
                          <option value="Pacific/Honolulu">Hawaii Time (HI)</option>
                        </select>
                      </div>
                      <div className="flex items-center gap-3">
                        <input type="checkbox" id="notifications" checked={profile.notifications_enabled} onChange={e=>setProfile(p=>({...p,notifications_enabled:e.target.checked}))} className="w-4 h-4 text-rh-maroon rounded focus:ring-rh-maroon"/>
                        <label htmlFor="notifications" className="text-sm text-gray-700">Enable email notifications</label>
                      </div>
                    </div>
                  </div>
                  
                  {/* Save Button */}
                  <div className="pt-4 border-t border-gray-200">
                    <button onClick={saveProfile} disabled={profileSaving} className="px-6 py-2 bg-rh-maroon text-white rounded-lg font-medium hover:bg-rh-maroon-dark disabled:opacity-50 disabled:cursor-not-allowed">
                      {profileSaving?'Saving...':'Save Profile'}
                    </button>
                  </div>
                </div>
              )}
            </div>
          )}
          
          {tab==='rates'&&(
            <div>
              <div className="flex justify-between items-center mb-4">
                <h3 className="font-bold text-gray-800">Rates & Roles</h3>
                <div className="flex items-center gap-2">
                  <input type="text" placeholder="Code" value={newRoleCode} onChange={e=>setNewRoleCode(e.target.value.toUpperCase().slice(0,3))} className="px-2 py-1 border rounded text-sm w-20" maxLength={3}/>
                  <button onClick={addRole} className="flex items-center gap-1 px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700"><PlusIcon/>Add</button>
                </div>
              </div>
              <table className="w-full text-sm">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Code</th>
                    <th className="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Name</th>
                    <th className="px-4 py-2 text-right text-xs font-semibold text-gray-500 uppercase">Cost Rate</th>
                    <th className="px-4 py-2 text-center text-xs font-semibold text-gray-500 uppercase">Color</th>
                    <th className="px-4 py-2 w-12"></th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-100">
                  {Object.entries(roles).map(([c,r])=>(
                    <tr key={c}>
                      <td className="px-4 py-2 font-bold">{c}</td>
                      <td className="px-4 py-2 editable-cell"><input value={r.name} onChange={e=>updateRole(c,'name',e.target.value)} className="w-36"/></td>
                      <td className="px-4 py-2 editable-cell text-right"><input type="number" step="0.01" value={r.cost_rate} onChange={e=>updateRole(c,'cost_rate',e.target.value)} className="text-right w-20"/></td>
                      <td className="px-4 py-2 text-center"><input type="color" value={r.color} onChange={e=>updateRole(c,'color',e.target.value)} className="w-8 h-6 cursor-pointer rounded"/></td>
                      <td className="px-4 py-2 text-center"><button onClick={()=>removeRole(c)} className="text-red-500 hover:text-red-700 p-1"><TrashIcon/></button></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
          
          
          {tab==='tasks'&&(
            <div className="space-y-6">
              {/* Variables Section - Accordion */}
              <div className="border border-gray-200 rounded-lg overflow-hidden">
                <button 
                  onClick={()=>setVariablesExpanded(!variablesExpanded)}
                  className="w-full px-4 py-3 flex items-center justify-between hover:opacity-90 transition-colors cursor-pointer"
                  style={{backgroundColor:'#333'}}
                >
                  <div className="text-left">
                    <h4 className="font-semibold text-white">Quote Variables & Multipliers</h4>
                    <p className="text-xs text-gray-300 mt-1">Configure software options, multipliers, and other variables used in task calculations</p>
                  </div>
                  <svg className={`w-5 h-5 text-white transition-transform ${variablesExpanded?'rotate-180':''}`} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                {variablesExpanded && (
                <div className="p-4">
                  <div className="flex flex-wrap gap-2 mb-4">
                    {varCats.map(([k,cat])=>(
                      <button key={k} onClick={()=>setActiveVarCat(k)} className={`px-3 py-1.5 text-sm font-medium rounded ${activeVarCat===k?'text-white':'text-gray-600 hover:bg-gray-200'}`} style={activeVarCat===k?{backgroundColor:cat.color||'#802629'}:{}}>{cat.label}</button>
                    ))}
                  </div>
                  <div className="space-y-4">
                    {curCat?.tables&&Object.entries(curCat.tables).map(([tblKey,tbl])=>(
                      <div key={tblKey} className="border border-gray-200 rounded-lg overflow-hidden">
                        <div className="flex items-center justify-between px-4 py-2 bg-gray-50 border-b border-gray-200">
                          <h4 className="font-semibold text-gray-700">{tbl.label}</h4>
                          <span className="text-xs px-2 py-0.5 bg-gray-200 text-gray-600 rounded font-mono">{tbl.type}</span>
                        </div>
                        <div className="p-4">
                          {tbl.type==='options'&&(
                            <div className="flex flex-wrap gap-2 items-center">
                              {tbl.options.map(opt=>(
                                <span key={opt} className="inline-flex items-center gap-1 px-2 py-1 bg-red-50 text-rh-maroon rounded text-sm">
                                  {opt}<button onClick={()=>removeOptionFromTable(activeVarCat,tblKey,opt)} className="text-blue-400 hover:text-red-500 ml-1">×</button>
                                </span>
                              ))}
                              <input type="text" placeholder="Add + Enter" className="px-2 py-1 border rounded text-sm w-28" onKeyDown={e=>{if(e.key==='Enter'){addOptionToTable(activeVarCat,tblKey,e.target.value);e.target.value=''}}}/>
                            </div>
                          )}
                          {tbl.type==='multiplier'&&tbl.rows&&(
                            <div>
                              <table className="w-full text-sm table-fixed">
                                <thead className="bg-gray-50">
                                  <tr>
                                    <th className="px-3 py-2 text-left text-xs text-gray-500 font-semibold w-48">Option</th>
                                    <th className="px-3 py-2 text-right text-xs text-gray-500 font-semibold w-32">Multiplier</th>
                                    <th className="w-10"></th>
                                  </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                  {Object.entries(tbl.rows).map(([rowKey,val])=>(
                                    <tr key={rowKey}>
                                      <td className="px-3 py-2 font-medium text-gray-700">{rowKey}</td>
                                      <td className="px-3 py-2 text-right">
                                        <input type="number" step="0.01" value={typeof val==='object'?val.multiplier:val} onChange={e=>updateMultiplierValue(activeVarCat,tblKey,rowKey,e.target.value)} className="w-20 px-2 py-1 border rounded text-sm text-right font-mono"/>
                                        <span className="ml-1 text-gray-500">×</span>
                                      </td>
                                      <td className="px-2"><button onClick={()=>removeTableRow(activeVarCat,tblKey,rowKey)} className="text-red-400 hover:text-red-600 p-1"><TrashIcon/></button></td>
                                    </tr>
                                  ))}
                                </tbody>
                              </table>
                              <div className="mt-2 flex items-center gap-2">
                                <input type="text" placeholder="New option..." value={newRowKey[`${activeVarCat}_${tblKey}`]||''} onChange={e=>setNewRowKey(p=>({...p,[`${activeVarCat}_${tblKey}`]:e.target.value}))} className="px-2 py-1 border rounded text-sm w-40" onKeyDown={e=>{if(e.key==='Enter')addTableRow(activeVarCat,tblKey,newRowKey[`${activeVarCat}_${tblKey}`]||'')}}/>
                                <button onClick={()=>addTableRow(activeVarCat,tblKey,newRowKey[`${activeVarCat}_${tblKey}`]||'')} className="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700 flex items-center gap-1"><PlusIcon/>Add Row</button>
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
                )}
              </div>
              
              {/* Task Catalog Section */}
              <div className="flex justify-between items-center">
                <h3 className="font-bold text-gray-800">Task Catalog: {tasks.length} tasks</h3>
                <div className="flex gap-2">
                  <button onClick={()=>setExpandedSections(new Set(Object.keys(sections)))} className="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded">Expand All</button>
                  <button onClick={()=>setExpandedSections(new Set())} className="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded">Collapse All</button>
                </div>
              </div>
              {Object.entries(tasksBySection).map(([sk,sts])=>{
                const sec=sections[sk];if(!sec||sts.length===0)return null;
                const isExp=expandedSections.has(sk);
                return(
                  <div key={sk} className="border border-gray-200 rounded-lg overflow-hidden">
                    <div className="px-4 py-3 font-semibold text-white text-sm flex items-center gap-2 cursor-pointer" style={{backgroundColor:sec.color}} onClick={()=>toggleSection(sk)}>
                      <span className={`transition-transform ${isExp?'rotate-90':''}`}><ChevronRight/></span>
                      <span>{sec.name}</span>
                      <span className="text-white/70 font-normal">({sts.length})</span>
                    </div>
                    {isExp&&(
                      <div className="divide-y divide-gray-200">
                        {sts.map(t=>(
                          <div key={t.key} className="p-4 space-y-3 bg-white hover:bg-gray-50/50">
                            <div className="flex items-start justify-between pb-2 border-b-2 border-red-100">
                              <div className="flex-1">
                                <input type="text" value={t.name} onChange={e=>updateTaskName(t.key,e.target.value)} className="font-bold text-gray-900 text-lg bg-transparent border-b-2 border-transparent hover:border-gray-300 focus:border-rh-maroon focus:outline-none w-full max-w-md"/>
                                <div className="text-xs text-gray-400 mt-0.5">{toProperCase(t.key)}</div>
                              </div>
                              <div className="flex items-center gap-2">
                                <button onClick={()=>removeTask(t.key)} className="text-red-500 hover:text-red-700 p-1"><TrashIcon/></button>
                              </div>
                            </div>
                            <div>
                              <div className="flex items-center justify-between mb-1">
                                <label className="text-xs font-semibold text-gray-500 uppercase">Formula</label>
                                <button onClick={()=>setFormulaBuilderTask(t)} className="px-3 py-1 bg-rh-maroon text-white rounded text-xs hover:bg-rh-maroon-dark flex items-center gap-1"><EditIcon/> Edit Formula</button>
                              </div>
                              <code className="block text-xs text-gray-600 bg-gray-100 px-3 py-2 rounded font-mono">{t.formula}</code>
                              {t.lookupType&&t.lookupTable&&(
                                <div className="mt-1 text-xs bg-red-50 px-3 py-1.5 rounded border border-red-100">
                                  <span className="font-medium text-blue-700">{t.lookupTable.key}</span>
                                  <span className="mx-1 text-gray-500">=</span>
                                  <span className="text-rh-maroon">
                                    {t.lookupType==='role'?'LOOKUP(role → value)':`LOOKUP(${t.lookupType} + role → value)`}
                                  </span>
                                </div>
                              )}
                            </div>
                            {t.lookupTable&&(
                              <div className="border border-gray-200 rounded-lg overflow-hidden">
                                <div className="px-3 py-2 bg-gray-50 border-b border-gray-200 flex items-center justify-between">
                                  <div>
                                    <span className="font-semibold text-gray-700 text-sm">{t.lookupTable.label}</span>
                                    <span className="text-xs text-gray-500 ml-2">→ <code className="bg-gray-200 px-1 rounded">{t.lookupTable.key}</code></span>
                                  </div>
                                  <div className="flex items-center gap-2">
                                    {t.lookupType==='role'?(
                                      <button onClick={()=>toggleTaskToSoftware(t.key)} className="text-xs px-2 py-1 bg-red-100 text-rh-maroon hover:bg-red-200 rounded font-medium" title="Convert to software-specific values">
                                        → By Software
                                      </button>
                                    ):t.lookupType==='software'?(
                                      <button onClick={()=>toggleTaskToRole(t.key)} className="text-xs px-2 py-1 bg-gray-200 text-green-700 hover:bg-gray-300 rounded font-medium" title="Convert to role-only values">
                                        → By Role
                                      </button>
                                    ):null}
                                    <span className="text-xs px-2 py-0.5 rounded font-medium" style={{
                                      backgroundColor:t.lookupType==='role'?'#D1FAE5':t.lookupType==='software'?'#DBEAFE':'#FEF3C7',
                                      color:t.lookupType==='role'?'#047857':t.lookupType==='software'?'#1D4ED8':'#B45309'
                                    }}>
                                      {t.lookupType==='role'?'By Role':t.lookupType==='software'?'By Software':`By ${t.lookupType.split('_').map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' ')}`}
                                    </span>
                                  </div>
                                </div>
                                {t.lookupType==='role'?(
                                  <div>
                                    <table className="w-full text-sm">
                                      <thead className="bg-gray-50">
                                        <tr>
                                          <th className="px-3 py-2 text-left text-xs text-gray-500 font-semibold">Role</th>
                                          <th className="px-3 py-2 text-right text-xs text-gray-500 font-semibold w-32">Value</th>
                                        </tr>
                                      </thead>
                                      <tbody className="divide-y divide-gray-100">
                                        {Object.keys(roles).map(r=>(
                                          <tr key={r}>
                                            <td className="px-3 py-2 font-medium" style={{color:roles[r].color}}>{r} - {roles[r].name}</td>
                                            <td className="px-3 py-2 text-right">
                                              <input type="number" step="0.1" value={t.lookupTable.rows?.[r]||''} onChange={e=>updateTaskLookupValueByRole(t.key,r,e.target.value)} placeholder="-" className="w-20 px-2 py-1 border rounded text-sm text-right font-mono"/>
                                            </td>
                                          </tr>
                                        ))}
                                      </tbody>
                                    </table>
                                  </div>
                                ):t.lookupType==='software'?(
                                  <div>
                                    <table className="w-full text-sm">
                                      <thead className="bg-gray-50">
                                        <tr>
                                          <th className="px-3 py-2 text-left text-xs text-gray-500 font-semibold">Software</th>
                                          {Object.keys(roles).map(r=><th key={r} className="px-2 py-2 text-center text-xs font-semibold w-16" style={{color:roles[r].color}}>{r}</th>)}
                                          <th className="w-10"></th>
                                        </tr>
                                      </thead>
                                      <tbody className="divide-y divide-gray-100">
                                        {Object.entries(t.lookupTable.rows||{}).map(([rowKey,roleVals])=>(
                                          <tr key={rowKey}>
                                            <td className="px-3 py-2 text-gray-700 font-medium">{rowKey}</td>
                                            {Object.keys(roles).map(r=>(
                                              <td key={r} className="px-1 py-2 text-center">
                                                <input type="number" step="0.1" value={roleVals?.[r]||''} onChange={e=>updateTaskLookupValue(t.key,rowKey,e.target.value,r)} placeholder="-" className="w-14 px-1 py-1 border rounded text-xs text-center font-mono"/>
                                              </td>
                                            ))}
                                            <td className="px-2"><button onClick={()=>removeTaskLookupRow(t.key,rowKey)} className="text-red-400 hover:text-red-600 p-1"><TrashIcon/></button></td>
                                          </tr>
                                        ))}
                                      </tbody>
                                    </table>
                                    <div className="px-3 py-2 border-t border-gray-100 flex items-center gap-2">
                                      <input type="text" placeholder="New software..." value={newRowKey[`task_${t.key}`]||''} onChange={e=>setNewRowKey(p=>({...p,[`task_${t.key}`]:e.target.value}))} className="px-2 py-1 border rounded text-sm w-40" onKeyDown={e=>{if(e.key==='Enter')addTaskLookupRow(t.key,newRowKey[`task_${t.key}`]||'')}}/>
                                      <button onClick={()=>addTaskLookupRow(t.key,newRowKey[`task_${t.key}`]||'')} className="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700 flex items-center gap-1"><PlusIcon/>Add</button>
                                    </div>
                                  </div>
                                ):(
                                  <div>
                                    <table className="w-full text-sm">
                                      <thead className="bg-gray-50">
                                        <tr>
                                          <th className="px-3 py-2 text-left text-xs text-gray-500 font-semibold">
                                            {t.lookupType.split('_').map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' ')}
                                          </th>
                                          {Object.keys(roles).map(r=><th key={r} className="px-2 py-2 text-center text-xs font-semibold w-16" style={{color:roles[r].color}}>{r}</th>)}
                                        </tr>
                                      </thead>
                                      <tbody className="divide-y divide-gray-100">
                                        {Object.entries(t.lookupTable.rows||{}).map(([rowKey,roleVals])=>(
                                          <tr key={rowKey}>
                                            <td className="px-3 py-2 text-gray-700 font-medium">{rowKey}</td>
                                            {Object.keys(roles).map(r=>(
                                              <td key={r} className="px-1 py-2 text-center">
                                                <input type="number" step="0.1" value={roleVals?.[r]||''} onChange={e=>updateTaskLookupValue(t.key,rowKey,e.target.value,r)} placeholder="-" className="w-14 px-1 py-1 border rounded text-xs text-center font-mono"/>
                                              </td>
                                            ))}
                                          </tr>
                                        ))}
                                      </tbody>
                                    </table>
                                  </div>
                                )}
                              </div>
                            )}
                            {!t.lookupType&&(
                              <div>
                                <label className="text-xs font-semibold text-gray-500 uppercase block mb-1">Role Allocation</label>
                                <RoleAllocationEditor allocation={t.roleAllocation} roles={roles} onChange={a=>updateTaskAllocation(t.key,a)}/>
                              </div>
                            )}
                            
                            {/* HammerTime Mapping */}
                            <div className="mt-4 pt-4 border-t border-gray-200">
                              <label className="text-xs font-semibold text-gray-500 uppercase block mb-2">HammerTime Task Mapping</label>
                              <div className="grid grid-cols-5 gap-2">
                                {Object.keys(roles).map(r=>(
                                  <div key={r}>
                                    <label className="text-xs text-gray-500 block mb-1">{r}</label>
                                    <select 
                                      value={t.hammerTimeMapping?.[r]||''} 
                                      onChange={e=>{
                                        const val=e.target.value;
                                        setTasks(p=>p.map(task=>task.key===t.key?{...task,hammerTimeMapping:{...(task.hammerTimeMapping||{}), [r]:val}}:task));
                                        setHasChanges(true);
                                      }}
                                      className="w-full px-2 py-1 border border-gray-200 rounded text-xs"
                                    >
                                      <option value="">None</option>
                                      {hammertimeTasks.map(ht=>(
                                        <option key={ht.id} value={ht.id}>{ht.id} - {ht.task.replace(/^[A-Z]{2} - /,'')}</option>
                                      ))}
                                    </select>
                                  </div>
                                ))}
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          )}
          
          {tab==='hammertime'&&(
            <div>
              <div className="flex items-center justify-between mb-4">
                <div>
                  <h3 className="font-bold text-gray-800">HammerTime Tasks</h3>
                  <p className="text-sm text-gray-500">Manage task codes for time tracking integration.</p>
                </div>
                <div className="text-sm text-gray-500">{hammertimeTasks.length} tasks</div>
              </div>
              
              {/* Filters and Add New */}
              <div className="flex items-center gap-4 mb-4 pb-4 border-b border-gray-200">
                <div className="flex-1">
                  <input type="text" placeholder="Search tasks..." value={htFilter} onChange={e=>setHtFilter(e.target.value)} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"/>
                </div>
                <div>
                  <select value={htModuleFilter} onChange={e=>setHtModuleFilter(e.target.value)} className="px-3 py-2 border border-gray-200 rounded-lg text-sm">
                    <option value="">All Modules</option>
                    {[...new Set(hammertimeTasks.map(t=>t.module))].sort().map(m=>(
                      <option key={m} value={m}>{m}</option>
                    ))}
                  </select>
                </div>
              </div>
              
              {/* Add New Task Form */}
              <div className="bg-gray-100 border border-green-200 rounded-lg p-4 mb-4">
                <div className="text-sm font-semibold text-gray-700 mb-3">Add New Task</div>
                <div className="flex items-center gap-3">
                  <input type="text" placeholder="Task ID (e.g. AP.100)" value={newHtTask.id} onChange={e=>setNewHtTask(p=>({...p,id:e.target.value}))} className="w-32 px-3 py-2 border border-gray-200 rounded text-sm"/>
                  <input type="text" placeholder="Task Name" value={newHtTask.task} onChange={e=>setNewHtTask(p=>({...p,task:e.target.value}))} className="flex-1 px-3 py-2 border border-gray-200 rounded text-sm"/>
                  <input type="text" placeholder="Module" value={newHtTask.module} onChange={e=>setNewHtTask(p=>({...p,module:e.target.value.toUpperCase()}))} className="w-20 px-3 py-2 border border-gray-200 rounded text-sm uppercase"/>
                  <button onClick={()=>{
                    if(!newHtTask.id.trim()||!newHtTask.task.trim()||!newHtTask.module.trim())return;
                    setHammertimeTasks(p=>[...p,{...newHtTask}]);
                    setNewHtTask({id:'',task:'',module:''});
                    setHasChanges(true);
                  }} className="px-4 py-2 bg-rh-maroon text-white rounded-lg text-sm font-medium hover:bg-rh-maroon-dark">
                    Add Task
                  </button>
                </div>
              </div>
              
              {/* Tasks Table */}
              <div className="border border-gray-200 rounded-lg overflow-hidden">
                <table className="w-full text-sm">
                  <thead className="bg-gray-50 border-b border-gray-200">
                    <tr>
                      <th className="px-4 py-3 text-left font-semibold text-gray-600 w-32">Task ID</th>
                      <th className="px-4 py-3 text-left font-semibold text-gray-600">Task Name</th>
                      <th className="px-4 py-3 text-left font-semibold text-gray-600 w-24">Module</th>
                      <th className="px-4 py-3 text-center font-semibold text-gray-600 w-24">Actions</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-100">
                    {hammertimeTasks
                      .filter(t=>(!htFilter||t.id.toLowerCase().includes(htFilter.toLowerCase())||t.task.toLowerCase().includes(htFilter.toLowerCase()))&&(!htModuleFilter||t.module===htModuleFilter))
                      .map((t,idx)=>(
                        <tr key={t.id+idx} className="hover:bg-gray-50">
                          {editingHtTask===t.id+idx?(
                            <>
                              <td className="px-4 py-2">
                                <input type="text" value={t.id} onChange={e=>{const v=e.target.value;setHammertimeTasks(p=>p.map((x,i)=>i===idx?{...x,id:v}:x));setHasChanges(true)}} className="w-full px-2 py-1 border rounded text-sm"/>
                              </td>
                              <td className="px-4 py-2">
                                <input type="text" value={t.task} onChange={e=>{const v=e.target.value;setHammertimeTasks(p=>p.map((x,i)=>i===idx?{...x,task:v}:x));setHasChanges(true)}} className="w-full px-2 py-1 border rounded text-sm"/>
                              </td>
                              <td className="px-4 py-2">
                                <input type="text" value={t.module} onChange={e=>{const v=e.target.value.toUpperCase();setHammertimeTasks(p=>p.map((x,i)=>i===idx?{...x,module:v}:x));setHasChanges(true)}} className="w-full px-2 py-1 border rounded text-sm uppercase"/>
                              </td>
                              <td className="px-4 py-2 text-center">
                                <button onClick={()=>setEditingHtTask(null)} className="px-3 py-1 bg-rh-maroon text-white rounded text-xs font-medium hover:bg-rh-maroon-dark">Done</button>
                              </td>
                            </>
                          ):(
                            <>
                              <td className="px-4 py-2 font-medium text-gray-700">{t.id}</td>
                              <td className="px-4 py-2 text-gray-600">{t.task}</td>
                              <td className="px-4 py-2">
                                <span className="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs font-medium">{t.module}</span>
                              </td>
                              <td className="px-4 py-2 text-center">
                                <div className="flex items-center justify-center gap-2">
                                  <button onClick={()=>setEditingHtTask(t.id+idx)} className="p-1 text-rh-maroon hover:bg-red-50 rounded" title="Edit">
                                    <EditIcon/>
                                  </button>
                                  <button onClick={()=>{setHammertimeTasks(p=>p.filter((_,i)=>i!==idx));setHasChanges(true)}} className="p-1 text-red-600 hover:bg-red-50 rounded" title="Delete">
                                    <TrashIcon/>
                                  </button>
                                </div>
                              </td>
                            </>
                          )}
                        </tr>
                      ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}
          
          {tab==='settings'&&(
            <div className="space-y-6">
              <div>
                <h3 className="font-bold text-gray-800 mb-2">Quote Builder Settings</h3>
                <p className="text-sm text-gray-500 mb-6">Configure global settings for the quote builder.</p>
              </div>
              
              {/* Service Levels */}
              <div className="border border-gray-200 rounded-lg overflow-hidden mb-6">
                <div className="px-4 py-3 bg-gray-50 border-b border-gray-200">
                  <h4 className="font-semibold text-gray-700">Service Levels</h4>
                  <p className="text-xs text-gray-500 mt-1">Configure the names and colors for each service level tier</p>
                </div>
                <div className="p-4">
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    {[1,2,3].map(l=>(
                      <div key={l} className="border-2 rounded-lg overflow-hidden" style={{borderColor:levels[l].color}}>
                        <div className="px-3 py-2 text-white font-semibold text-sm" style={{backgroundColor:levels[l].color}}>
                          Level {l}
                        </div>
                        <div className="p-3 space-y-3" style={{backgroundColor:levels[l].bgColor}}>
                          <div>
                            <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Name</label>
                            <input type="text" value={levels[l].name} onChange={e=>updateLevel(l,'name',e.target.value)} className="w-full px-2 py-1.5 border rounded text-sm font-medium"/>
                          </div>
                          <div className="grid grid-cols-2 gap-2">
                            <div>
                              <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Color</label>
                              <div className="flex items-center gap-1">
                                <input type="color" value={levels[l].color} onChange={e=>updateLevel(l,'color',e.target.value)} className="w-8 h-7 cursor-pointer rounded border"/>
                                <input type="text" value={levels[l].color} onChange={e=>updateLevel(l,'color',e.target.value)} className="flex-1 px-1 py-1 border rounded text-xs font-mono w-16"/>
                              </div>
                            </div>
                            <div>
                              <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Background</label>
                              <div className="flex items-center gap-1">
                                <input type="color" value={levels[l].bgColor} onChange={e=>updateLevel(l,'bgColor',e.target.value)} className="w-8 h-7 cursor-pointer rounded border"/>
                                <input type="text" value={levels[l].bgColor} onChange={e=>updateLevel(l,'bgColor',e.target.value)} className="flex-1 px-1 py-1 border rounded text-xs font-mono w-16"/>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
              
              {/* Quote Status Settings */}
              <div className="border border-gray-200 rounded-lg overflow-hidden mb-6">
                <div className="px-4 py-3 bg-gray-50 border-b border-gray-200">
                  <h4 className="font-semibold text-gray-700">Quote Statuses</h4>
                  <p className="text-xs text-gray-500 mt-1">Available status options for quotes</p>
                </div>
                <div className="p-4">
                  <div className="flex flex-wrap gap-3">
                    <div className="flex items-center gap-2 px-3 py-2 bg-yellow-500 rounded-lg">
                      <span className="w-3 h-3 bg-white rounded-full"></span>
                      <span className="text-sm font-medium text-white">Draft</span>
                      <span className="text-xs text-yellow-100">(Default)</span>
                    </div>
                    <div className="flex items-center gap-2 px-3 py-2 bg-green-600 rounded-lg">
                      <span className="w-3 h-3 bg-white rounded-full"></span>
                      <span className="text-sm font-medium text-white">Final</span>
                    </div>
                    <div className="flex items-center gap-2 px-3 py-2 bg-blue-600 rounded-lg">
                      <span className="w-3 h-3 bg-white rounded-full"></span>
                      <span className="text-sm font-medium text-white">Change Order</span>
                    </div>
                  </div>
                  <p className="text-xs text-gray-500 mt-3">Status is selected when saving a quote. Versions are tracked automatically.</p>
                </div>
              </div>
              
              {/* Industries Settings */}
              <div className="border border-gray-200 rounded-lg overflow-hidden mb-6">
                <div className="px-4 py-3 bg-gray-50 border-b border-gray-200 flex items-center justify-between">
                  <div>
                    <h4 className="font-semibold text-gray-700">Construction Industries</h4>
                    <p className="text-xs text-gray-500 mt-1">Industry options available when adding customers ({industries?.length||0} industries)</p>
                  </div>
                  <button 
                    onClick={()=>setIndustries(DEFAULT_INDUSTRIES)}
                    className="text-xs text-blue-600 hover:text-gray-700"
                  >
                    Reset to Default
                  </button>
                </div>
                <div className="p-4">
                  <div className="flex gap-2 mb-3">
                    <input 
                      type="text" 
                      id="newIndustryInput"
                      placeholder="Add new industry..."
                      className="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
                      onKeyDown={e=>{
                        if(e.key==='Enter'&&e.target.value.trim()){
                          const newInd=e.target.value.trim();
                          if(!industries.includes(newInd)){
                            // Add after the first 4 (primary contractors) in alphabetical order
                            const primary=industries.slice(0,4);
                            const rest=[...industries.slice(4),newInd].sort();
                            setIndustries([...primary,...rest]);
                            setHasChanges(true);
                          }
                          e.target.value='';
                        }
                      }}
                    />
                    <button 
                      onClick={()=>{
                        const input=document.getElementById('newIndustryInput');
                        const newInd=input.value.trim();
                        if(newInd&&!industries.includes(newInd)){
                          const primary=industries.slice(0,4);
                          const rest=[...industries.slice(4),newInd].sort();
                          setIndustries([...primary,...rest]);
                          setHasChanges(true);
                          input.value='';
                        }
                      }}
                      className="px-3 py-2 text-white rounded-lg text-sm font-medium"
                      style={{backgroundColor:'#802629'}}
                    >
                      Add
                    </button>
                  </div>
                  <div className="max-h-64 overflow-y-auto bg-gray-50 rounded-lg p-3 mb-3">
                    <div className="space-y-1">
                      {(industries||DEFAULT_INDUSTRIES).map((ind,i)=>(
                        <div key={i} className="flex items-center justify-between py-1 px-2 hover:bg-white rounded group">
                          <div className="flex items-center gap-2">
                            <span className={`w-1.5 h-1.5 rounded-full ${i<4?'bg-gray-600':'bg-gray-400'}`}></span>
                            <span className="text-sm text-gray-700">{ind}</span>
                            {i<4 && <span className="text-xs text-blue-500">(Primary)</span>}
                          </div>
                          {i>=4 && (
                            <button 
                              onClick={()=>{
                                setIndustries(industries.filter((_,idx)=>idx!==i));
                                setHasChanges(true);
                              }}
                              className="text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100 text-xs"
                            >
                              Remove
                            </button>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                  <p className="text-xs text-gray-500">Primary contractors (first 4) cannot be removed. New industries are added alphabetically after primary contractors.</p>
                </div>
              </div>
              
              {/* Flex Tasks Settings */}
              <div className="border border-gray-200 rounded-lg overflow-hidden">
                <div className="px-4 py-3 bg-gray-50 border-b border-gray-200">
                  <h4 className="font-semibold text-gray-700">Flex Tasks</h4>
                  <p className="text-xs text-gray-500 mt-1">Allow ad-hoc tasks with manual hours in each section</p>
                </div>
                <div className="p-4 space-y-4">
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="font-medium text-gray-700">Enable Flex Tasks</div>
                      <div className="text-xs text-gray-500">Show "Add Flex Task" button in each quote section</div>
                    </div>
                    <button 
                      onClick={()=>{setSettings(p=>({...p,enableFlexTasks:!p.enableFlexTasks}));setHasChanges(true)}}
                      className={`relative w-12 h-6 rounded-full transition-colors ${settings.enableFlexTasks?'bg-rh-maroon':'bg-gray-300'}`}
                    >
                      <span className={`absolute top-1 w-4 h-4 bg-white rounded-full shadow transition-transform ${settings.enableFlexTasks?'left-7':'left-1'}`}></span>
                    </button>
                  </div>
                  
                  <div className="pt-4 border-t border-gray-100">
                    <label className="block text-sm font-medium text-gray-700 mb-2">Default HammerTime Task Code</label>
                    <select 
                      value={settings.defaultFlexHammerTime} 
                      onChange={e=>{setSettings(p=>({...p,defaultFlexHammerTime:e.target.value}));setHasChanges(true)}}
                      className="w-full max-w-md px-3 py-2 border border-gray-200 rounded-lg text-sm"
                    >
                      {hammertimeTasks.filter(t=>t.module==='OH'||t.id.includes('AD.')).map(t=>(
                        <option key={t.id} value={t.id}>{t.id} - {t.task}</option>
                      ))}
                    </select>
                    <p className="text-xs text-gray-500 mt-2">This HammerTime code will be used for flex tasks by default</p>
                  </div>
                </div>
              </div>
              
              {/* Overhead Defaults */}
              <div className="border border-gray-200 rounded-lg overflow-hidden">
                <div className="px-4 py-3 bg-gray-50 border-b border-gray-200">
                  <h4 className="font-semibold text-gray-700">Overhead Defaults</h4>
                  <p className="text-xs text-gray-500 mt-1">Default overhead tasks are configured in the Tasks tab under the OH section</p>
                </div>
                <div className="p-4">
                  <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div className="flex items-start gap-3">
                      <svg className="w-5 h-5 text-rh-maroon flex-shrink-0 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                      <div>
                        <div className="font-medium text-gray-800">Overhead (OH) Section</div>
                        <div className="text-sm text-gray-600 mt-1">
                          The Overhead section includes tasks for meetings, communication, training, and buffer time. 
                          These tasks help ensure you're capturing all the time spent on client engagements.
                        </div>
                        <div className="mt-3">
                          <button onClick={()=>setTab('tasks')} className="text-sm text-rh-maroon font-medium hover:underline">
                            → Edit OH tasks in Tasks tab
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}
          
          {tab==='security'&&(
            <div>
              <h3 className="font-bold text-gray-800 mb-4">Security & Permissions</h3>
              <p className="text-sm text-gray-500 mb-6">Control what team members can view and edit in the quote builder.</p>
              
              <div className="space-y-6">
                {/* Role Permissions */}
                <div className="border border-gray-200 rounded-lg overflow-hidden">
                  <div className="px-4 py-3 bg-gray-50 border-b border-gray-200">
                    <h4 className="font-semibold text-gray-700">Role Permissions</h4>
                    <p className="text-xs text-gray-500 mt-1">Define what each role can access</p>
                  </div>
                  <div className="p-4">
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="border-b border-gray-200">
                          <th className="text-left py-2 font-semibold text-gray-600">Permission</th>
                          <th className="text-center py-2 font-semibold text-gray-600">Viewer</th>
                          <th className="text-center py-2 font-semibold text-gray-600">Member</th>
                          <th className="text-center py-2 font-semibold text-gray-600">Admin</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-100">
                        <tr>
                          <td className="py-3">View Quotes</td>
                          <td className="text-center"><input type="checkbox" checked disabled className="w-4 h-4 accent-rh-maroon"/></td>
                          <td className="text-center"><input type="checkbox" checked disabled className="w-4 h-4 accent-rh-maroon"/></td>
                          <td className="text-center"><input type="checkbox" checked disabled className="w-4 h-4 accent-rh-maroon"/></td>
                        </tr>
                        <tr>
                          <td className="py-3">Edit Quotes</td>
                          <td className="text-center"><input type="checkbox" className="w-4 h-4 accent-rh-maroon"/></td>
                          <td className="text-center"><input type="checkbox" checked className="w-4 h-4 accent-rh-maroon"/></td>
                          <td className="text-center"><input type="checkbox" checked disabled className="w-4 h-4 accent-rh-maroon"/></td>
                        </tr>
                        <tr>
                          <td className="py-3">View Cost Rates</td>
                          <td className="text-center"><input type="checkbox" className="w-4 h-4 accent-rh-maroon"/></td>
                          <td className="text-center"><input type="checkbox" className="w-4 h-4 accent-rh-maroon"/></td>
                          <td className="text-center"><input type="checkbox" checked disabled className="w-4 h-4 accent-rh-maroon"/></td>
                        </tr>
                        <tr>
                          <td className="py-3">View Margins</td>
                          <td className="text-center"><input type="checkbox" className="w-4 h-4 accent-rh-maroon"/></td>
                          <td className="text-center"><input type="checkbox" checked className="w-4 h-4 accent-rh-maroon"/></td>
                          <td className="text-center"><input type="checkbox" checked disabled className="w-4 h-4 accent-rh-maroon"/></td>
                        </tr>
                        <tr>
                          <td className="py-3">Edit Margins</td>
                          <td className="text-center"><input type="checkbox" className="w-4 h-4 accent-rh-maroon"/></td>
                          <td className="text-center"><input type="checkbox" className="w-4 h-4 accent-rh-maroon"/></td>
                          <td className="text-center"><input type="checkbox" checked disabled className="w-4 h-4 accent-rh-maroon"/></td>
                        </tr>
                        <tr>
                          <td className="py-3">Add Comments</td>
                          <td className="text-center"><input type="checkbox" checked className="w-4 h-4 accent-rh-maroon"/></td>
                          <td className="text-center"><input type="checkbox" checked className="w-4 h-4 accent-rh-maroon"/></td>
                          <td className="text-center"><input type="checkbox" checked disabled className="w-4 h-4 accent-rh-maroon"/></td>
                        </tr>
                        <tr>
                          <td className="py-3">Access Admin Settings</td>
                          <td className="text-center"><input type="checkbox" disabled className="w-4 h-4 accent-rh-maroon"/></td>
                          <td className="text-center"><input type="checkbox" className="w-4 h-4 accent-rh-maroon"/></td>
                          <td className="text-center"><input type="checkbox" checked disabled className="w-4 h-4 accent-rh-maroon"/></td>
                        </tr>
                        <tr>
                          <td className="py-3">Invite Team Members</td>
                          <td className="text-center"><input type="checkbox" disabled className="w-4 h-4 accent-rh-maroon"/></td>
                          <td className="text-center"><input type="checkbox" className="w-4 h-4 accent-rh-maroon"/></td>
                          <td className="text-center"><input type="checkbox" checked disabled className="w-4 h-4 accent-rh-maroon"/></td>
                        </tr>
                        <tr>
                          <td className="py-3">Export Reports</td>
                          <td className="text-center"><input type="checkbox" className="w-4 h-4 accent-rh-maroon"/></td>
                          <td className="text-center"><input type="checkbox" checked className="w-4 h-4 accent-rh-maroon"/></td>
                          <td className="text-center"><input type="checkbox" checked disabled className="w-4 h-4 accent-rh-maroon"/></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
                
                {/* Section Visibility */}
                <div className="border border-gray-200 rounded-lg overflow-hidden">
                  <div className="px-4 py-3 bg-gray-50 border-b border-gray-200">
                    <h4 className="font-semibold text-gray-700">Section Visibility</h4>
                    <p className="text-xs text-gray-500 mt-1">Choose which sections are visible by default</p>
                  </div>
                  <div className="p-4">
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                      {Object.values(DEFAULT_SECTIONS).map(sec=>(
                        <label key={sec.key} className="flex items-center gap-2 cursor-pointer">
                          <input type="checkbox" defaultChecked className="w-4 h-4 accent-rh-maroon"/>
                          <span className="w-3 h-3 rounded" style={{backgroundColor:sec.color}}></span>
                          <span className="text-sm text-gray-700">{sec.name}</span>
                        </label>
                      ))}
                    </div>
                  </div>
                </div>
                
                {/* Data Protection */}
                <div className="border border-gray-200 rounded-lg overflow-hidden">
                  <div className="px-4 py-3 bg-gray-50 border-b border-gray-200">
                    <h4 className="font-semibold text-gray-700">Data Protection</h4>
                    <p className="text-xs text-gray-500 mt-1">Additional security settings</p>
                  </div>
                  <div className="p-4 space-y-4">
                    <div className="flex items-center justify-between">
                      <div>
                        <div className="font-medium text-gray-700">Hide Cost Rates from Non-Admins</div>
                        <div className="text-xs text-gray-500">Cost rates will only be visible to admins and owners</div>
                      </div>
                      <button className="relative w-12 h-6 rounded-full transition-colors bg-gray-300">
                        <span className="absolute top-1 left-1 w-4 h-4 bg-white rounded-full shadow transition-transform"></span>
                      </button>
                    </div>
                    <div className="flex items-center justify-between">
                      <div>
                        <div className="font-medium text-gray-700">Require Approval for Quote Changes</div>
                        <div className="text-xs text-gray-500">Changes by non-admins require admin approval</div>
                      </div>
                      <button className="relative w-12 h-6 rounded-full transition-colors bg-gray-300">
                        <span className="absolute top-1 left-1 w-4 h-4 bg-white rounded-full shadow transition-transform"></span>
                      </button>
                    </div>
                    <div className="flex items-center justify-between">
                      <div>
                        <div className="font-medium text-gray-700">Enable Audit Log</div>
                        <div className="text-xs text-gray-500">Track all changes made to quotes and settings</div>
                      </div>
                      <button className="relative w-12 h-6 rounded-full transition-colors bg-rh-maroon">
                        <span className="absolute top-1 left-7 w-4 h-4 bg-white rounded-full shadow transition-transform"></span>
                      </button>
                    </div>
                  </div>
                </div>
                
                {/* Audit Log Viewer */}
                <div className="border border-gray-200 rounded-lg overflow-hidden">
                  <div className="px-4 py-3 bg-gray-50 border-b border-gray-200 flex items-center justify-between">
                    <div>
                      <h4 className="font-semibold text-gray-700">Audit Log</h4>
                      <p className="text-xs text-gray-500 mt-1">Recent activity and changes ({auditLog.length} entries)</p>
                    </div>
                    {auditLog.length>0&&(
                      <button onClick={()=>setAuditLog([])} className="text-xs text-red-600 hover:text-red-800">Clear Log</button>
                    )}
                  </div>
                  <div className="max-h-96 overflow-y-auto">
                    {auditLog.length===0?(
                      <div className="p-8 text-center text-gray-400">
                        <svg className="w-12 h-12 mx-auto mb-3 text-gray-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                        <p>No activity recorded yet</p>
                        <p className="text-xs mt-1">Actions like saving quotes, adding comments, and inviting team members will appear here</p>
                      </div>
                    ):(
                      <table className="w-full text-sm">
                        <thead className="bg-gray-50 sticky top-0">
                          <tr>
                            <th className="text-left px-4 py-2 font-semibold text-gray-600">Time</th>
                            <th className="text-left px-4 py-2 font-semibold text-gray-600">User</th>
                            <th className="text-left px-4 py-2 font-semibold text-gray-600">Action</th>
                            <th className="text-left px-4 py-2 font-semibold text-gray-600">Details</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-100">
                          {auditLog.map(entry=>(
                            <tr key={entry.id} className="hover:bg-gray-50">
                              <td className="px-4 py-2 text-gray-500 whitespace-nowrap">
                                {new Date(entry.createdAt).toLocaleString()}
                              </td>
                              <td className="px-4 py-2">
                                <div className="flex items-center gap-2">
                                  <span className="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-xs font-medium">
                                    {(entry.userEmail||'?')[0].toUpperCase()}
                                  </span>
                                  <span className="text-gray-700 truncate max-w-[120px]">{entry.userEmail}</span>
                                </div>
                              </td>
                              <td className="px-4 py-2">
                                <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${
                                  entry.action.includes('created')?'bg-gray-200 text-gray-700':
                                  entry.action.includes('deleted')?'bg-red-600 text-white':
                                  entry.action.includes('updated')?'bg-gray-200 text-gray-700':
                                  entry.action.includes('comment')?'bg-gray-200 text-gray-700':
                                  entry.action.includes('invite')?'bg-gray-200 text-gray-700':
                                  'bg-gray-100 text-gray-800'
                                }`}>
                                  {entry.action.replace(/_/g,' ')}
                                </span>
                              </td>
                              <td className="px-4 py-2 text-gray-600 truncate max-w-[250px]" title={entry.details}>
                                {entry.details}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    )}
                  </div>
                </div>
              </div>
            </div>
          )}
          
          {tab==='users'&&(
            <div className="space-y-6">
              {/* Toast Notification */}
              {userToast&&(
                <div className={`fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 animate-slide-in ${
                  userToast.type==='success'?'bg-green-600 text-white':'bg-red-600 text-white'
                }`}>
                  {userToast.type==='success'?(
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                  ):(
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                  )}
                  <span className="font-medium">{userToast.message}</span>
                  <button onClick={()=>setUserToast(null)} className="ml-2 hover:opacity-80">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                  </button>
                </div>
              )}
              
              <div>
                <h3 className="font-bold text-gray-800 mb-2">User Management</h3>
                <p className="text-sm text-gray-500 mb-6">Manage team members and their access to the platform.</p>
              </div>
              
              {/* Invite User */}
              <div className="border border-gray-200 rounded-lg overflow-hidden">
                <div className="px-4 py-3 bg-gray-50 border-b border-gray-200">
                  <h4 className="font-semibold text-gray-700">Invite New User</h4>
                </div>
                <div className="p-4">
                  <div className="flex gap-3 flex-wrap">
                    <input 
                      type="email" 
                      placeholder="Email address" 
                      value={inviteEmail}
                      onChange={e=>setInviteEmail(e.target.value)}
                      className="flex-1 min-w-[200px] px-3 py-2 border border-gray-200 rounded-lg text-sm"
                    />
                    <select value={inviteRole} onChange={e=>setInviteRole(e.target.value)} className="px-3 py-2 border border-gray-200 rounded-lg text-sm">
                      <option value="Viewer">Viewer - Can view quotes only</option>
                      <option value="Editor">Editor - Can create and edit quotes</option>
                      <option value="Admin">Admin - Full access</option>
                    </select>
                    <button 
                      onClick={inviteUser}
                      className="px-4 py-2 text-white rounded-lg font-medium hover:opacity-90"
                      style={{backgroundColor:'#802629'}}
                    >
                      Send Invite
                    </button>
                  </div>
                </div>
              </div>
              
              {/* Current Users */}
              <div className="border border-gray-200 rounded-lg overflow-hidden">
                <div className="px-4 py-3 bg-gray-50 border-b border-gray-200">
                  <h4 className="font-semibold text-gray-700">Team Members</h4>
                  <p className="text-xs text-gray-500 mt-1">Users with access to this workspace</p>
                </div>
                {teamLoading?(
                  <div className="p-8 text-center text-gray-500">Loading team members...</div>
                ):(
                  <table className="w-full text-sm">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="text-left px-4 py-3 font-semibold text-gray-600">User</th>
                        <th className="text-left px-4 py-3 font-semibold text-gray-600">Role</th>
                        <th className="text-left px-4 py-3 font-semibold text-gray-600">Status</th>
                        <th className="text-left px-4 py-3 font-semibold text-gray-600">Last Active</th>
                        <th className="text-right px-4 py-3 font-semibold text-gray-600">Actions</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                      {teamMembers.map(member=>(
                        <tr key={member.id}>
                          <td className="px-4 py-3">
                            <div className="flex items-center gap-3">
                              <div className="w-8 h-8 rounded-full bg-[#802629] flex items-center justify-center text-white font-medium text-sm">
                                {(member.first_name||member.email||'U')[0].toUpperCase()}
                              </div>
                              <div>
                                <div className="font-medium text-gray-800">
                                  {member.first_name && member.last_name 
                                    ? `${member.first_name} ${member.last_name}`
                                    : member.email?.split('@')[0] || 'Unknown'}
                                </div>
                                <div className="text-xs text-gray-500">{member.email}</div>
                              </div>
                            </div>
                          </td>
                          <td className="px-4 py-3">
                            {member.role==='owner'?(
                              <span className="px-2 py-1 bg-[#802629] text-white rounded text-xs font-medium">Owner</span>
                            ):editingMember===member.id?(
                              <select 
                                value={member.role} 
                                onChange={e=>{updateMemberRole(member.id,e.target.value);setEditingMember(null);}}
                                className="px-2 py-1 border rounded text-xs"
                                autoFocus
                                onBlur={()=>setEditingMember(null)}
                              >
                                <option value="Viewer">Viewer</option>
                                <option value="Editor">Editor</option>
                                <option value="Admin">Admin</option>
                              </select>
                            ):(
                              <span 
                                className={`px-2 py-1 rounded text-xs font-medium cursor-pointer hover:opacity-80 ${
                                  member.role==='admin'?'bg-purple-100 text-purple-700':
                                  member.role==='editor'?'bg-blue-100 text-blue-700':
                                  'bg-gray-100 text-gray-700'
                                }`}
                                onClick={()=>setEditingMember(member.id)}
                                title="Click to change role"
                              >
                                {member.role?.charAt(0).toUpperCase()+member.role?.slice(1)}
                              </span>
                            )}
                          </td>
                          <td className="px-4 py-3">
                            {member.role==='owner'?(
                              <span className="flex items-center gap-1.5 text-green-600">
                                <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                                Active
                              </span>
                            ):(
                              <select 
                                value={member.status} 
                                onChange={e=>updateMemberStatus(member.id,e.target.value)}
                                className={`px-2 py-1 border-0 rounded text-xs font-medium cursor-pointer ${
                                  member.status==='active'?'bg-green-50 text-green-700':
                                  member.status==='pending'?'bg-yellow-50 text-yellow-700':
                                  'bg-red-50 text-red-700'
                                }`}
                              >
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="pending">Pending</option>
                              </select>
                            )}
                          </td>
                          <td className="px-4 py-3 text-gray-500">
                            {member.last_active 
                              ? new Date(member.last_active).toLocaleDateString()
                              : member.status==='pending' ? 'Invited' : '-'}
                          </td>
                          <td className="px-4 py-3 text-right">
                            {member.role==='owner'?(
                              <span className="text-gray-400">-</span>
                            ):(
                              <button 
                                onClick={()=>removeMember(member.id)}
                                className="text-red-500 hover:text-red-700 p-1"
                                title="Remove from team"
                              >
                                <TrashIcon/>
                              </button>
                            )}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                )}
              </div>
              
              {/* Pending Invitations */}
              {teamMembers.filter(m=>m.status==='pending').length>0&&(
                <div className="border border-yellow-200 rounded-lg overflow-hidden bg-yellow-50">
                  <div className="px-4 py-3 border-b border-yellow-200">
                    <h4 className="font-semibold text-yellow-800">Pending Invitations</h4>
                  </div>
                  <div className="p-4">
                    <div className="space-y-2">
                      {teamMembers.filter(m=>m.status==='pending').map(m=>(
                        <div key={m.id} className="flex items-center justify-between p-3 bg-white rounded-lg border border-yellow-200">
                          <div>
                            <div className="font-medium text-gray-800">{m.email}</div>
                            <div className="text-xs text-gray-500">Invited as {m.role}</div>
                          </div>
                          <div className="flex items-center gap-2">
                            <button className="text-xs text-blue-600 hover:underline">Resend</button>
                            <button onClick={()=>removeMember(m.id)} className="text-xs text-red-600 hover:underline">Cancel</button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
      </div>
      {showSaveToast&&<div className="save-toast">✓ Changes saved!</div>}
      {formulaBuilderTask&&<FormulaBuilderPopup formula={formulaBuilderTask.formula} variables={formulaBuilderTask.variables} task={formulaBuilderTask} onSave={f=>updateTaskFormula(formulaBuilderTask.key,f)} onClose={()=>setFormulaBuilderTask(null)}/>}
      
      {/* Software Added Popup */}
      {softwareAddedPopup&&(
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={()=>setSoftwareAddedPopup(null)}>
          <div className="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 overflow-hidden" onClick={e=>e.stopPropagation()}>
            <div className="px-6 py-4 bg-green-600 text-white flex items-center gap-3">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
              <div className="font-semibold text-lg">Software Added Successfully</div>
            </div>
            <div className="p-6">
              <p className="text-gray-700 mb-4">
                <span className="font-semibold text-green-700">"{softwareAddedPopup.software}"</span> has been added to the software list and automatically added to {softwareAddedPopup.tasks.length} task{softwareAddedPopup.tasks.length!==1?'s':''}.
              </p>
              <div className="bg-gray-100 border border-gray-300 rounded-lg p-4 mb-4">
                <div className="flex items-start gap-2">
                  <svg className="w-5 h-5 text-gray-600 flex-shrink-0 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                  <div>
                    <div className="font-semibold text-gray-700 text-sm">Action Required</div>
                    <div className="text-gray-700 text-sm mt-1">Default values were copied from "Quickbooks Online". Please review and update the hours/minutes for this new software in the Tasks tab.</div>
                  </div>
                </div>
              </div>
              <div className="mb-4">
                <div className="text-xs font-semibold text-gray-500 uppercase mb-2">Affected Tasks:</div>
                <div className="max-h-32 overflow-y-auto bg-gray-50 rounded-lg p-2">
                  {softwareAddedPopup.tasks.map((taskName,i)=>(
                    <div key={i} className="text-sm text-gray-600 py-1 px-2 flex items-center gap-2">
                      <span className="w-1.5 h-1.5 bg-rh-maroon rounded-full"></span>
                      {taskName}
                    </div>
                  ))}
                </div>
              </div>
              <div className="flex gap-3">
                <button onClick={()=>{setSoftwareAddedPopup(null);setTab('tasks')}} className="flex-1 px-4 py-2 bg-rh-maroon text-white rounded-lg font-medium hover:bg-rh-maroon-dark">
                  Go to Tasks
                </button>
                <button onClick={()=>setSoftwareAddedPopup(null)} className="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200">
                  Close
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// Report Modal Component
function ReportModal({reportType,onClose,roles,tasks,quoteGlobals,quoteBoxInputs,quoteMargins,variables,flexTasks,quoteCustomerName,quoteProjectName}){
  const[selectedLevel,setSelectedLevel]=useState(1);
  const markup=quoteMargins[selectedLevel]||100;
  const roleKeys=Object.keys(roles||{});
  
  // Section labels
  const sectionLabels={ap:'AP',ar:'AR',cm:'CM',fa:'FA',pr:'PR',jc:'JC',gl:'GL',tx:'TX',me:'ME',fr:'FS',ye:'YE',oh:'OH'};
  const moduleOrder=['ap','ar','cm','fa','pr','jc','gl','tx','me','fr','ye'];
  
  // Format functions
  const fmt=n=>n?.toFixed(2)||'0.00';
  const fmtCurrency=n=>'$'+(n?.toFixed(2)||'0.00');
  const fmtCurrencyInt=n=>'$'+(n?.toFixed(0)||'0');
  
  // Calculate task-level data
  const taskData=useMemo(()=>{
    const result=[];
    if(!tasks||!tasks.length||!roles)return result;
    
    const getMultiplier=(tableKey,selectedValue)=>{
      const tbl=variables.client?.tables?.[tableKey];
      if(tbl?.type==='multiplier'&&tbl.rows){return tbl.rows[selectedValue]??1;}
      return 1;
    };
    
    const sqMult=getMultiplier('staff_quality',quoteGlobals.staff_quality);
    const arMult=getMultiplier('annual_revenue',quoteGlobals.annual_revenue);
    const pfMult=getMultiplier('payroll_frequency',quoteGlobals.payroll_frequency);
    const combinedMult=(1+sqMult)*arMult;
    
    for(let ti=0;ti<tasks.length;ti++){
      const t=tasks[ti];
      const inp=quoteBoxInputs[selectedLevel]?quoteBoxInputs[selectedLevel][t.key]:null;
      if(!inp||!t.levels||!t.levels[selectedLevel]||!inp.enabled)continue;
      
      const adj=inp.adjHours||{};
      const formulaVars={...inp,...quoteGlobals,payroll_freq_mult:pfMult};
      
      const getLookupKey=()=>{
        if(t.lookupType==='software')return quoteGlobals.software;
        if(t.lookupType==='frequency')return inp.freq;
        if(t.lookupType==='complexity')return inp.complexity;
        if(t.lookupType==='method')return inp.method;
        if(t.lookupType==='online_access')return inp.online_access;
        if(t.lookupType==='ap_automation')return inp.use_ap_automation;
        if(t.lookupType==='integration')return inp.integration;
        if(t.lookupType==='flagged')return inp.vendors_flagged;
        return null;
      };
      
      const roleHours={},roleCosts={};
      let totalHours=0,totalCost=0;
      
      if(t.lookupType&&t.lookupTable&&t.lookupType!=='role'){
        const lookupKey=getLookupKey();
        const lookupRow=t.lookupTable.rows?.[lookupKey]||Object.values(t.lookupTable.rows||{})[0]||{};
        for(const role of roleKeys){
          const valueForRole=lookupRow[role]||0;
          formulaVars[t.lookupTable.key]=valueForRole;
          let baseHrs=valueForRole>0?FormulaEngine.evaluate(t.formula,formulaVars,variables):0;
          baseHrs*=combinedMult;
          const hrs=baseHrs+(parseFloat(adj[role])||0);
          roleHours[role]=hrs;
          roleCosts[role]=hrs*(roles[role].cost_rate||0);
          totalHours+=hrs;
          totalCost+=roleCosts[role];
        }
      }else if(t.lookupType==='role'&&t.lookupTable){
        for(const role of roleKeys){
          const minutesForRole=t.lookupTable.rows?.[role]||0;
          formulaVars[t.lookupTable.key]=minutesForRole;
          let baseHrs=minutesForRole>0?FormulaEngine.evaluate(t.formula,formulaVars,variables):0;
          baseHrs*=combinedMult;
          const hrs=baseHrs+(parseFloat(adj[role])||0);
          roleHours[role]=hrs;
          roleCosts[role]=hrs*(roles[role].cost_rate||0);
          totalHours+=hrs;
          totalCost+=roleCosts[role];
        }
      }else{
        let totalHrsBase=FormulaEngine.evaluate(t.formula,formulaVars,variables)*combinedMult;
        for(const role of roleKeys){
          const alloc=t.roleAllocation?.[role]||0;
          const baseHrs=totalHrsBase*alloc;
          const hrs=baseHrs+(parseFloat(adj[role])||0);
          roleHours[role]=hrs;
          roleCosts[role]=hrs*(roles[role].cost_rate||0);
          totalHours+=hrs;
          totalCost+=roleCosts[role];
        }
      }
      
      if(totalHours>0){
        result.push({key:t.key,name:t.name,section:t.section,hammerTimeMapping:t.hammerTimeMapping,roleHours,roleCosts,totalHours,totalCost,totalRevenue:totalCost*(1+markup/100)});
      }
    }
    
    // Add flex tasks
    Object.entries(flexTasks||{}).forEach(([secKey,secFlexTasks])=>{
      (secFlexTasks||[]).forEach((ft,fi)=>{
        const ftHours=ft.hours?.[selectedLevel];
        if(!ftHours)return;
        const ftRoleHours={},ftRoleCosts={};
        let ftTotalHours=0,ftTotalCost=0;
        for(const role of roleKeys){
          const hrs=parseFloat(ftHours[role])||0;
          if(hrs>0){
            ftRoleHours[role]=hrs;
            ftRoleCosts[role]=hrs*(roles[role].cost_rate||0);
            ftTotalHours+=hrs;
            ftTotalCost+=ftRoleCosts[role];
          }
        }
        if(ftTotalHours>0){
          result.push({key:`flex_${secKey}_${fi}`,name:ft.name||'Flex Task',section:secKey,roleHours:ftRoleHours,roleCosts:ftRoleCosts,totalHours:ftTotalHours,totalCost:ftTotalCost,totalRevenue:ftTotalCost*(1+markup/100),isFlex:true});
        }
      });
    });
    
    return result;
  },[tasks,roles,quoteGlobals,quoteBoxInputs,variables,selectedLevel,markup,flexTasks]);
  
  // Budget data - aggregate by HammerTime code
  const budgetData=useMemo(()=>{
    const rawRows=[];
    for(const t of taskData){
      if(!t.hammerTimeMapping)continue;
      for(const role of roleKeys){
        const hrs=t.roleHours[role]||0;
        if(hrs<=0)continue;
        const htCode=t.hammerTimeMapping[role];
        if(!htCode)continue;
        const htTask=DEFAULT_HAMMERTIME_TASKS.find(h=>h.id===htCode);
        const costRate=roles[role].cost_rate||0;
        rawRows.push({htCode,htName:htTask?.task||htCode,htModule:htTask?.module||htCode.split('.')[0],role,hours:hrs,costRate,billingRate:costRate*(1+markup/100),totalCost:hrs*costRate,totalRevenue:hrs*costRate*(1+markup/100)});
      }
    }
    return rawRows.sort((a,b)=>a.htCode.localeCompare(b.htCode));
  },[taskData,roleKeys,roles,markup]);
  
  // Cost by section data
  const costDetailData=useMemo(()=>{
    const sectionMap={};
    for(const t of taskData){
      const sec=t.section||'oh';
      if(!sectionMap[sec])sectionMap[sec]={section:sec,tasks:[]};
      sectionMap[sec].tasks.push(t);
    }
    return moduleOrder.filter(s=>sectionMap[s]).map(s=>sectionMap[s]);
  },[taskData]);
  
  // Cost by module data
  const costByModuleData=useMemo(()=>{
    const moduleData={};
    moduleOrder.forEach(mod=>{
      moduleData[mod]={hours:{},costs:{},totalHours:0,totalCost:0,totalRevenue:0};
      roleKeys.forEach(r=>{moduleData[mod].hours[r]=0;moduleData[mod].costs[r]=0;});
    });
    for(const t of taskData){
      const sec=t.section||'oh';
      if(!moduleData[sec])continue;
      moduleData[sec].totalHours+=t.totalHours;
      moduleData[sec].totalCost+=t.totalCost;
      moduleData[sec].totalRevenue+=t.totalRevenue;
      roleKeys.forEach(r=>{
        moduleData[sec].hours[r]+=(t.roleHours[r]||0);
        moduleData[sec].costs[r]+=(t.roleCosts[r]||0);
      });
    }
    return moduleOrder.map(mod=>({module:sectionLabels[mod]||mod.toUpperCase(),data:moduleData[mod]}));
  },[taskData,roleKeys]);
  
  // Totals
  const totals=useMemo(()=>{
    const t={hours:{},costs:{},totalHours:0,totalCost:0,totalRevenue:0,budgetHours:0,budgetCost:0,budgetRev:0};
    roleKeys.forEach(r=>{t.hours[r]=0;t.costs[r]=0;});
    taskData.forEach(task=>{
      t.totalHours+=task.totalHours;t.totalCost+=task.totalCost;t.totalRevenue+=task.totalRevenue;
      roleKeys.forEach(r=>{t.hours[r]+=(task.roleHours[r]||0);t.costs[r]+=(task.roleCosts[r]||0);});
    });
    budgetData.forEach(b=>{t.budgetHours+=b.hours;t.budgetCost+=b.totalCost;t.budgetRev+=b.totalRevenue;});
    return t;
  },[taskData,budgetData,roleKeys]);
  
  // Export CSV
  const exportCSV=()=>{
    let csv='';
    if(reportType==='budget'){
      csv='Code,Task,Module,Role,Hours,Cost Rate,Bill Rate,Total Cost,Total Revenue\n';
      budgetData.forEach(r=>{csv+=`${r.htCode},"${r.htName}",${r.htModule},${r.role},${r.hours.toFixed(2)},${r.costRate.toFixed(2)},${r.billingRate.toFixed(2)},${r.totalCost.toFixed(2)},${r.totalRevenue.toFixed(2)}\n`;});
      csv+=`TOTALS,,,,${totals.budgetHours.toFixed(2)},,,${totals.budgetCost.toFixed(2)},${totals.budgetRev.toFixed(2)}\n`;
    }else if(reportType==='costByModule'){
      csv='Module';roleKeys.forEach(r=>{csv+=`,${r} Hours,${r} Cost`;});csv+=',Total Hours,Total Cost,Markup,Revenue\n';
      costByModuleData.forEach(m=>{
        csv+=m.module;roleKeys.forEach(r=>{csv+=`,${(m.data.hours[r]||0).toFixed(2)},${(m.data.costs[r]||0).toFixed(2)}`;});
        csv+=`,${m.data.totalHours.toFixed(2)},${m.data.totalCost.toFixed(2)},${(markup/100+1).toFixed(2)},${m.data.totalRevenue.toFixed(2)}\n`;
      });
      csv+='Total';roleKeys.forEach(r=>{csv+=`,${totals.hours[r].toFixed(2)},${totals.costs[r].toFixed(2)}`;});
      csv+=`,${totals.totalHours.toFixed(2)},${totals.totalCost.toFixed(2)},${(markup/100+1).toFixed(2)},${totals.totalRevenue.toFixed(2)}\n`;
    }else{
      csv='Module,Task';roleKeys.forEach(r=>{csv+=`,${r} Hours,${r} Cost`;});csv+=',Total Hours,Total Cost,Price\n';
      costDetailData.forEach(sec=>{
        sec.tasks.forEach(t=>{
          csv+=`${sectionLabels[sec.section]},"${t.name}"`;roleKeys.forEach(r=>{csv+=`,${(t.roleHours[r]||0).toFixed(2)},${(t.roleCosts[r]||0).toFixed(2)}`;});
          csv+=`,${t.totalHours.toFixed(2)},${t.totalCost.toFixed(2)},${t.totalRevenue.toFixed(2)}\n`;
        });
      });
    }
    const blob=new Blob([csv],{type:'text/csv'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);
    a.download=`${reportType}_Level${selectedLevel}_${quoteCustomerName||'Quote'}.csv`;a.click();
  };
  
  const reportTitle=reportType==='budget'?'Budget Report':reportType==='costByModule'?'Cost Detail by Module':'Cost Detail by Task';
  
  return(
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col" onClick={e=>e.stopPropagation()}>
        <div className="px-6 py-4 border-b border-gray-200 flex items-center justify-between" style={{backgroundColor:'#333'}}>
          <div>
            <h2 className="text-lg font-bold text-white">{reportTitle}</h2>
            <p className="text-sm text-white/70">{quoteCustomerName} - {quoteProjectName}</p>
          </div>
          <button onClick={onClose} className="text-white/70 hover:text-white"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        
        <div className="px-6 py-3 border-b border-gray-200 flex items-center justify-between bg-gray-50">
          <div className="flex items-center gap-4">
            <label className="text-sm font-medium text-gray-600">Level:</label>
            <select value={selectedLevel} onChange={e=>setSelectedLevel(Number(e.target.value))} className="px-3 py-1.5 border border-gray-200 rounded-lg text-sm">
              <option value={1}>Level 1</option>
              <option value={2}>Level 2</option>
              <option value={3}>Level 3</option>
            </select>
            <span className="text-sm text-gray-500">Markup: {markup}%</span>
          </div>
          <button onClick={exportCSV} className="px-4 py-2 bg-[#802629] text-white rounded-lg text-sm font-medium hover:bg-[#6a1f22]">Export CSV</button>
        </div>
        
        <div className="flex-1 overflow-auto p-4">
          {reportType==='budget'?(
            <table className="w-full text-sm">
              <thead className="bg-gray-50 sticky top-0">
                <tr>
                  <th className="px-3 py-2 text-left font-semibold text-gray-600">Code</th>
                  <th className="px-3 py-2 text-left font-semibold text-gray-600">Task</th>
                  <th className="px-3 py-2 text-center font-semibold text-gray-600">Module</th>
                  <th className="px-3 py-2 text-center font-semibold text-gray-600">Role</th>
                  <th className="px-3 py-2 text-right font-semibold text-gray-600">Hours</th>
                  <th className="px-3 py-2 text-right font-semibold text-gray-600">Cost Rate</th>
                  <th className="px-3 py-2 text-right font-semibold text-gray-600">Bill Rate</th>
                  <th className="px-3 py-2 text-right font-semibold text-gray-600">Total Cost</th>
                  <th className="px-3 py-2 text-right font-semibold text-gray-600">Revenue</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-100">
                {budgetData.map((r,i)=>(
                  <tr key={i} className="hover:bg-gray-50">
                    <td className="px-3 py-1.5 font-mono text-[#802629] text-xs">{r.htCode}</td>
                    <td className="px-3 py-1.5 text-xs">{r.htName}</td>
                    <td className="px-3 py-1.5 text-center"><span className="px-2 py-0.5 bg-gray-100 rounded text-xs">{r.htModule}</span></td>
                    <td className="px-3 py-1.5 text-center text-xs">{r.role}</td>
                    <td className="px-3 py-1.5 text-right font-mono text-xs">{fmt(r.hours)}</td>
                    <td className="px-3 py-1.5 text-right font-mono text-xs text-gray-500">{fmtCurrency(r.costRate)}</td>
                    <td className="px-3 py-1.5 text-right font-mono text-xs text-gray-500">{fmtCurrency(r.billingRate)}</td>
                    <td className="px-3 py-1.5 text-right font-mono text-xs">{fmtCurrency(r.totalCost)}</td>
                    <td className="px-3 py-1.5 text-right font-mono text-xs text-green-600">{fmtCurrency(r.totalRevenue)}</td>
                  </tr>
                ))}
              </tbody>
              <tfoot className="bg-gray-200 font-semibold">
                <tr>
                  <td className="px-3 py-2" colSpan="4">TOTALS ({budgetData.length} rows)</td>
                  <td className="px-3 py-2 text-right font-mono">{fmt(totals.budgetHours)}</td>
                  <td className="px-3 py-2"></td><td className="px-3 py-2"></td>
                  <td className="px-3 py-2 text-right font-mono">{fmtCurrency(totals.budgetCost)}</td>
                  <td className="px-3 py-2 text-right font-mono text-green-600">{fmtCurrency(totals.budgetRev)}</td>
                </tr>
              </tfoot>
            </table>
          ):reportType==='costByModule'?(
            <table className="w-full text-sm">
              <thead className="bg-gray-50 sticky top-0">
                <tr>
                  <th className="px-3 py-2 text-left font-semibold text-gray-600">Module</th>
                  {roleKeys.map(r=><React.Fragment key={r}><th className="px-2 py-2 text-right font-semibold text-gray-600 text-xs">{r}<br/>Hours</th><th className="px-2 py-2 text-right font-semibold text-gray-600 text-xs">{r}<br/>Cost</th></React.Fragment>)}
                  <th className="px-3 py-2 text-right font-semibold text-gray-600">Total Hours</th>
                  <th className="px-3 py-2 text-right font-semibold text-gray-600">Total Cost</th>
                  <th className="px-3 py-2 text-right font-semibold text-gray-600">Markup</th>
                  <th className="px-3 py-2 text-right font-semibold text-gray-600">Revenue</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-100">
                {costByModuleData.map((m,i)=>(
                  <tr key={i} className="hover:bg-gray-50">
                    <td className="px-3 py-1.5"><span className="px-2 py-0.5 bg-gray-100 rounded text-xs font-medium">{m.module}</span></td>
                    {roleKeys.map(r=><React.Fragment key={r}>
                      <td className="px-2 py-1.5 text-right font-mono text-xs">{(m.data.hours[r]||0)>0?fmt(m.data.hours[r]):'-'}</td>
                      <td className="px-2 py-1.5 text-right font-mono text-xs text-gray-500">{(m.data.costs[r]||0)>0?fmtCurrencyInt(m.data.costs[r]):'-'}</td>
                    </React.Fragment>)}
                    <td className="px-3 py-1.5 text-right font-mono text-xs">{m.data.totalHours>0?fmt(m.data.totalHours):'-'}</td>
                    <td className="px-3 py-1.5 text-right font-mono text-xs">{m.data.totalCost>0?fmtCurrencyInt(m.data.totalCost):'-'}</td>
                    <td className="px-3 py-1.5 text-right font-mono text-xs text-gray-500">{(markup/100+1).toFixed(2)}</td>
                    <td className="px-3 py-1.5 text-right font-mono text-xs text-green-600">{m.data.totalRevenue>0?fmtCurrencyInt(m.data.totalRevenue):'-'}</td>
                  </tr>
                ))}
              </tbody>
              <tfoot className="bg-gray-200 font-semibold">
                <tr>
                  <td className="px-3 py-2">Total</td>
                  {roleKeys.map(r=><React.Fragment key={r}><td className="px-2 py-2 text-right font-mono text-xs">{fmt(totals.hours[r])}</td><td className="px-2 py-2 text-right font-mono text-xs">{fmtCurrencyInt(totals.costs[r])}</td></React.Fragment>)}
                  <td className="px-3 py-2 text-right font-mono">{fmt(totals.totalHours)}</td>
                  <td className="px-3 py-2 text-right font-mono">{fmtCurrencyInt(totals.totalCost)}</td>
                  <td className="px-3 py-2 text-right font-mono text-gray-500">{(markup/100+1).toFixed(2)}</td>
                  <td className="px-3 py-2 text-right font-mono text-green-600">{fmtCurrencyInt(totals.totalRevenue)}</td>
                </tr>
              </tfoot>
            </table>
          ):(
            <table className="w-full text-sm">
              <thead className="bg-gray-50 sticky top-0">
                <tr>
                  <th className="px-3 py-2 text-left font-semibold text-gray-600">Module</th>
                  <th className="px-3 py-2 text-left font-semibold text-gray-600">Task</th>
                  {roleKeys.map(r=><React.Fragment key={r}><th className="px-2 py-2 text-right font-semibold text-gray-600 text-xs">{r}<br/>Hours</th><th className="px-2 py-2 text-right font-semibold text-gray-600 text-xs">{r}<br/>Cost</th></React.Fragment>)}
                  <th className="px-3 py-2 text-right font-semibold text-gray-600">Total Cost</th>
                  <th className="px-3 py-2 text-right font-semibold text-gray-600">Price</th>
                </tr>
              </thead>
              <tbody>
                {costDetailData.map((sec,si)=>{
                  const secTotals={hours:{},costs:{},totalCost:0,totalRevenue:0};
                  roleKeys.forEach(r=>{secTotals.hours[r]=0;secTotals.costs[r]=0;});
                  sec.tasks.forEach(t=>{secTotals.totalCost+=t.totalCost;secTotals.totalRevenue+=t.totalRevenue;roleKeys.forEach(r=>{secTotals.hours[r]+=(t.roleHours[r]||0);secTotals.costs[r]+=(t.roleCosts[r]||0);});});
                  return(<React.Fragment key={si}>
                    {sec.tasks.map((t,ti)=>(
                      <tr key={ti} className="hover:bg-gray-50 border-b border-gray-100">
                        <td className="px-3 py-1"><span className="px-2 py-0.5 bg-gray-100 rounded text-xs font-medium">{sectionLabels[sec.section]}</span></td>
                        <td className="px-3 py-1 text-xs">{t.name}</td>
                        {roleKeys.map(r=><React.Fragment key={r}>
                          <td className="px-2 py-1 text-right font-mono text-xs">{(t.roleHours[r]||0)>0?fmt(t.roleHours[r]):''}</td>
                          <td className="px-2 py-1 text-right font-mono text-xs text-gray-500">{(t.roleCosts[r]||0)>0?fmtCurrencyInt(t.roleCosts[r]):''}</td>
                        </React.Fragment>)}
                        <td className="px-3 py-1 text-right font-mono text-xs">{fmtCurrencyInt(t.totalCost)}</td>
                        <td className="px-3 py-1 text-right font-mono text-xs text-green-600">{fmtCurrencyInt(t.totalRevenue)}</td>
                      </tr>
                    ))}
                    <tr className="bg-gray-100 font-semibold border-b-2 border-gray-300">
                      <td className="px-3 py-1" colSpan="2">{sectionLabels[sec.section]} Total</td>
                      {roleKeys.map(r=><React.Fragment key={r}><td className="px-2 py-1 text-right font-mono text-xs">{secTotals.hours[r]>0?fmt(secTotals.hours[r]):''}</td><td className="px-2 py-1 text-right font-mono text-xs">{secTotals.costs[r]>0?fmtCurrencyInt(secTotals.costs[r]):''}</td></React.Fragment>)}
                      <td className="px-3 py-1 text-right font-mono text-xs">{fmtCurrencyInt(secTotals.totalCost)}</td>
                      <td className="px-3 py-1 text-right font-mono text-xs text-green-600">{fmtCurrencyInt(secTotals.totalRevenue)}</td>
                    </tr>
                  </React.Fragment>);
                })}
              </tbody>
              <tfoot className="bg-gray-200 font-bold">
                <tr>
                  <td className="px-3 py-2" colSpan="2">GRAND TOTAL</td>
                  {roleKeys.map(r=><React.Fragment key={r}><td className="px-2 py-2 text-right font-mono text-xs">{fmt(totals.hours[r])}</td><td className="px-2 py-2 text-right font-mono text-xs">{fmtCurrencyInt(totals.costs[r])}</td></React.Fragment>)}
                  <td className="px-3 py-2 text-right font-mono">{fmtCurrencyInt(totals.totalCost)}</td>
                  <td className="px-3 py-2 text-right font-mono text-green-600">{fmtCurrencyInt(totals.totalRevenue)}</td>
                </tr>
              </tfoot>
            </table>
          )}
        </div>
      </div>
    </div>
  );
}

// Quote Builder View
function QuoteBuilderView(){
  const{roles,tasks,sections,variables,levels,settings,flexTasks,setFlexTasks,
    quoteGlobals,setQuoteGlobals,quoteBoxInputs,setQuoteBoxInputs,quoteMargins,setQuoteMargins,
    quoteCustomerName,setQuoteCustomerName,quoteProjectName,setQuoteProjectName,
    quoteDate,setQuoteDate,quoteStatus,quoteVersion,
    quoteVersionHistory,showVersionDropdown,setShowVersionDropdown,hasUnsavedChanges,loadVersionFromHistory,
    quoteVisibleLevels,setQuoteVisibleLevels,quoteExpandedTasks,setQuoteExpandedTasks,
    quoteActiveSection,setQuoteActiveSection,
    taskComments,setCommentModalTask,
    validationErrors,setValidationErrors,
    customers,setCustomers,showCustomerSelect,setShowCustomerSelect,industries,
    isTemplate,saveCurrentQuote,savingQuote,closeQuote,applyCurrentTemplate
  }=useContext(AppContext);
  const[pricingExpanded,setPricingExpanded]=useState(true);
  const[showReportsDropdown,setShowReportsDropdown]=useState(false);
  const[showReportModal,setShowReportModal]=useState(null); // 'budget', 'costDetail', 'costByModule'
  
  // Quick Add Customer state
  const[quickAddCustomer,setQuickAddCustomer]=useState({
    name:'',contact_name:'',contact_title:'',email:'',phone:'',address:'',city:'',state:'',zip:'',website:'',industry:'General Contractor',annual_revenue:'',software:'',notes:''
  });
  
  const handleQuickAddCustomer=()=>{
    if(!quickAddCustomer.name.trim()||!quickAddCustomer.annual_revenue||!quickAddCustomer.software)return;
    // Create contacts array from contact info if provided
    const contacts=quickAddCustomer.contact_name?[{
      id:Date.now(),
      name:quickAddCustomer.contact_name,
      title:quickAddCustomer.contact_title||'',
      email:quickAddCustomer.email||'',
      phone:quickAddCustomer.phone||'',
      notes:''
    }]:[];
    const newCustomer={
      ...quickAddCustomer,
      contacts,
      id:'cust_'+Date.now(),
      created_at:new Date().toISOString(),
      updated_at:new Date().toISOString()
    };
    const updatedCustomers=[newCustomer,...customers];
    setCustomers(updatedCustomers);
    localStorage.setItem('rh_customers',JSON.stringify(updatedCustomers));
    setQuoteCustomerName(newCustomer.name);
    // Set quote defaults from customer
    if(newCustomer.software&&setQuoteGlobals){
      setQuoteGlobals(prev=>({...prev,software:newCustomer.software}));
    }
    if(newCustomer.annual_revenue&&setQuoteGlobals){
      setQuoteGlobals(prev=>({...prev,annual_revenue:newCustomer.annual_revenue}));
    }
    setQuickAddCustomer({name:'',contact_name:'',contact_title:'',email:'',phone:'',address:'',city:'',state:'',zip:'',website:'',industry:'General Contractor',annual_revenue:'',software:'',notes:''});
    setShowCustomerSelect(false);
    if(validationErrors?.customerName)setValidationErrors(p=>({...p,customerName:false}));
  };
  
  // Responsive: track window width
  const[windowWidth,setWindowWidth]=useState(typeof window!=='undefined'?window.innerWidth:1200);
  const[mobileActiveLevel,setMobileActiveLevel]=useState(1);
  const isNarrow=windowWidth<1250;
  
  useEffect(()=>{
    const handleResize=()=>setWindowWidth(window.innerWidth);
    window.addEventListener('resize',handleResize);
    return()=>window.removeEventListener('resize',handleResize);
  },[]);
  
  // Use lifted state from App
  const globals=quoteGlobals;
  const setGlobals=setQuoteGlobals;
  const boxInputs=quoteBoxInputs;
  const setBoxInputs=setQuoteBoxInputs;
  const margins=quoteMargins;
  const setMargins=setQuoteMargins;
  const customerName=quoteCustomerName;
  const setCustomerName=setQuoteCustomerName;
  const projectName=quoteProjectName;
  const setProjectName=setQuoteProjectName;
  const visibleLevels=quoteVisibleLevels;
  const setVisibleLevels=setQuoteVisibleLevels;
  const expandedTasks=quoteExpandedTasks;
  const setExpandedTasks=setQuoteExpandedTasks;
  const activeSection=quoteActiveSection;
  const setActiveSection=setQuoteActiveSection;
  
  // For narrow screens, only show the selected level
  const displayLevels=isNarrow?[mobileActiveLevel]:visibleLevels;
  
  // Helper to get level properties
  const levelColors={1:levels[1].color,2:levels[2].color,3:levels[3].color};
  const levelBgs={1:levels[1].bgColor,2:levels[2].bgColor,3:levels[3].bgColor};
  const levelNames={1:levels[1].name,2:levels[2].name,3:levels[3].name};
  
  // Get options from client tables (for dropdowns)
  const getOptionsForKey=(optKey)=>{
    const clientTables=variables.client?.tables||{};
    const tbl=clientTables[optKey];
    if(!tbl)return[];
    // If it's a multiplier type, get keys from rows
    if(tbl.type==='multiplier'&&tbl.rows)return Object.keys(tbl.rows);
    // If it's options type, return options array
    return tbl.options||[];
  };
  
  // Get multiplier value from client tables
  const getMultiplier=(tableKey,selectedValue)=>{
    const tbl=variables.client?.tables?.[tableKey];
    if(tbl?.type==='multiplier'&&tbl.rows){
      return tbl.rows[selectedValue]??1;
    }
    return 1;
  };
  
  // Computed multipliers for display
  const staffQualityMult=getMultiplier('staff_quality',globals.staff_quality);
  const annualRevenueMult=getMultiplier('annual_revenue',globals.annual_revenue);
  const payrollFreqMult=getMultiplier('payroll_frequency',globals.payroll_frequency);

  const sectionTasks=tasks.filter(t=>t.section===activeSection&&(t.levels[1]||t.levels[2]||t.levels[3]));
  const toggleTask=k=>{setExpandedTasks(p=>{const n=new Set(p);n.has(k)?n.delete(k):n.add(k);return n})};
  const setAllLevels=(tk,vk,val)=>{setBoxInputs(p=>{const u={1:{...p[1]},2:{...p[2]},3:{...p[3]}};[1,2,3].forEach(l=>{if(u[l][tk])u[l][tk]={...u[l][tk],[vk]:val}});return u})};
  const setBoxEnabled=(l,tk,en)=>{setBoxInputs(p=>({...p,[l]:{...p[l],[tk]:{...p[l][tk],enabled:en}}}))};
  const setBoxAdj=(l,tk,r,val)=>{setBoxInputs(p=>({...p,[l]:{...p[l],[tk]:{...p[l][tk],adjHours:{...p[l][tk].adjHours,[r]:val}}}}))};

  // Calculate results for all tasks - uses cost_rate only
  const results=useMemo(()=>{
    const res={1:{},2:{},3:{}};
    // Get current multiplier values
    const sqMult=getMultiplier('staff_quality',globals.staff_quality);  // e.g., 0.10 for 10%
    const arMult=getMultiplier('annual_revenue',globals.annual_revenue); // e.g., 1.15
    const pfMult=getMultiplier('payroll_frequency',globals.payroll_frequency);
    
    // Combined multiplier: (1 + staff_quality%) * annual_revenue
    const combinedMult=(1+sqMult)*arMult;
    
    [1,2,3].forEach(l=>{
      let tot=0,cost=0;
      const roleHoursTotals={};
      Object.keys(roles).forEach(r=>{roleHoursTotals[r]=0});
      tasks.forEach(t=>{
        const inp=boxInputs[l]?.[t.key];
        if(!inp||!t.levels[l]||!inp.enabled){res[l][t.key]={roleHours:{},totalHours:0,cost:0,section:t.section};return}
        // Include globals and computed multipliers in formula vars
        const formulaVars={
          ...inp,
          ...globals,
          staff_quality_mult:1+sqMult,
          annual_revenue_mult:arMult,
          payroll_freq_mult:pfMult
        };
        
        const adj=inp.adjHours||{};
        const rh={};let bTot=0,bCost=0;
        
        // Determine which lookup key to use based on lookupType
        const getLookupKey=()=>{
          if(t.lookupType==='software')return globals.software;
          if(t.lookupType==='frequency')return inp.freq;
          if(t.lookupType==='complexity')return inp.complexity;
          if(t.lookupType==='method')return inp.method;
          if(t.lookupType==='online_access')return inp.online_access;
          if(t.lookupType==='ap_automation')return inp.use_ap_automation;
          if(t.lookupType==='integration')return inp.integration;
          if(t.lookupType==='flagged')return inp.vendors_flagged;
          return null;
        };
        
        // Handle lookup-based tasks (software, frequency, complexity, method, etc. all work same way)
        if(t.lookupType&&t.lookupTable&&t.lookupType!=='role'){
          const lookupKey=getLookupKey();
          const lookupRow=t.lookupTable.rows?.[lookupKey]||Object.values(t.lookupTable.rows||{})[0]||{};
          // Calculate hours per role from the lookup row
          Object.keys(roles).forEach(r=>{
            const valueForRole=lookupRow[r]||0;
            formulaVars[t.lookupTable.key]=valueForRole;
            let baseHrs=valueForRole>0?FormulaEngine.evaluate(t.formula,formulaVars,variables):0;
            // Apply staff quality and revenue multipliers
            baseHrs=baseHrs*combinedMult;
            const a=parseFloat(adj[r])||0;
            const total=baseHrs+a;
            rh[r]={calc:baseHrs,adj:a,total};
            bTot+=total;
            bCost+=total*roles[r].cost_rate;
            roleHoursTotals[r]+=total;
          });
        }else if(t.lookupType==='role'&&t.lookupTable){
          // Role lookup: rows are {Role: minutes}
          Object.keys(roles).forEach(r=>{
            const minutesForRole=t.lookupTable.rows?.[r]||0;
            formulaVars[t.lookupTable.key]=minutesForRole;
            let baseHrs=minutesForRole>0?FormulaEngine.evaluate(t.formula,formulaVars,variables):0;
            // Apply staff quality and revenue multipliers
            baseHrs=baseHrs*combinedMult;
            const a=parseFloat(adj[r])||0;
            const total=baseHrs+a;
            rh[r]={calc:baseHrs,adj:a,total};
            bTot+=total;
            bCost+=total*roles[r].cost_rate;
            roleHoursTotals[r]+=total;
          });
        }else{
          // Legacy: use roleAllocation
          let totalHrs=FormulaEngine.evaluate(t.formula,formulaVars,variables);
          // Apply staff quality and revenue multipliers
          totalHrs=totalHrs*combinedMult;
          Object.keys(roles).forEach(r=>{
            const alloc=t.roleAllocation?.[r]||0;
            const base=totalHrs*alloc;
            const a=parseFloat(adj[r])||0;
            const total=base+a;
            rh[r]={calc:base,adj:a,total};
            bTot+=total;
            bCost+=total*roles[r].cost_rate;
            roleHoursTotals[r]+=total;
          });
        }
        res[l][t.key]={roleHours:rh,totalHours:bTot,cost:Math.round(bCost*100)/100,section:t.section};
        tot+=bTot;cost+=bCost;
      });
      res[l]._total={hours:Math.round(tot*100)/100,cost:Math.round(cost*100)/100,roleHours:roleHoursTotals};
    });
    return res;
  },[boxInputs,roles,tasks,globals,variables]);

  // Calculate section totals
  const sectionTotals=useMemo(()=>{
    const totals={};
    Object.keys(sections).forEach(sk=>{
      totals[sk]={1:{hours:0,cost:0},2:{hours:0,cost:0},3:{hours:0,cost:0}};
      [1,2,3].forEach(l=>{
        // Regular tasks
        Object.entries(results[l]).forEach(([tk,data])=>{
          if(tk!=='_total'&&data.section===sk){
            totals[sk][l].hours+=data.totalHours||0;
            totals[sk][l].cost+=data.cost||0;
          }
        });
        // Flex tasks
        (flexTasks[sk]||[]).forEach(ft=>{
          const ftHours=ft.hours?.[l]||{};
          Object.entries(roles).forEach(([r,role])=>{
            const hrs=parseFloat(ftHours[r])||0;
            totals[sk][l].hours+=hrs;
            totals[sk][l].cost+=hrs*role.cost_rate;
          });
        });
        totals[sk][l].hours=Math.round(totals[sk][l].hours*100)/100;
        totals[sk][l].cost=Math.round(totals[sk][l].cost*100)/100;
      });
    });
    return totals;
  },[results,sections,flexTasks,roles]);

  const levelCount=displayLevels.length;
  const gridCols=levelCount===1?'grid-cols-1':levelCount===2?'grid-cols-1 sm:grid-cols-2':'grid-cols-1 sm:grid-cols-2 lg:grid-cols-3';
  const taskGridCols=levelCount===1?6:levelCount===2?4:2;

  // Selected level for sidebar (default to first visible level)
  const[sidebarLevel,setSidebarLevel]=useState(1);
  const effectiveLevel=visibleLevels.includes(sidebarLevel)?sidebarLevel:visibleLevels[0];

  return(
    <div className="max-w-[1536px] mx-auto -mt-6 -mx-6">
      {/* Black Header Bar - Not sticky */}
      <div className="bg-[#333] px-6 py-3 flex items-center gap-4">
        <img src="https://cdn.prod.website-files.com/5f165d4a54d5863dea0e4a83/6887f69d61ac9cf5c9c5cf43_RedHammer%20Logo%20%23333.jpg" alt="RedHammer" className="h-10 rounded"/>
        <h1 className="text-white text-lg sm:text-xl font-bold">Maintenance Quote Builder</h1>
        {isTemplate && (
          <span className="px-2 py-1 bg-yellow-400 text-yellow-900 rounded text-xs font-bold flex items-center gap-1">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            TEMPLATE
          </span>
        )}
        {/* Desktop: Show Levels selector */}
        {!isNarrow && (
          <div className="ml-auto flex items-center gap-2">
            <span className="text-xs sm:text-sm text-gray-400">Show Levels:</span>
            {[[1],[1,2],[1,2,3]].map((lvls,i)=>(
              <button key={i} onClick={()=>setVisibleLevels(lvls)} className={`px-2 sm:px-3 py-1 text-xs sm:text-sm font-medium rounded ${JSON.stringify(visibleLevels)===JSON.stringify(lvls)?'bg-white text-gray-800':'bg-gray-600 text-gray-200 hover:bg-gray-500'}`}>
                {lvls.length===1?'L1':lvls.length===2?'L1-L2':'All'}
              </button>
            ))}
          </div>
        )}
      </div>
      
      <div className="px-6 pt-4">
      <div className="flex gap-4">
        {/* Main Content */}
        <div className="flex-1 space-y-4 min-w-0">
      
      {/* Customer & Project - Sticky */}
      <div className="sticky top-0 z-30 bg-white rounded-lg border border-gray-200 p-3 shadow-sm">
        {isTemplate ? (
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            <div className="flex items-center gap-2">
              <label className="text-sm whitespace-nowrap text-gray-600 font-medium">Template Name:</label>
              <input type="text" value={projectName} onChange={e=>setProjectName(e.target.value)} placeholder="Template name" className="px-3 py-1.5 border rounded text-sm font-bold sm:w-52 border-gray-200 bg-gray-50"/>
            </div>
            <div className="flex items-center gap-2">
              <label className="text-sm font-medium text-gray-600 whitespace-nowrap">Date:</label>
              <input type="date" value={quoteDate} onChange={e=>setQuoteDate(e.target.value)} className="px-2 py-1.5 border border-gray-200 rounded text-sm font-bold bg-gray-50"/>
            </div>
            <div className="flex items-center gap-2">
              <label className="text-sm font-medium text-gray-600 whitespace-nowrap">Version:</label>
              <span className="px-2 py-1 bg-gray-200 rounded text-xs font-bold text-gray-700">v{quoteVersion||1}</span>
            </div>
            <div className="flex-1"></div>
            <div className="flex gap-2">
              <button onClick={applyCurrentTemplate} className="h-8 w-8 bg-[#333] hover:bg-[#444] text-white rounded flex items-center justify-center" title="Apply Template">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
              </button>
              <button onClick={saveCurrentQuote} disabled={savingQuote} className="h-8 w-8 bg-green-600 hover:bg-green-700 text-white rounded flex items-center justify-center disabled:opacity-50" title="Save"><SaveIcon/></button>
              <button onClick={closeQuote} className="h-8 w-8 bg-gray-500 hover:bg-gray-600 text-white rounded flex items-center justify-center" title="Close"><CloseIcon/></button>
            </div>
          </div>
        ) : (
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            <div className="flex items-center gap-2 relative">
              <label className="text-sm whitespace-nowrap text-gray-600 font-medium">Customer:</label>
              <select 
                value={customerName} 
                onChange={e=>{
                  if(e.target.value==='__ADD_NEW__'){
                    setShowCustomerSelect(true);
                  }else{
                    setCustomerName(e.target.value);
                    const selectedCustomer=customers.filter(c=>c.name!=='__TEMPLATE__').find(c=>c.name===e.target.value);
                    if(selectedCustomer){
                      if(selectedCustomer.software){setGlobals(p=>({...p,software:selectedCustomer.software}));}
                      if(selectedCustomer.annual_revenue){setGlobals(p=>({...p,annual_revenue:selectedCustomer.annual_revenue}));}
                    }
                  }
                }}
                className="px-3 py-1.5 border rounded text-sm font-bold sm:w-44 border-gray-200 bg-gray-50"
              >
                <option value="">No customer</option>
                {customers.filter(c=>c.name!=='__TEMPLATE__').map(c=>(
                  <option key={c.id} value={c.name}>{c.name}</option>
                ))}
                <option value="__ADD_NEW__">+ Add New Customer</option>
              </select>
            </div>
            <div className="flex items-center gap-2">
              <label className="text-sm whitespace-nowrap text-gray-600 font-medium">Project:</label>
              <input type="text" value={projectName} onChange={e=>setProjectName(e.target.value)} placeholder="Project name" className="px-3 py-1.5 border rounded text-sm font-bold sm:w-36 border-gray-200 bg-gray-50"/>
            </div>
            <div className="flex items-center gap-2">
              <label className="text-sm font-medium text-gray-600 whitespace-nowrap">Date:</label>
              <input type="date" value={quoteDate} onChange={e=>setQuoteDate(e.target.value)} className="px-2 py-1.5 border border-gray-200 rounded text-sm font-bold bg-gray-50"/>
            </div>
            <div className="flex items-center gap-2">
              <label className="text-sm font-medium text-gray-600 whitespace-nowrap">Status:</label>
              <span className={`px-2 py-1 rounded text-xs font-bold ${quoteStatus==='Final'?'bg-green-600 text-white':quoteStatus==='Change Order'?'bg-blue-600 text-white':'bg-yellow-500 text-white'}`}>{quoteStatus||'Draft'}</span>
            </div>
            <div className="flex items-center gap-2 relative">
              <label className="text-sm font-medium text-gray-600 whitespace-nowrap">Version:</label>
              <button onClick={()=>setShowVersionDropdown(!showVersionDropdown)} className="px-2 py-1 bg-gray-200 rounded text-xs font-bold text-gray-700 hover:bg-gray-300 flex items-center gap-1">
                v{quoteVersion||1}
                {quoteVersionHistory.length>0 && <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 9l6 6 6-6"/></svg>}
              </button>
              {hasUnsavedChanges && <span className="w-2 h-2 bg-yellow-500 rounded-full" title="Unsaved changes"></span>}
              {showVersionDropdown && quoteVersionHistory.length>0 && (
                <div className="absolute top-full left-0 mt-1 w-48 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                  <div className="py-1">
                    <div className="px-3 py-1 text-xs text-gray-500 font-medium border-b border-gray-100">Version History</div>
                    <button onClick={()=>setShowVersionDropdown(false)} className="w-full px-3 py-2 text-left text-sm hover:bg-gray-50 flex items-center justify-between bg-gray-100">
                      <span className="font-medium">v{quoteVersion} (Current)</span>
                    </button>
                    {[...quoteVersionHistory].reverse().map((vh,i)=>(
                      <button key={i} onClick={()=>loadVersionFromHistory(vh)} className="w-full px-3 py-2 text-left text-sm hover:bg-gray-50 flex items-center justify-between">
                        <span>v{vh.version}</span>
                        <span className="text-xs text-gray-400">{new Date(vh.savedAt).toLocaleDateString()}</span>
                      </button>
                    ))}
                  </div>
                </div>
              )}
            </div>
            <div className="flex-1"></div>
            <div className="flex gap-2">
              <div className="relative">
                <button onClick={()=>setShowReportsDropdown(!showReportsDropdown)} className="h-8 w-8 bg-[#802629] hover:bg-[#6a1f22] text-white rounded flex items-center justify-center" title="Reports">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                </button>
                {showReportsDropdown&&(
                  <div className="absolute right-0 mt-1 w-48 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                    <button onClick={()=>{setShowReportModal('budget');setShowReportsDropdown(false);}} className="w-full px-4 py-2 text-left text-sm hover:bg-gray-50 flex items-center gap-2">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#802629" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
                      Budget Report
                    </button>
                    <button onClick={()=>{setShowReportModal('costDetail');setShowReportsDropdown(false);}} className="w-full px-4 py-2 text-left text-sm hover:bg-gray-50 flex items-center gap-2">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#802629" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                      Cost Detail by Task
                    </button>
                    <button onClick={()=>{setShowReportModal('costByModule');setShowReportsDropdown(false);}} className="w-full px-4 py-2 text-left text-sm hover:bg-gray-50 flex items-center gap-2">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#802629" strokeWidth="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                      Cost by Module
                    </button>
                  </div>
                )}
              </div>
              <button onClick={saveCurrentQuote} disabled={savingQuote} className="h-8 w-8 bg-green-600 hover:bg-green-700 text-white rounded flex items-center justify-center disabled:opacity-50" title="Save"><SaveIcon/></button>
              <button onClick={closeQuote} className="h-8 w-8 bg-gray-500 hover:bg-gray-600 text-white rounded flex items-center justify-center" title="Close"><CloseIcon/></button>
            </div>
          </div>
        )}
      </div>
      
      {/* Client Variables */}
      <div className="bg-white rounded-lg border border-gray-200 p-3">
        <div className="flex flex-wrap items-center gap-x-5 gap-y-2">
          <div className="flex items-center gap-2">
            <label className="text-sm text-gray-600">Software:</label>
            <select value={globals.software} onChange={e=>setGlobals(p=>({...p,software:e.target.value}))} className="px-2 py-1 border border-gray-200 rounded text-sm bg-gray-50">
              {getOptionsForKey('software').map(o=><option key={o} value={o}>{o}</option>)}
            </select>
          </div>
          <div className="flex items-center gap-2">
            <label className="text-sm text-gray-600">Staff Quality:</label>
            <select value={globals.staff_quality} onChange={e=>setGlobals(p=>({...p,staff_quality:e.target.value}))} className="px-2 py-1 border border-gray-200 rounded text-sm bg-gray-50">
              {getOptionsForKey('staff_quality').map(o=><option key={o} value={o}>{o}</option>)}
            </select>
            <span className="text-xs text-blue-600 font-medium">+{(staffQualityMult*100).toFixed(0)}%</span>
          </div>
          <div className="flex items-center gap-2">
            <label className="text-sm text-gray-600">Annual Revenue:</label>
            <select value={globals.annual_revenue} onChange={e=>setGlobals(p=>({...p,annual_revenue:e.target.value}))} className="px-2 py-1 border border-gray-200 rounded text-sm bg-gray-50">
              {getOptionsForKey('annual_revenue').map(o=><option key={o} value={o}>{o}</option>)}
            </select>
            <span className="text-xs text-blue-600 font-medium">×{annualRevenueMult.toFixed(2)}</span>
          </div>
          <div className="flex-1"></div>
          <button 
            onClick={()=>setCommentModalTask('quote_general')}
            className="relative p-2 rounded hover:bg-gray-100 transition-colors flex items-center gap-2"
            style={{color:(taskComments['quote_general']||[]).length>0?'#802629':'#9CA3AF'}}
            title="Quote Comments"
          >
            <CommentIcon/>
            <span className="text-sm font-medium hidden sm:inline">Comments</span>
            {(taskComments['quote_general']||[]).length>0 && (
              <span className="absolute -top-1 -right-1 w-4 h-4 text-white text-xs rounded-full flex items-center justify-center" style={{backgroundColor:'#802629'}}>
                {(taskComments['quote_general']||[]).length}
              </span>
            )}
          </button>
        </div>
      </div>
      
      {/* Mobile: Level Tabs - styled like BD Tools */}
      {isNarrow && (
        <div className="flex gap-0.5 bg-[#333] px-4 pt-2">
          {[1,2,3].map(l=>(
            <button 
              key={l} 
              onClick={()=>setMobileActiveLevel(l)} 
              className={`flex-1 py-3 px-6 text-sm transition-colors rounded-t-lg ${mobileActiveLevel===l?'bg-white font-bold':'bg-[#555] text-white font-medium hover:bg-[#666]'}`}
              style={mobileActiveLevel===l?{color:'#802629'}:{}}
            >
              L{l} - {levelNames[l]}
            </button>
          ))}
        </div>
      )}
      
      {/* Grand Total Level Cards - Collapsible */}
      <div className="bg-white rounded-lg border border-gray-200 overflow-hidden">
        <div className="px-4 py-3 bg-[#333] border-b border-gray-200 flex items-center justify-between cursor-pointer" onClick={()=>setPricingExpanded(!pricingExpanded)}>
          <div className="flex items-center gap-3">
            <span className={`expand-btn text-gray-400 ${pricingExpanded?'open':''}`}><ChevronRight/></span>
            <h2 className="font-semibold text-white">Level Pricing Summary</h2>
          </div>
          {!pricingExpanded && (
            <div className="flex-1 flex items-center justify-center gap-6">
              {displayLevels.map(l=>{
                const t=results[l]._total;
                const markup=margins[l]||100;
                const monthlyRevenue=t.cost*(1+markup/100);
                return(
                  <div key={l} className="flex items-center gap-3 px-4 py-2 rounded-lg border-2" style={{borderColor:'#802629',backgroundColor:'transparent'}}>
                    <span className="text-base font-semibold text-gray-200">Level {l}:</span>
                    <span className="text-base text-gray-300">{fmt(t.hours,1)} hrs</span>
                    <span className="text-lg font-bold text-white">{fmtCurrencyInt(monthlyRevenue)}</span>
                  </div>
                );
              })}
            </div>
          )}
          <div className="w-8"></div>
        </div>
        {pricingExpanded && (
          <div className="p-4">
            <div className={`grid ${gridCols} gap-4`}>
              {displayLevels.map(l=>{
                const t=results[l]._total;
                const markup=margins[l]||100;
                const monthlyHours=t.hours;
                const annualHours=monthlyHours*12;
                const monthlyCost=t.cost;
                const annualCost=monthlyCost*12;
                const monthlyRevenue=monthlyCost*(1+markup/100);
                const annualRevenue=monthlyRevenue*12;
                const monthlyGrossProfit=monthlyRevenue-monthlyCost;
                const annualGrossProfit=monthlyGrossProfit*12;
                const grossMarginPct=monthlyRevenue>0?(monthlyGrossProfit/monthlyRevenue)*100:0;
                const effectiveRate=monthlyHours>0?monthlyRevenue/monthlyHours:0;
                
                return(
                  <div key={l} className="rounded-lg border overflow-hidden" style={{borderColor:levelColors[l]+'40'}}>
                    <div className="px-4 py-2 text-white text-sm font-semibold flex items-center justify-between" style={{backgroundColor:levelColors[l]}}>
                      <span>Level {l} — {levelNames[l]}</span>
                      <button 
                        onClick={e=>{e.stopPropagation();setCommentModalTask('level_'+l);}}
                        className="relative p-1 rounded hover:bg-white/20 transition-colors"
                        title="Level Comments"
                      >
                        <CommentIcon/>
                        {(taskComments['level_'+l]||[]).length>0 && (
                          <span className="absolute -top-1 -right-1 w-4 h-4 bg-white text-xs rounded-full flex items-center justify-center" style={{color:levelColors[l]}}>
                            {(taskComments['level_'+l]||[]).length}
                          </span>
                        )}
                      </button>
                    </div>
                    <div className="p-4" style={{backgroundColor:levelBgs[l]}}>
                      <div className="flex items-baseline justify-between mb-4">
                        <div><div className="text-3xl font-bold text-gray-800">{fmt(monthlyHours,1)}</div><div className="text-sm text-gray-500">hrs/mo (all modules)</div></div>
                        <div className="text-right"><div className="text-2xl font-bold" style={{color:levelColors[l]}}>{fmtCurrency(monthlyRevenue)}</div><div className="text-sm text-gray-500">@{fmtCurrency(effectiveRate)}/hr effective</div></div>
                      </div>
                      
                      <div className="flex items-center gap-2 mb-3 p-2 bg-white/50 rounded">
                        <label className="text-sm font-medium text-gray-600">Markup %:</label>
                        <input type="number" value={markup} onChange={e=>setMargins(p=>({...p,[l]:parseFloat(e.target.value)||0}))} onClick={e=>e.stopPropagation()} className="w-16 px-2 py-1 border rounded text-sm text-center font-mono" min="0"/>
                        <span className="text-xs text-gray-500">%</span>
                      </div>
                      
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="border-b border-gray-300">
                            <th className="text-left py-1 font-semibold text-gray-600"></th>
                            <th className="text-right py-1 font-semibold text-gray-600">Monthly</th>
                            <th className="text-right py-1 font-semibold text-gray-600">Annual</th>
                          </tr>
                        </thead>
                        <tbody className="text-gray-700">
                          <tr>
                            <td className="py-1">Total Hours</td>
                            <td className="text-right font-mono">{fmt(monthlyHours)}</td>
                            <td className="text-right font-mono">{fmt(annualHours)}</td>
                          </tr>
                          <tr>
                            <td className="py-1">Cost (internal)</td>
                            <td className="text-right font-mono">{fmtCurrency(monthlyCost)}</td>
                            <td className="text-right font-mono">{fmtCurrency(annualCost)}</td>
                          </tr>
                          <tr className="border-t border-gray-300 font-bold">
                            <td className="py-1">Revenue (Total)</td>
                            <td className="text-right font-mono" style={{color:levelColors[l]}}>{fmtCurrency(monthlyRevenue)}</td>
                            <td className="text-right font-mono" style={{color:levelColors[l]}}>{fmtCurrency(annualRevenue)}</td>
                          </tr>
                          <tr>
                            <td className="py-1 text-green-700">Gross Profit</td>
                            <td className="text-right text-green-600">{fmtCurrency(monthlyGrossProfit)}</td>
                            <td className="text-right text-green-600">{fmtCurrency(annualGrossProfit)}</td>
                          </tr>
                          <tr>
                            <td className="py-1 text-green-700">Gross Margin %</td>
                            <td className="text-right text-green-600">{grossMarginPct.toFixed(1)}%</td>
                            <td className="text-right text-green-600">{grossMarginPct.toFixed(1)}%</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}
      </div>

      {/* Bulk Actions - Above tabs */}
      <div className="bg-white rounded-lg border border-gray-200 p-3">
        <div className="flex items-center justify-between flex-wrap gap-2">
          <span className="text-sm font-medium text-gray-600">Bulk Actions:</span>
          <div className="flex flex-wrap gap-2 items-center">
            <button onClick={()=>setExpandedTasks(new Set(tasks.map(t=>t.key)))} className="text-xs px-3 py-1.5 bg-gray-600 text-white hover:bg-gray-700 rounded font-medium">Select All Tasks</button>
            <span className="text-gray-300">|</span>
            <button onClick={()=>{const b={...boxInputs};Object.keys(b[2]).forEach(tk=>{b[2][tk]={...b[1][tk]}});setBoxInputs(b)}} className="text-xs px-3 py-1.5 bg-rh-maroon text-white hover:bg-rh-maroon-dark rounded font-medium">Copy L1 → L2</button>
            <button onClick={()=>{const b={...boxInputs};Object.keys(b[3]).forEach(tk=>{b[3][tk]={...b[1][tk]}});setBoxInputs(b)}} className="text-xs px-3 py-1.5 bg-rh-maroon text-white hover:bg-rh-maroon-dark rounded font-medium">Copy L1 → L3</button>
            <span className="text-gray-300">|</span>
            <button onClick={()=>{const b={...boxInputs};Object.keys(b[1]).forEach(tk=>{b[1][tk]={...b[1][tk],adjHours:Object.fromEntries(Object.keys(roles).map(r=>[r,'']))}});setBoxInputs(b)}} className="text-xs px-3 py-1.5 bg-amber-600 text-white hover:bg-amber-700 rounded font-medium">Clear L1 Extra</button>
            <button onClick={()=>{const b={...boxInputs};Object.keys(b[2]).forEach(tk=>{b[2][tk]={...b[2][tk],adjHours:Object.fromEntries(Object.keys(roles).map(r=>[r,'']))}});setBoxInputs(b)}} className="text-xs px-3 py-1.5 bg-amber-600 text-white hover:bg-amber-700 rounded font-medium">Clear L2 Extra</button>
            <button onClick={()=>{const b={...boxInputs};Object.keys(b[3]).forEach(tk=>{b[3][tk]={...b[3][tk],adjHours:Object.fromEntries(Object.keys(roles).map(r=>[r,'']))}});setBoxInputs(b)}} className="text-xs px-3 py-1.5 bg-amber-600 text-white hover:bg-amber-700 rounded font-medium">Clear L3 Extra</button>
            <button onClick={()=>{const b={...boxInputs};[1,2,3].forEach(l=>{Object.keys(b[l]).forEach(tk=>{b[l][tk]={...b[l][tk],adjHours:Object.fromEntries(Object.keys(roles).map(r=>[r,'']))}})});setBoxInputs(b)}} className="text-xs px-3 py-1.5 bg-amber-600 text-white hover:bg-amber-700 rounded font-medium">Clear All Extra</button>
            <span className="text-gray-300">|</span>
            <button onClick={()=>{const b={...boxInputs};[1,2,3].forEach(l=>{Object.keys(b[l]).forEach(tk=>{b[l][tk]={...b[l][tk],enabled:false,adjHours:Object.fromEntries(Object.keys(roles).map(r=>[r,'']))}})});setBoxInputs(b)}} className="text-xs px-3 py-1.5 bg-red-600 text-white hover:bg-red-700 rounded font-medium">Reset All</button>
          </div>
        </div>
      </div>

      {/* Section Tabs - scrollable on mobile */}
      <div className="overflow-x-auto -mx-4 px-4 md:mx-0 md:px-0">
        <div className="flex gap-1 pb-2 md:pb-0 md:flex-wrap min-w-max md:min-w-0">
          {Object.values(sections).map(m=>(
            <button key={m.key} onClick={()=>setActiveSection(m.key)} className={`px-3 py-1.5 text-sm font-medium rounded-lg whitespace-nowrap flex items-center gap-2 ${activeSection===m.key?'text-white shadow-sm':'text-gray-600 bg-white border border-gray-200'}`} style={activeSection===m.key?{backgroundColor:m.color}:{}}>
              {activeSection===m.key&&<span className="w-2 h-2 bg-yellow-400 rounded-full"></span>}
              {m.name}
            </button>
          ))}
        </div>
      </div>

      {/* Module Section Totals */}
      <div className="bg-white rounded-lg border border-gray-200 p-4">
        <div className="flex items-center justify-between mb-3">
          <div className="flex items-center gap-2">
            <div className="w-3 h-3 rounded" style={{backgroundColor:sections[activeSection]?.color}}></div>
            <span className="font-semibold text-gray-800">{sections[activeSection]?.name} Summary</span>
          </div>
          <button 
            onClick={()=>setCommentModalTask('module_'+activeSection)}
            className="relative p-1.5 rounded hover:bg-gray-100 transition-colors"
            style={{color:(taskComments['module_'+activeSection]||[]).length>0?'#802629':'#9CA3AF'}}
            title="Module Comments"
          >
            <CommentIcon/>
            {(taskComments['module_'+activeSection]||[]).length>0 && (
              <span className="absolute -top-1 -right-1 w-4 h-4 text-white text-xs rounded-full flex items-center justify-center" style={{backgroundColor:'#802629'}}>
                {(taskComments['module_'+activeSection]||[]).length}
              </span>
            )}
          </button>
        </div>
        <div className={`grid ${gridCols} gap-4`}>
          {displayLevels.map(l=>{
            const st=sectionTotals[activeSection]?.[l]||{hours:0,cost:0};
            const markup=margins[l]||100;
            const revenue=st.cost*(1+markup/100);
            return(
              <div key={l} className="flex items-center justify-between p-4 rounded-lg" style={{backgroundColor:levelBgs[l],borderLeft:`4px solid ${levelColors[l]}`}}>
                <span className="text-lg font-semibold" style={{color:levelColors[l]}}>Level {l}</span>
                <div className="text-right">
                  <div className="text-3xl font-bold" style={{color:levelColors[l]}}>{fmt(st.hours,1)} hrs</div>
                  <div className="text-base text-gray-500">{fmtCurrency(revenue)}</div>
                </div>
              </div>
            );
          })}
        </div>
      </div>

      {/* Tasks */}
      <div className="bg-white rounded-lg border border-gray-200 overflow-hidden">
        {/* Header - hidden on mobile */}
        <div className="px-4 py-2 bg-gray-50 border-b border-gray-200 hidden sm:block">
          <div className="flex items-center">
            <div className="flex-shrink-0 text-xs font-semibold text-gray-500 uppercase" style={{width:isNarrow?320:180}}>Task</div>
            <div className="flex-shrink-0 text-xs font-semibold text-gray-500 uppercase text-center hidden md:block" style={{width:80}}>Input</div>
            <div className="flex-1 flex">
              {displayLevels.map(l=>(
                <div key={l} style={{color:levelColors[l]}} className="flex-1 text-xs font-semibold uppercase text-center">Level {l}</div>
              ))}
            </div>
            <div style={{width:100}} className="flex-shrink-0 flex justify-end gap-2">
              <button onClick={()=>setExpandedTasks(new Set(sectionTasks.map(t=>t.key)))} className="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded">Expand</button>
              <button onClick={()=>setExpandedTasks(new Set())} className="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded">Collapse</button>
            </div>
          </div>
        </div>
        
        {/* Mobile header */}
        <div className="px-4 py-2 bg-gray-50 border-b border-gray-200 flex justify-between items-center sm:hidden">
          <span className="text-xs font-semibold text-gray-500 uppercase">Tasks</span>
          <div className="flex gap-2">
            <button onClick={()=>setExpandedTasks(new Set(sectionTasks.map(t=>t.key)))} className="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded">Expand All</button>
            <button onClick={()=>setExpandedTasks(new Set())} className="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded">Collapse</button>
          </div>
        </div>
        
        {/* Payroll Section Variables */}
        {activeSection==='pr' && (
          <div className="px-4 py-3 bg-gray-100 border-b border-gray-300 flex flex-wrap items-center gap-4">
            <span className="text-sm font-medium text-gray-700">Payroll Settings:</span>
            <div className="flex items-center gap-2">
              <label className="text-sm text-gray-700">Frequency:</label>
              <select value={globals.payroll_frequency} onChange={e=>setGlobals(p=>({...p,payroll_frequency:e.target.value}))} className="px-2 py-1 border border-gray-300 rounded text-sm bg-white">
                {getOptionsForKey('payroll_frequency').map(o=><option key={o} value={o}>{o}</option>)}
              </select>
              <span className="text-xs text-gray-600 font-medium">×{payrollFreqMult}/mo</span>
            </div>
            <div className="flex items-center gap-2">
              <label className="text-sm text-gray-700">Employees:</label>
              <input type="number" value={globals.employees} onChange={e=>setGlobals(p=>({...p,employees:+e.target.value}))} className="w-16 px-2 py-1 border border-gray-300 rounded text-sm bg-white text-center"/>
            </div>
          </div>
        )}
        
        {sectionTasks.length===0?<div className="p-8 text-center text-gray-400">No tasks</div>:sectionTasks.map(t=>{
          const isExp=expandedTasks.has(t.key);
          const baseInp=boxInputs[1]?.[t.key]||{};
          return(
            <div key={t.key} className={`border-b border-gray-100 ${isExp?'bg-slate-50':''}`}>
              {/* Collapsed Row */}
              <div className="flex flex-col sm:flex-row sm:items-center px-4 py-3 cursor-pointer hover:bg-gray-50" onClick={()=>toggleTask(t.key)}>
                <div className="flex-shrink-0 flex items-center gap-2 mb-2 sm:mb-0" style={{width:isNarrow?320:180}}>
                  <span className={`expand-btn text-gray-400 ${isExp?'open':''}`}><ChevronRight/></span>
                  <div className="font-medium text-gray-800 text-sm sm:text-base">{t.name}</div>
                </div>
                <div className="flex-shrink-0 text-center hidden md:block" style={{width:80}}>
                  <span className="text-sm text-gray-500">{t.variables[0]?baseInp[t.variables[0].key]:''}</span>
                </div>
                <div className="flex-1 flex">
                  {displayLevels.map(l=>{
                    const res=results[l][t.key];const en=boxInputs[l]?.[t.key]?.enabled;const av=t.levels[l];
                    return<div key={l} className="flex-1 text-center">{av?(en?<span className="text-lg font-semibold font-mono" style={{color:levelColors[l]}}>{fmt(res?.totalHours||0,1)}</span>:<span className="text-sm text-gray-300">OFF</span>):<span className="text-gray-300">—</span>}</div>;
                  })}
                </div>
                <div style={{width:100}} className="flex-shrink-0 hidden sm:flex items-center justify-end">
                  <button 
                    onClick={e=>{e.stopPropagation();setCommentModalTask(t.key);}} 
                    className="relative p-1.5 rounded hover:bg-gray-200 transition-colors"
                    style={{color:(taskComments[t.key]||[]).length>0?'#802629':'#9CA3AF'}}
                    title="Comments"
                  >
                    <CommentIcon/>
                    {(taskComments[t.key]||[]).length>0 && (
                      <span className="absolute -top-1 -right-1 w-4 h-4 text-white text-xs rounded-full flex items-center justify-center" style={{backgroundColor:'#802629'}}>
                        {(taskComments[t.key]||[]).length}
                      </span>
                    )}
                  </button>
                </div>
              </div>
              {/* Expanded Details */}
              {isExp&&(
                <div className="px-4 pb-4 pt-3 border-t border-gray-100">
                  <div className="flex flex-col md:flex-row gap-4">
                    <div className="flex-shrink-0 pr-0 md:pr-4 w-full md:w-[180px]">
                      <div className="space-y-2">
                        {t.variables.map(v=>(
                          <div key={v.key}>
                            <label className="text-xs text-gray-500">{v.label}</label>
                            {v.type==='enum'?(
                              <select value={baseInp[v.key]} onChange={e=>setAllLevels(t.key,v.key,e.target.value)} className="w-full px-2 py-1 border border-gray-200 rounded text-sm mt-1">
                                {(v.optionsKey?getOptionsForKey(v.optionsKey):v.options||[]).map(o=><option key={o} value={o}>{o}</option>)}
                              </select>
                            ):<input type="number" value={baseInp[v.key]||0} onChange={e=>setAllLevels(t.key,v.key,+e.target.value)} className="w-full px-2 py-1 border border-gray-200 rounded text-sm mt-1"/>}
                          </div>
                        ))}
                      </div>
                    </div>
                    <div className="flex-shrink-0 hidden md:block" style={{width:80}}></div>
                    <div className="flex-1 flex flex-col sm:flex-row gap-3">
                      {displayLevels.map(l=>{
                        const av=t.levels[l];const inp=boxInputs[l]?.[t.key]||{};const res=results[l][t.key]||{};const en=inp.enabled;
                        const markup=margins[l]||100;
                        // Calculate totals using cost_rate
                        const totalCost=Object.entries(roles).reduce((sum,[r,role])=>{
                          const rh=res.roleHours?.[r]||{total:0};
                          return sum+(rh.total||0)*role.cost_rate;
                        },0);
                        const totalRevenue=totalCost*(1+markup/100);
                        return(
                          <div key={l} className="flex-1 rounded-lg border overflow-hidden" style={{borderColor:av?levelColors[l]+'40':'#E5E7EB',backgroundColor:av?levelBgs[l]:'#F3F4F6'}}>
                            <div className="px-3 py-2 flex items-center justify-between" style={{backgroundColor:av?levelColors[l]+'20':'#E5E7EB'}}>
                              <span className="text-sm font-semibold" style={{color:av?levelColors[l]:'#9CA3AF'}}>Level {l}</span>
                              {av&&<label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" checked={en} onChange={e=>{e.stopPropagation();setBoxEnabled(l,t.key,e.target.checked)}} className="w-4 h-4 rounded"/><span className="text-sm font-medium text-gray-600">Inc</span></label>}
                            </div>
                            <div className="p-2" style={{minHeight:'80px'}}>
                              {!av?<div className="text-center text-gray-400 text-sm py-4">N/A</div>:!en?<div className="text-center text-gray-400 text-sm py-4">Off</div>:(
                                <table className="box-table">
                                  <thead><tr><th></th><th>Hrs</th><th>+/-</th><th>Total</th><th>Cost</th><th>Rev</th></tr></thead>
                                  <tbody>
                                    {Object.entries(roles).map(([r,role])=>{
                                      const rh=res.roleHours?.[r]||{calc:0,total:0};const adj=inp.adjHours?.[r]??'';
                                      const rowCost=(rh.total||0)*role.cost_rate;
                                      const rowRevenue=rowCost*(1+markup/100);
                                      return(
                                        <tr key={r}>
                                          <td><span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full" style={{backgroundColor:role.color}}></span>{r}</span></td>
                                          <td className="font-mono">{Math.abs(rh.calc)>0.01?fmt(rh.calc,1):'0'}</td>
                                          <td><input type="number" value={adj} onChange={e=>setBoxAdj(l,t.key,r,e.target.value)} onFocus={e=>e.target.select()} onClick={e=>e.stopPropagation()}/></td>
                                          <td className="font-mono" style={{color:rh.total!==0?(rh.total<0?'#DC2626':levelColors[l]):'#9CA3AF'}}>{Math.abs(rh.total)>0.01?fmt(rh.total,1):'0'}</td>
                                          <td className="font-mono" style={{color:rowCost!==0?(rowCost<0?'#DC2626':'#059669'):'#9CA3AF'}}>{Math.abs(rowCost)>0.01?(rowCost<0?'-'+fmtCurrencyInt(rowCost):fmtCurrencyInt(rowCost)):'-'}</td>
                                          <td className="font-mono" style={{color:rowRevenue!==0?(rowRevenue<0?'#DC2626':levelColors[l]):'#9CA3AF'}}>{Math.abs(rowRevenue)>0.01?(rowRevenue<0?'-'+fmtCurrencyInt(rowRevenue):fmtCurrencyInt(rowRevenue)):'-'}</td>
                                        </tr>
                                      );
                                    })}
                                  </tbody>
                                  <tfoot>
                                    <tr className="border-t border-gray-300">
                                      <td className="font-bold">Total</td>
                                      <td></td>
                                      <td></td>
                                      <td className="font-bold" style={{color:levelColors[l]}}>{fmt(res.totalHours||0,1)}</td>
                                      <td className="font-bold" style={{color:totalCost<0?'#DC2626':'#059669'}}>{totalCost<0?'-'+fmtCurrencyInt(totalCost):fmtCurrencyInt(totalCost)}</td>
                                      <td className="font-bold" style={{color:totalRevenue<0?'#DC2626':levelColors[l]}}>{totalRevenue<0?'-'+fmtCurrencyInt(totalRevenue):fmtCurrencyInt(totalRevenue)}</td>
                                    </tr>
                                  </tfoot>
                                </table>
                              )}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                    <div style={{width:100}} className="flex-shrink-0"></div>
                  </div>
                </div>
              )}
            </div>
          );
        })}
        
        {/* Flex Tasks for this section */}
        {settings.enableFlexTasks&&(
          <div className="border-t-2 border-dashed border-gray-200 mt-2">
            {/* Existing flex tasks */}
            {(flexTasks[activeSection]||[]).map((ft,idx)=>{
              const ftKey=`flex_${activeSection}_${idx}`;
              return(
                <div key={ftKey} className="border-b border-gray-100 bg-gray-100/50">
                  <div className="flex items-center px-4 py-3">
                    <div className="flex-shrink-0 flex items-center gap-2" style={{width:isNarrow?320:180}}>
                      <span className="text-gray-600"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg></span>
                      <input type="text" value={ft.name} placeholder="Flex task name..." onChange={e=>{
                        const newName=e.target.value;
                        setFlexTasks(p=>({...p,[activeSection]:(p[activeSection]||[]).map((x,i)=>i===idx?{...x,name:newName}:x)}));
                      }} className="flex-1 font-medium text-gray-800 bg-transparent border-b border-transparent hover:border-gray-300 focus:border-rh-maroon focus:outline-none px-1"/>
                    </div>
                    <div className="flex-shrink-0 text-right" style={{width:80}}>
                      <span className="text-xs text-gray-600 font-medium">FLEX</span>
                    </div>
                    <div className="flex-1 flex">
                      {displayLevels.map(l=>{
                        const ftHours=ft.hours?.[l]||{};
                        const totalHrs=Object.values(ftHours).reduce((s,h)=>s+(parseFloat(h)||0),0);
                        return<div key={l} className="flex-1 text-center"><span className="text-lg font-semibold font-mono" style={{color:levelColors[l]}}>{fmt(totalHrs,1)}</span></div>;
                      })}
                    </div>
                    <div style={{width:100}} className="flex-shrink-0 text-right">
                      <button onClick={()=>setFlexTasks(p=>({...p,[activeSection]:(p[activeSection]||[]).filter((_,i)=>i!==idx)}))} className="text-red-500 hover:text-red-700 p-1"><TrashIcon/></button>
                    </div>
                  </div>
                  {/* Flex task hours entry */}
                  <div className="px-4 pb-4 pt-2 border-t border-gray-300/50">
                    <div className="flex flex-col md:flex-row gap-4">
                      <div className="flex-shrink-0 pr-0 md:pr-4 w-full md:w-[180px]">
                        <div className="text-xs text-gray-500 mb-1">HammerTime Code</div>
                        <select value={ft.hammerTime||settings.defaultFlexHammerTime} onChange={e=>{
                          const newHt=e.target.value;
                          setFlexTasks(p=>({...p,[activeSection]:(p[activeSection]||[]).map((x,i)=>i===idx?{...x,hammerTime:newHt}:x)}));
                        }} className="w-full px-2 py-1 border border-gray-200 rounded text-xs">
                          <option value="">Select...</option>
                          {DEFAULT_HAMMERTIME_TASKS.filter(t=>t.module==='OH'||t.module==='AD').map(t=>(
                            <option key={t.id} value={t.id}>{t.description}</option>
                          ))}
                        </select>
                      </div>
                      <div className="flex-shrink-0 hidden md:block" style={{width:80}}></div>
                      <div className="flex-1 flex flex-col sm:flex-row gap-3">
                        {displayLevels.map(l=>{
                          const ftHours=ft.hours?.[l]||{};
                          const markup=margins[l]||100;
                          const totalHrs=Object.values(ftHours).reduce((s,h)=>s+(parseFloat(h)||0),0);
                          const totalCost=Object.entries(roles).reduce((sum,[r,role])=>sum+(parseFloat(ftHours[r])||0)*role.cost_rate,0);
                          const totalRev=totalCost*(1+markup/100);
                          return(
                            <div key={l} className="flex-1 rounded-lg border overflow-hidden" style={{borderColor:levelColors[l]+'40',backgroundColor:levelBgs[l]}}>
                              <div className="px-3 py-2 flex items-center justify-between" style={{backgroundColor:levelColors[l]+'20'}}>
                                <span className="text-sm font-semibold" style={{color:levelColors[l]}}>Level {l}</span>
                              </div>
                              <div className="p-2">
                                <table className="box-table">
                                  <thead><tr><th></th><th>Hrs</th><th>Cost</th><th>Rev</th></tr></thead>
                                  <tbody>
                                    {Object.entries(roles).map(([r,role])=>{
                                      const hrs=parseFloat(ftHours[r])||0;
                                      const cost=hrs*role.cost_rate;
                                      const rev=cost*(1+markup/100);
                                      return(
                                        <tr key={r}>
                                          <td><span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full" style={{backgroundColor:role.color}}></span>{r}</span></td>
                                          <td><input type="number" step="0.5" value={ftHours[r]||''} onChange={e=>{
                                            const newHrs=e.target.value;
                                            setFlexTasks(p=>({...p,[activeSection]:(p[activeSection]||[]).map((x,i)=>i===idx?{...x,hours:{...x.hours,[l]:{...(x.hours?.[l]||{}),[r]:newHrs}}}:x)}));
                                          }} placeholder="0" style={{width:48}}/></td>
                                          <td className="font-mono text-gray-600">{hrs>0?fmtCurrencyInt(cost):'-'}</td>
                                          <td className="font-mono" style={{color:levelColors[l]}}>{hrs>0?fmtCurrencyInt(rev):'-'}</td>
                                        </tr>
                                      );
                                    })}
                                  </tbody>
                                  <tfoot>
                                    <tr className="border-t border-gray-300">
                                      <td className="font-bold">Total</td>
                                      <td className="font-bold" style={{color:levelColors[l]}}>{fmt(totalHrs,1)}</td>
                                      <td className="font-bold text-gray-600">{fmtCurrencyInt(totalCost)}</td>
                                      <td className="font-bold" style={{color:levelColors[l]}}>{fmtCurrencyInt(totalRev)}</td>
                                    </tr>
                                  </tfoot>
                                </table>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                      <div style={{width:100}} className="flex-shrink-0"></div>
                    </div>
                  </div>
                </div>
              );
            })}
            
            {/* Add flex task button */}
            <div className="px-4 py-3">
              <button onClick={()=>{
                setFlexTasks(p=>({...p,[activeSection]:[...(p[activeSection]||[]),{name:'',hours:{},hammerTime:settings.defaultFlexHammerTime}]}));
              }} className="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">
                <PlusIcon/>
                Add Flex Task
              </button>
            </div>
          </div>
        )}
      </div>
        </div>
        
        {/* Fixed Right Sidebar - hidden on tablet and mobile */}
        <aside className="fixed top-0 right-0 w-[240px] h-screen bg-gray-100 border-l border-gray-200 hidden lg:flex flex-col overflow-y-auto" style={{overflow:'visible'}}>
          <div className="p-2 space-y-1.5 flex-1" style={{overflow:'visible'}}>
            <div className="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
              <div className="px-3 py-1.5 bg-gray-800 text-white flex items-center justify-between">
                <span className="text-sm font-semibold">Quote Summary</span>
                <div className="flex gap-1">
                  {displayLevels.map(l=>(
                    <button key={l} onClick={()=>setSidebarLevel(l)} className={`w-6 h-6 rounded text-xs font-bold ${effectiveLevel===l?'text-white':'text-gray-400 hover:text-gray-200'}`} style={effectiveLevel===l?{backgroundColor:levelColors[l]}:{}}>
                      {l}
                    </button>
                  ))}
                </div>
              </div>
              <div className="divide-y divide-gray-100">
                {Object.entries(sections).map(([sk,sec])=>{
                  const modTotals=sectionTotals[sk]?.[effectiveLevel]||{hours:0,cost:0};
                  const modRevenue=modTotals.cost*(1+(margins[effectiveLevel]||100)/100);
                  const hasHours=modTotals.hours>0.01;
                  return(
                    <div key={sk} onClick={()=>setActiveSection(sk)} className={`px-2 py-1 cursor-pointer hover:bg-gray-50 transition-colors ${hasHours?'':'opacity-40'} ${activeSection===sk?'bg-red-50 border-l-2 border-rh-maroon':''}`}>
                      <div className="flex items-center gap-2">
                        <span className="w-2 h-2 rounded-full" style={{backgroundColor:sec.color}}></span>
                        <span className="text-xs font-medium text-gray-700 truncate">{sec.name}</span>
                      </div>
                      <div className="pl-4 grid grid-cols-2 gap-x-2 text-xs">
                        <span className="text-gray-500">{fmt(modTotals.hours,1)} hrs</span>
                        <span className="text-right font-medium" style={{color:levelColors[effectiveLevel]}}>{fmtCurrencyInt(modRevenue)}</span>
                      </div>
                    </div>
                  );
                })}
              </div>
              <div className="px-2 py-1.5 bg-gray-50 border-t border-gray-200">
                <div className="flex items-center justify-between mb-0.5">
                  <span className="text-xs font-semibold text-gray-600 uppercase">Total</span>
                  <span className="text-xs px-1.5 py-0.5 rounded font-semibold text-white" style={{backgroundColor:levelColors[effectiveLevel]}}>L{effectiveLevel}</span>
                </div>
                <div className="space-y-1.5">
                  <div className="flex justify-between text-xs">
                    <span className="text-gray-600">Hours</span>
                    <span className="font-semibold">{fmt(results[effectiveLevel]._total?.hours||0,1)}</span>
                  </div>
                  <div className="flex justify-between text-xs">
                    <span className="text-gray-600">Cost</span>
                    <span className="font-medium text-gray-700">{fmtCurrencyInt(results[effectiveLevel]._total?.cost||0)}</span>
                  </div>
                  <div className="flex justify-between text-xs pt-0.5 border-t border-gray-200">
                    <div className="flex items-center gap-2">
                      <span className="text-gray-800 font-semibold">Revenue</span>
                      <span className="text-green-600 font-medium">({margins[effectiveLevel]||100}%)</span>
                    </div>
                    <span className="font-bold" style={{color:levelColors[effectiveLevel]}}>{fmtCurrencyInt((results[effectiveLevel]._total?.cost||0)*(1+(margins[effectiveLevel]||100)/100))}</span>
                  </div>
                </div>
              </div>
            </div>
            
            {/* Hours by Role */}
            <div className="bg-white rounded-lg border border-gray-200 shadow-sm" style={{overflow:'visible'}}>
              <div className="px-2 py-1 bg-gray-100 border-b border-gray-200">
                <span className="text-xs font-semibold text-gray-600 uppercase">Hours by Role</span>
              </div>
              <div className="p-2 space-y-1.5" style={{overflow:'visible'}}>
                {Object.entries(roles).map(([r,role],idx,arr)=>{
                  const roleHrs=results[effectiveLevel]._total?.roleHours?.[r]||0;
                  const totalHrs=results[effectiveLevel]._total?.hours||1;
                  const pct=totalHrs>0?(roleHrs/totalHrs*100):0;
                  
                  // Calculate role hours by module for tooltip
                  const moduleBreakdown=Object.entries(sections).map(([sk,sec])=>{
                    const sectionRoleHrs=Object.entries(results[effectiveLevel])
                      .filter(([k])=>k!=='_total')
                      .filter(([k])=>{const t=tasks.find(t=>t.key===k);return t&&t.section===sk})
                      .reduce((sum,[,res])=>(res?.roleHours?.[r]?.total||0)+sum,0);
                    // Add flex task hours for this section
                    const flexSectionHrs=(flexTasks[sk]||[]).reduce((sum,ft)=>{
                      return sum+(parseFloat(ft.hours?.[effectiveLevel]?.[r])||0);
                    },0);
                    const totalSectionRoleHrs=sectionRoleHrs+flexSectionHrs;
                    const pctOfRole=roleHrs>0?(totalSectionRoleHrs/roleHrs*100):0;
                    return {key:sk,name:sec.name,abbr:sk.toUpperCase(),hrs:totalSectionRoleHrs,pct:pctOfRole};
                  }).filter(m=>m.pct>=1).sort((a,b)=>b.pct-a.pct);
                  
                  return(
                    <div key={r} className="group" style={{position:'relative'}}>
                      <div className="flex items-center justify-between text-xs mb-0.5">
                        <div className="flex items-center gap-1">
                          <span className="w-2 h-2 rounded-full" style={{backgroundColor:role.color}}></span>
                          <span className="text-gray-600">{r}</span>
                        </div>
                        <span className="font-medium">{fmt(roleHrs,1)}</span>
                      </div>
                      <div className="h-1 bg-gray-100 rounded-full overflow-hidden">
                        <div className="h-full rounded-full" style={{width:`${pct}%`,backgroundColor:role.color}}></div>
                      </div>
                      {moduleBreakdown.length>0 && (
                        <div className="hidden group-hover:block" style={{position:'absolute',right:'100%',top:'0',marginRight:'8px',zIndex:9999}}>
                          <div className="text-white text-xs px-2 py-1.5 rounded shadow-lg whitespace-nowrap" style={{backgroundColor:'#555'}}>
                            {moduleBreakdown.map(m=>(
                              <div key={m.key} className="flex gap-4">
                                <span className="w-8">{m.abbr}</span>
                                <span className="font-medium w-10 text-right">{fmt(m.hrs,1)}</span>
                                <span className="text-gray-300 w-8 text-right">{m.pct.toFixed(0)}%</span>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        </aside>
      </div>
      </div>
      
      {/* Quick Add Customer Modal */}
      {showCustomerSelect && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={()=>setShowCustomerSelect(false)}>
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-hidden" onClick={e=>e.stopPropagation()}>
            <div className="px-4 py-3 text-white flex items-center justify-between" style={{backgroundColor:'#802629'}}>
              <span className="font-semibold">Add New Customer</span>
              <button onClick={()=>setShowCustomerSelect(false)} className="text-white/70 hover:text-white"><CloseIcon/></button>
            </div>
            <div className="p-5 overflow-y-auto max-h-[60vh]">
              <div className="grid grid-cols-2 gap-4">
                <div className="col-span-2">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Company Name *</label>
                  <input type="text" value={quickAddCustomer.name} onChange={e=>setQuickAddCustomer({...quickAddCustomer,name:e.target.value})} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="Company name" autoFocus/>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Contact Name</label>
                  <input type="text" value={quickAddCustomer.contact_name} onChange={e=>setQuickAddCustomer({...quickAddCustomer,contact_name:e.target.value})} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="Primary contact"/>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                  <input type="email" value={quickAddCustomer.email} onChange={e=>setQuickAddCustomer({...quickAddCustomer,email:e.target.value})} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="email@company.com"/>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                  <input type="tel" value={quickAddCustomer.phone} onChange={e=>setQuickAddCustomer({...quickAddCustomer,phone:e.target.value})} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="(555) 555-5555"/>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Industry</label>
                  <select value={quickAddCustomer.industry} onChange={e=>setQuickAddCustomer({...quickAddCustomer,industry:e.target.value})} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                    <option value="">Select industry...</option>
                    {(industries||DEFAULT_INDUSTRIES).map(ind=>(<option key={ind} value={ind}>{ind}</option>))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Annual Revenue *</label>
                  <select value={quickAddCustomer.annual_revenue} onChange={e=>setQuickAddCustomer({...quickAddCustomer,annual_revenue:e.target.value})} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                    <option value="">Select...</option>
                    <option>Under $1M</option>
                    <option>$1M - $5M</option>
                    <option>$5M - $10M</option>
                    <option>$10M - $25M</option>
                    <option>$25M - $50M</option>
                    <option>$50M - $100M</option>
                    <option>$100M - $250M</option>
                    <option>Over $250M</option>
                  </select>
                </div>
                <div className="col-span-2">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Software *</label>
                  <select value={quickAddCustomer.software||''} onChange={e=>setQuickAddCustomer({...quickAddCustomer,software:e.target.value})} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                    <option value="">Select software...</option>
                    {DEFAULT_SOFTWARE.map(s=>(<option key={s} value={s}>{s}</option>))}
                  </select>
                </div>
                <div className="col-span-2">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Address</label>
                  <input type="text" value={quickAddCustomer.address} onChange={e=>setQuickAddCustomer({...quickAddCustomer,address:e.target.value})} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="Street address"/>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">City</label>
                  <input type="text" value={quickAddCustomer.city} onChange={e=>setQuickAddCustomer({...quickAddCustomer,city:e.target.value})} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="City"/>
                </div>
                <div className="grid grid-cols-2 gap-2">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">State</label>
                    <input type="text" value={quickAddCustomer.state} onChange={e=>setQuickAddCustomer({...quickAddCustomer,state:e.target.value})} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="ST"/>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">ZIP</label>
                    <input type="text" value={quickAddCustomer.zip} onChange={e=>setQuickAddCustomer({...quickAddCustomer,zip:e.target.value})} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="ZIP"/>
                  </div>
                </div>
              </div>
            </div>
            <div className="px-5 py-4 bg-gray-50 border-t border-gray-200 flex justify-end gap-3">
              <button onClick={()=>setShowCustomerSelect(false)} className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-100">Cancel</button>
              <button onClick={handleQuickAddCustomer} disabled={!quickAddCustomer.name?.trim()||!quickAddCustomer.annual_revenue||!quickAddCustomer.software} className="px-4 py-2 text-white rounded-lg font-medium hover:opacity-90 disabled:opacity-50" style={{backgroundColor:'#802629'}}>Add & Select</button>
            </div>
          </div>
        </div>
      )}
      
      {/* Report Modal */}
      {showReportModal&&(
        <ReportModal 
          reportType={showReportModal} 
          onClose={()=>setShowReportModal(null)}
          roles={roles}
          tasks={tasks}
          quoteGlobals={quoteGlobals}
          quoteBoxInputs={quoteBoxInputs}
          quoteMargins={quoteMargins}
          variables={variables}
          flexTasks={flexTasks}
          quoteCustomerName={quoteCustomerName}
          quoteProjectName={quoteProjectName}
        />
      )}
    </div>
  );
}

// Customers View
function CustomersView(){
  const{customers,setCustomers,logAudit,user,industries,settings,loadUserQuotes}=useContext(AppContext);
  const[showAddCustomer,setShowAddCustomer]=useState(false);
  const[editingCustomer,setEditingCustomer]=useState(null);
  const[searchTerm,setSearchTerm]=useState('');
  const[formErrors,setFormErrors]=useState({});
  
  const emptyCustomer={
    name:'',
    industry:'General Contractor',
    annual_revenue:'',
    software:'Quickbooks Online',
    website:'',
    address:'',
    city:'',
    state:'',
    zip:'',
    notes:'',
    contacts:[]
  };
  
  const[newCustomer,setNewCustomer]=useState({...emptyCustomer});
  
  // Customers are loaded via context from loadUserQuotes
  
  const saveCustomer=async(customerData)=>{
    const result=await CustomerStorage.saveCustomer(user?.id||'local',customerData);
    if(!result.error&&user){
      loadUserQuotes(user.id); // Refresh all data
    }
    return result;
  };
  
  const validateCustomer=(customer)=>{
    const errors={};
    if(!customer.name?.trim()) errors.name=true;
    if(!customer.annual_revenue) errors.annual_revenue=true;
    if(!customer.software) errors.software=true;
    return errors;
  };
  
  const handleAddCustomer=async()=>{
    const errors=validateCustomer(newCustomer);
    if(Object.keys(errors).length>0){setFormErrors(errors);return;}
    const customer={
      ...newCustomer,
      id:null // Let storage generate ID
    };
    const result=await saveCustomer(customer);
    if(!result.error){
      logAudit('customer_created','customer',result.data?.id,null,{name:customer.name},`Created customer: ${customer.name}`);
      setNewCustomer({...emptyCustomer});
      setFormErrors({});
      setShowAddCustomer(false);
    }
  };
  
  const handleUpdateCustomer=async()=>{
    if(!editingCustomer)return;
    const errors=validateCustomer(editingCustomer);
    if(Object.keys(errors).length>0){setFormErrors(errors);return;}
    const result=await saveCustomer(editingCustomer);
    if(!result.error){
      logAudit('customer_updated','customer',editingCustomer.id,null,{name:editingCustomer.name},`Updated customer: ${editingCustomer.name}`);
      setFormErrors({});
      setEditingCustomer(null);
    }
  };
  
  const handleDeleteCustomer=async(id)=>{
    if(!confirm('Delete this customer?'))return;
    const cust=customers.find(c=>c.id===id);
    const result=await CustomerStorage.deleteCustomer(id);
    if(!result.error&&user){
      loadUserQuotes(user.id); // Refresh all data
    }
    logAudit('customer_deleted','customer',id,{name:cust?.name},null,`Deleted customer: ${cust?.name}`);
  };
  
  const[sortConfig,setSortConfig]=useState({key:'name',direction:'asc'});
  const[showFilterRow,setShowFilterRow]=useState(false);
  const[columnFilters,setColumnFilters]=useState({industry:'',software:'',revenue:''});
  
  const filteredCustomers=customers.filter(c=>{
    const matchesSearch=!searchTerm||
      c.name?.toLowerCase().includes(searchTerm.toLowerCase())||
      c.contacts?.some(ct=>ct.name?.toLowerCase().includes(searchTerm.toLowerCase()))||
      c.contacts?.some(ct=>ct.email?.toLowerCase().includes(searchTerm.toLowerCase()));
    const matchesIndustry=!columnFilters.industry||c.industry===columnFilters.industry;
    const matchesSoftware=!columnFilters.software||c.software===columnFilters.software;
    const matchesRevenue=!columnFilters.revenue||c.annual_revenue===columnFilters.revenue;
    return matchesSearch&&matchesIndustry&&matchesSoftware&&matchesRevenue;
  });
  
  const sortedCustomers=[...filteredCustomers].sort((a,b)=>{
    let aVal=a[sortConfig.key]||'';
    let bVal=b[sortConfig.key]||'';
    if(typeof aVal==='string')aVal=aVal.toLowerCase();
    if(typeof bVal==='string')bVal=bVal.toLowerCase();
    if(aVal<bVal)return sortConfig.direction==='asc'?-1:1;
    if(aVal>bVal)return sortConfig.direction==='asc'?1:-1;
    return 0;
  });
  
  const handleSort=(key)=>setSortConfig(prev=>({key,direction:prev.key===key&&prev.direction==='asc'?'desc':'asc'}));
  const SortIcon=({col})=>{
    if(sortConfig.key!==col)return <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="opacity-30 ml-1"><path d="M7 15l5 5 5-5M7 9l5-5 5 5"/></svg>;
    return sortConfig.direction==='asc'?<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="ml-1"><path d="M7 15l5 5 5-5"/></svg>:<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="ml-1"><path d="M7 9l5-5 5 5"/></svg>;
  };
  
  const uniqueIndustries=[...new Set(customers.map(c=>c.industry).filter(Boolean))].sort();
  const uniqueSoftware=[...new Set(customers.map(c=>c.software).filter(Boolean))].sort();
  const uniqueRevenue=[...new Set(customers.map(c=>c.annual_revenue).filter(Boolean))];
  
  const softwareOptions=DEFAULT_SOFTWARE;
  const revenueOptions=['Under $1M','$1M - $5M','$5M - $10M','$10M - $25M','$25M - $50M','$50M - $100M','$100M - $250M','Over $250M'];
  
  const CustomerForm=({customer,setCustomer,onSave,onCancel,title})=>{
    const addContact=()=>{
      setCustomer({...customer,contacts:[...(customer.contacts||[]),{id:Date.now(),name:'',email:'',phone:'',title:'',notes:''}]});
    };
    const updateContact=(idx,field,value)=>{
      const contacts=[...(customer.contacts||[])];
      contacts[idx]={...contacts[idx],[field]:value};
      setCustomer({...customer,contacts});
    };
    const removeContact=(idx)=>{
      const contacts=[...(customer.contacts||[])];
      contacts.splice(idx,1);
      setCustomer({...customer,contacts});
    };
    
    return(
      <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={onCancel}>
        <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl mx-4 max-h-[90vh] overflow-hidden" onClick={e=>e.stopPropagation()}>
          <div className="px-4 py-3 text-white flex items-center justify-between" style={{backgroundColor:'#802629'}}>
            <span className="font-semibold">{title}</span>
            <button onClick={onCancel} className="text-white/70 hover:text-white"><CloseIcon/></button>
          </div>
          <div className="p-5 overflow-y-auto max-h-[70vh]">
            {/* Company Info Section */}
            <div className="mb-6">
              <h4 className="text-sm font-semibold text-gray-800 mb-3 pb-2 border-b border-gray-200">Company Information</h4>
              <div className="grid grid-cols-2 gap-4">
                <div className="col-span-2">
                  <label className={`block text-sm font-medium mb-1 ${formErrors.name?'text-red-600':'text-gray-700'}`}>Company Name *</label>
                  <input type="text" value={customer.name} onChange={e=>{setCustomer({...customer,name:e.target.value});setFormErrors(p=>({...p,name:false}));}} className={`w-full px-3 py-2 border rounded-lg text-sm ${formErrors.name?'border-red-500 bg-red-50':'border-gray-200'}`} placeholder="Company name"/>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Industry</label>
                  <select value={customer.industry||''} onChange={e=>setCustomer({...customer,industry:e.target.value})} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                    <option value="">Select industry...</option>
                    {(industries||DEFAULT_INDUSTRIES).map(ind=>(
                      <option key={ind} value={ind}>{ind}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className={`block text-sm font-medium mb-1 ${formErrors.annual_revenue?'text-red-600':'text-gray-700'}`}>Annual Revenue *</label>
                  <select value={customer.annual_revenue||''} onChange={e=>{setCustomer({...customer,annual_revenue:e.target.value});setFormErrors(p=>({...p,annual_revenue:false}));}} className={`w-full px-3 py-2 border rounded-lg text-sm ${formErrors.annual_revenue?'border-red-500 bg-red-50':'border-gray-200'}`}>
                    <option value="">Select revenue...</option>
                    {revenueOptions.map(r=>(<option key={r} value={r}>{r}</option>))}
                  </select>
                </div>
                <div>
                  <label className={`block text-sm font-medium mb-1 ${formErrors.software?'text-red-600':'text-gray-700'}`}>Software *</label>
                  <select value={customer.software||''} onChange={e=>{setCustomer({...customer,software:e.target.value});setFormErrors(p=>({...p,software:false}));}} className={`w-full px-3 py-2 border rounded-lg text-sm ${formErrors.software?'border-red-500 bg-red-50':'border-gray-200'}`}>
                    <option value="">Select software...</option>
                    {softwareOptions.map(s=>(<option key={s} value={s}>{s}</option>))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Website</label>
                  <input type="url" value={customer.website||''} onChange={e=>setCustomer({...customer,website:e.target.value})} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="https://"/>
                </div>
              </div>
            </div>
            
            {/* Address Section */}
            <div className="mb-6">
              <h4 className="text-sm font-semibold text-gray-800 mb-3 pb-2 border-b border-gray-200">Address</h4>
              <div className="grid grid-cols-2 gap-4">
                <div className="col-span-2">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Street Address</label>
                  <input type="text" value={customer.address||''} onChange={e=>setCustomer({...customer,address:e.target.value})} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="Street address"/>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">City</label>
                  <input type="text" value={customer.city||''} onChange={e=>setCustomer({...customer,city:e.target.value})} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="City"/>
                </div>
                <div className="grid grid-cols-2 gap-2">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">State</label>
                    <input type="text" value={customer.state||''} onChange={e=>setCustomer({...customer,state:e.target.value})} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="ST" maxLength={2}/>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">ZIP</label>
                    <input type="text" value={customer.zip||''} onChange={e=>setCustomer({...customer,zip:e.target.value})} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="ZIP"/>
                  </div>
                </div>
              </div>
            </div>
            
            {/* Contacts Section */}
            <div className="mb-6">
              <div className="flex items-center justify-between mb-3 pb-2 border-b border-gray-200">
                <h4 className="text-sm font-semibold text-gray-800">Contacts</h4>
                <button onClick={addContact} className="text-sm font-medium flex items-center gap-1 hover:opacity-80" style={{color:'#802629'}}>
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                  Add Contact
                </button>
              </div>
              {(customer.contacts||[]).length===0?(
                <div className="text-center py-4 text-gray-400 text-sm bg-gray-50 rounded-lg">No contacts added yet</div>
              ):(
                <div className="space-y-3">
                  {(customer.contacts||[]).map((contact,idx)=>(
                    <div key={contact.id||idx} className="p-3 bg-gray-50 rounded-lg">
                      <div className="flex items-start justify-between mb-2">
                        <span className="text-xs font-medium text-gray-500">Contact {idx+1}</span>
                        <button onClick={()=>removeContact(idx)} className="text-red-500 hover:text-red-700 text-xs">Remove</button>
                      </div>
                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <label className="block text-xs text-gray-600 mb-1">Name</label>
                          <input type="text" value={contact.name||''} onChange={e=>updateContact(idx,'name',e.target.value)} className="w-full px-2 py-1.5 border border-gray-200 rounded text-sm" placeholder="Contact name"/>
                        </div>
                        <div>
                          <label className="block text-xs text-gray-600 mb-1">Title</label>
                          <input type="text" value={contact.title||''} onChange={e=>updateContact(idx,'title',e.target.value)} className="w-full px-2 py-1.5 border border-gray-200 rounded text-sm" placeholder="Job title"/>
                        </div>
                        <div>
                          <label className="block text-xs text-gray-600 mb-1">Email</label>
                          <input type="email" value={contact.email||''} onChange={e=>updateContact(idx,'email',e.target.value)} className="w-full px-2 py-1.5 border border-gray-200 rounded text-sm" placeholder="email@company.com"/>
                        </div>
                        <div>
                          <label className="block text-xs text-gray-600 mb-1">Phone</label>
                          <input type="tel" value={contact.phone||''} onChange={e=>updateContact(idx,'phone',e.target.value)} className="w-full px-2 py-1.5 border border-gray-200 rounded text-sm" placeholder="(555) 555-5555"/>
                        </div>
                        <div className="col-span-2">
                          <label className="block text-xs text-gray-600 mb-1">Notes</label>
                          <input type="text" value={contact.notes||''} onChange={e=>updateContact(idx,'notes',e.target.value)} className="w-full px-2 py-1.5 border border-gray-200 rounded text-sm" placeholder="Notes about this contact"/>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
            
            {/* Notes Section */}
            <div>
              <h4 className="text-sm font-semibold text-gray-800 mb-3 pb-2 border-b border-gray-200">Notes</h4>
              <textarea value={customer.notes||''} onChange={e=>setCustomer({...customer,notes:e.target.value})} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" rows={3} placeholder="Additional notes about this customer..."/>
            </div>
          </div>
          <div className="px-5 py-4 bg-gray-50 border-t border-gray-200 flex items-center justify-between">
            <span className="text-xs text-gray-500">* Required fields</span>
            <div className="flex gap-3">
              <button onClick={onCancel} className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-100">Cancel</button>
              <button onClick={onSave} className="px-4 py-2 text-white rounded-lg font-medium hover:opacity-90" style={{backgroundColor:'#802629'}}>Save Customer</button>
            </div>
          </div>
        </div>
      </div>
    );
  };
  
  return(
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-xl font-bold text-gray-800">Customers</h2>
          <p className="text-sm text-gray-500">{customers.length} customer{customers.length!==1?'s':''}</p>
        </div>
        <button onClick={()=>{setFormErrors({});setShowAddCustomer(true);}} className="px-4 py-2 text-white rounded-lg font-medium hover:opacity-90 flex items-center gap-2" style={{backgroundColor:'#802629'}}>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Customer
        </button>
      </div>
      
      <div className="bg-white rounded-lg border border-gray-200 overflow-hidden">
        <div className="p-4 border-b border-gray-200 flex flex-wrap gap-4 items-center">
          <input type="text" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} placeholder="Search customers..." className="flex-1 min-w-[200px] px-3 py-2 border border-gray-200 rounded-lg text-sm"/>
          <button onClick={()=>setShowFilterRow(!showFilterRow)} className={`px-3 py-2 text-sm rounded-lg flex items-center gap-2 ${showFilterRow?'bg-[#802629] text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>Filters</button>
          {(columnFilters.industry||columnFilters.software||columnFilters.revenue)&&<button onClick={()=>setColumnFilters({industry:'',software:'',revenue:''})} className="px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg">Clear</button>}
        </div>
        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead className="bg-gray-50">
              <tr>
                <th className="text-left px-4 py-3 font-semibold text-gray-600"><button onClick={()=>handleSort('name')} className="flex items-center hover:text-gray-800">Company<SortIcon col="name"/></button></th>
                <th className="text-left px-4 py-3 font-semibold text-gray-600">Primary Contact</th>
                <th className="text-left px-4 py-3 font-semibold text-gray-600"><button onClick={()=>handleSort('industry')} className="flex items-center hover:text-gray-800">Industry<SortIcon col="industry"/></button></th>
                <th className="text-left px-4 py-3 font-semibold text-gray-600"><button onClick={()=>handleSort('software')} className="flex items-center hover:text-gray-800">Software<SortIcon col="software"/></button></th>
                <th className="text-left px-4 py-3 font-semibold text-gray-600"><button onClick={()=>handleSort('annual_revenue')} className="flex items-center hover:text-gray-800">Revenue<SortIcon col="annual_revenue"/></button></th>
                <th className="text-right px-4 py-3 font-semibold text-gray-600">Actions</th>
              </tr>
              {showFilterRow&&<tr className="bg-gray-100">
                <th className="px-4 py-2"></th>
                <th className="px-4 py-2"></th>
                <th className="px-4 py-2"><select value={columnFilters.industry} onChange={e=>setColumnFilters(p=>({...p,industry:e.target.value}))} className="w-full px-2 py-1 text-sm border border-gray-200 rounded text-gray-700 font-normal"><option value="">All</option>{uniqueIndustries.map(i=><option key={i} value={i}>{i}</option>)}</select></th>
                <th className="px-4 py-2"><select value={columnFilters.software} onChange={e=>setColumnFilters(p=>({...p,software:e.target.value}))} className="w-full px-2 py-1 text-sm border border-gray-200 rounded text-gray-700 font-normal"><option value="">All</option>{uniqueSoftware.map(s=><option key={s} value={s}>{s}</option>)}</select></th>
                <th className="px-4 py-2"><select value={columnFilters.revenue} onChange={e=>setColumnFilters(p=>({...p,revenue:e.target.value}))} className="w-full px-2 py-1 text-sm border border-gray-200 rounded text-gray-700 font-normal"><option value="">All</option>{uniqueRevenue.map(r=><option key={r} value={r}>{r}</option>)}</select></th>
                <th className="px-4 py-2"></th>
              </tr>}
            </thead>
            <tbody className="divide-y divide-gray-100">
              {sortedCustomers.length===0?(
                <tr><td colSpan={6} className="px-4 py-8 text-center text-gray-400">No customers found. Add your first customer above.</td></tr>
              ):(
                sortedCustomers.map(c=>{
                  const primaryContact=(c.contacts||[])[0];
                  return(
                    <tr key={c.id} className="hover:bg-gray-50 cursor-pointer" onDoubleClick={()=>{setFormErrors({});setEditingCustomer({...c,contacts:c.contacts||[]});}}>
                      <td className="px-4 py-3">
                        <div className="font-medium text-gray-800">{c.name}</div>
                        {c.city&&c.state&&<div className="text-xs text-gray-400">{c.city}, {c.state}</div>}
                      </td>
                      <td className="px-4 py-3 text-gray-600">
                        {primaryContact?(
                          <div>
                            <div className="font-medium">{primaryContact.name}</div>
                            {primaryContact.email&&<div className="text-xs text-gray-400">{primaryContact.email}</div>}
                          </div>
                        ):'-'}
                      </td>
                      <td className="px-4 py-3 text-gray-600">{c.industry||'-'}</td>
                      <td className="px-4 py-3 text-gray-600">{c.software||'-'}</td>
                      <td className="px-4 py-3 text-gray-600">{c.annual_revenue||'-'}</td>
                      <td className="px-4 py-3 text-right">
                        <button onClick={()=>{setFormErrors({});setEditingCustomer({...c,contacts:c.contacts||[]});}} className="text-blue-600 hover:text-gray-700 mr-3">Edit</button>
                        <button onClick={()=>handleDeleteCustomer(c.id)} className="text-red-600 hover:text-red-800">Delete</button>
                      </td>
                    </tr>
                  );
                })
              )}
            </tbody>
          </table>
        </div>
      </div>
      
      {showAddCustomer && <CustomerForm customer={newCustomer} setCustomer={setNewCustomer} onSave={handleAddCustomer} onCancel={()=>setShowAddCustomer(false)} title="Add New Customer"/>}
      {editingCustomer && <CustomerForm customer={editingCustomer} setCustomer={setEditingCustomer} onSave={handleUpdateCustomer} onCancel={()=>setEditingCustomer(null)} title="Edit Customer"/>}
    </div>
  );
}

// Quotes View
function QuotesView(){
  const{savedQuotes,loadQuote,deleteQuote,newQuote,copyQuote,setView,user,savedTemplates,customers,setCustomers}=useContext(AppContext);
  const[searchTerm,setSearchTerm]=useState('');
  const[activeView,setActiveView]=useState('all');
  const[sortConfig,setSortConfig]=useState({key:'updated_at',direction:'desc'});
  const[columnFilters,setColumnFilters]=useState({customer:'',project:'',status:''});
  const[showFilterRow,setShowFilterRow]=useState(false);
  const[showTemplateModal,setShowTemplateModal]=useState(false);
  const[selectedTemplate,setSelectedTemplate]=useState(null);
  const[templateCustomer,setTemplateCustomer]=useState('');
  const[templateProject,setTemplateProject]=useState('');
  const[templateDate,setTemplateDate]=useState(new Date().toISOString().split('T')[0]);
  const[templateStatus,setTemplateStatus]=useState('Draft');
  const[showAddCustomer,setShowAddCustomer]=useState(false);
  const[newCustomerName,setNewCustomerName]=useState('');
  const[newCustomerIndustry,setNewCustomerIndustry]=useState('General Contractor');
  const[newCustomerRevenue,setNewCustomerRevenue]=useState('');
  const[newCustomerSoftware,setNewCustomerSoftware]=useState('Quickbooks Online');
  
  // Get templates (quotes with is_template flag)
  const templates=savedTemplates||[];
  
  const handleUseTemplate=()=>{
    if(!selectedTemplate)return;
    // Load the template data and create a new quote from it
    const t=selectedTemplate;
    const title=templateCustomer&&templateProject?`${templateCustomer} - ${templateProject} - ${templateDate}`:`New Quote - ${templateDate}`;
    const newId='quote_'+Date.now();
    const quoteData={
      id:newId,
      title,
      customer_name:templateCustomer||'',
      project_name:templateProject||'',
      status:templateStatus,
      version:1,
      globals:t.globals||{},
      margins:t.margins||{1:100,2:100,3:100},
      boxInputs:t.boxInputs||{},
      flexTasks:t.flexTasks||[],
      visibleLevels:t.visibleLevels||[1,2,3],
      user_id:user?.id||'local',
      created_at:new Date().toISOString(),
      updated_at:new Date().toISOString(),
      is_template:false
    };
    // Save to localStorage
    const existing=JSON.parse(localStorage.getItem('rh_quotes')||'[]');
    localStorage.setItem('rh_quotes',JSON.stringify([quoteData,...existing]));
    // Load the new quote
    loadQuote(quoteData);
    setShowTemplateModal(false);
    setSelectedTemplate(null);
    setTemplateCustomer('');
    setTemplateProject('');
    setTemplateStatus('Draft');
  };
  
  const handleAddCustomer=()=>{
    if(!newCustomerName.trim()||!newCustomerRevenue||!newCustomerSoftware)return;
    const newCust={
      id:'cust_'+Date.now(),
      name:newCustomerName.trim(),
      industry:newCustomerIndustry,
      annual_revenue:newCustomerRevenue,
      software:newCustomerSoftware,
      contacts:[],
      created_at:new Date().toISOString(),
      updated_at:new Date().toISOString()
    };
    const updated=[newCust,...customers];
    setCustomers(updated);
    localStorage.setItem('rh_customers',JSON.stringify(updated));
    setTemplateCustomer(newCust.name);
    setShowAddCustomer(false);
    setNewCustomerName('');
    setNewCustomerRevenue('');
    setNewCustomerSoftware('Quickbooks Online');
  };
  
  const savedViews=[
    {id:'all',name:'All Quotes',filter:{}},
    {id:'draft',name:'Drafts',filter:{status:'Draft'}},
    {id:'final',name:'Final',filter:{status:'Final'}},
    {id:'change',name:'Change Orders',filter:{status:'Change Order'}}
  ];
  
  const currentViewFilter=savedViews.find(v=>v.id===activeView)?.filter||{};
  
  const filteredQuotes=savedQuotes.filter(q=>{
    const matchesSearch=!searchTerm||
      q.customer_name?.toLowerCase().includes(searchTerm.toLowerCase())||
      q.project_name?.toLowerCase().includes(searchTerm.toLowerCase())||
      q.title?.toLowerCase().includes(searchTerm.toLowerCase());
    let matchesView=true;
    if(currentViewFilter.status)matchesView=q.status===currentViewFilter.status;
    const matchesCustomer=!columnFilters.customer||q.customer_name?.toLowerCase().includes(columnFilters.customer.toLowerCase());
    const matchesProject=!columnFilters.project||q.project_name?.toLowerCase().includes(columnFilters.project.toLowerCase());
    const matchesStatus=!columnFilters.status||q.status===columnFilters.status;
    return matchesSearch&&matchesView&&matchesCustomer&&matchesProject&&matchesStatus;
  });
  
  const sortedQuotes=[...filteredQuotes].sort((a,b)=>{
    let aVal=a[sortConfig.key];
    let bVal=b[sortConfig.key];
    if(sortConfig.key==='version'){aVal=Number(aVal||1);bVal=Number(bVal||1);}
    if(sortConfig.key==='created_at'||sortConfig.key==='updated_at'){
      aVal=new Date(aVal||0).getTime();bVal=new Date(bVal||0).getTime();
    }
    if(aVal<bVal)return sortConfig.direction==='asc'?-1:1;
    if(aVal>bVal)return sortConfig.direction==='asc'?1:-1;
    return 0;
  });
  
  const handleSort=(key)=>setSortConfig(prev=>({key,direction:prev.key===key&&prev.direction==='asc'?'desc':'asc'}));
  
  const SortIcon=({col})=>{
    if(sortConfig.key!==col)return <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="opacity-30 ml-1"><path d="M7 15l5 5 5-5M7 9l5-5 5 5"/></svg>;
    return sortConfig.direction==='asc'?<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="ml-1"><path d="M7 15l5 5 5-5"/></svg>:<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="ml-1"><path d="M7 9l5-5 5 5"/></svg>;
  };
  
  const getStatusBadge=(status)=>{switch(status){case 'Final':return 'bg-green-600 text-white';case 'Change Order':return 'bg-blue-600 text-white';default:return 'bg-yellow-500 text-white';}};
  const uniqueCustomers=[...new Set(savedQuotes.map(q=>q.customer_name).filter(Boolean))].sort();
  const uniqueProjects=[...new Set(savedQuotes.map(q=>q.project_name).filter(Boolean))].sort();
  
  return(
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <div><h2 className="text-xl font-bold text-gray-800">Quotes</h2><p className="text-sm text-gray-500">{sortedQuotes.length} of {savedQuotes.length} quote{savedQuotes.length!==1?'s':''}</p></div>
        <div className="flex flex-col sm:flex-row gap-2">
          <button onClick={()=>setShowTemplateModal(true)} className="px-4 py-2 text-white rounded-lg font-medium hover:opacity-90 flex items-center justify-center gap-2" style={{backgroundColor:'#333'}}><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Use Template</button>
          <button onClick={()=>{newQuote();setView('quote');}} className="px-4 py-2 text-white rounded-lg font-medium hover:opacity-90 flex items-center justify-center gap-2" style={{backgroundColor:'#802629'}}><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>New Quote</button>
        </div>
      </div>
      <div className="flex items-center gap-2 flex-wrap">
        {savedViews.map(v=><button key={v.id} onClick={()=>setActiveView(v.id)} className={`px-3 py-1.5 text-sm font-medium rounded ${activeView===v.id?'bg-[#802629] text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>{v.name}</button>)}
      </div>
      <div className="bg-white rounded-lg border border-gray-200 overflow-hidden">
        <div className="p-4 border-b border-gray-200 flex flex-wrap gap-4 items-center">
          <input type="text" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} placeholder="Search quotes..." className="flex-1 min-w-[200px] px-3 py-2 border border-gray-200 rounded-lg text-sm"/>
          <button onClick={()=>setShowFilterRow(!showFilterRow)} className={`px-3 py-2 text-sm rounded-lg flex items-center gap-2 ${showFilterRow?'bg-[#802629] text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>Filters</button>
          {(columnFilters.customer||columnFilters.project||columnFilters.status)&&<button onClick={()=>setColumnFilters({customer:'',project:'',status:''})} className="px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg">Clear</button>}
        </div>
        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead className="bg-gray-50">
              <tr>
                <th className="text-left px-4 py-3 font-semibold text-gray-600"><button onClick={()=>handleSort('title')} className="flex items-center hover:text-gray-800">Title<SortIcon col="title"/></button></th>
                <th className="text-left px-4 py-3 font-semibold text-gray-600"><button onClick={()=>handleSort('customer_name')} className="flex items-center hover:text-gray-800">Customer<SortIcon col="customer_name"/></button></th>
                <th className="text-left px-4 py-3 font-semibold text-gray-600"><button onClick={()=>handleSort('project_name')} className="flex items-center hover:text-gray-800">Project<SortIcon col="project_name"/></button></th>
                <th className="text-center px-4 py-3 font-semibold text-gray-600"><button onClick={()=>handleSort('status')} className="flex items-center hover:text-gray-800 mx-auto">Status<SortIcon col="status"/></button></th>
                <th className="text-center px-4 py-3 font-semibold text-gray-600"><button onClick={()=>handleSort('version')} className="flex items-center hover:text-gray-800 mx-auto">Version<SortIcon col="version"/></button></th>
                <th className="text-left px-4 py-3 font-semibold text-gray-600"><button onClick={()=>handleSort('created_at')} className="flex items-center hover:text-gray-800">Created<SortIcon col="created_at"/></button></th>
                <th className="text-left px-4 py-3 font-semibold text-gray-600"><button onClick={()=>handleSort('updated_at')} className="flex items-center hover:text-gray-800">Modified<SortIcon col="updated_at"/></button></th>
                <th className="text-right px-4 py-3 font-semibold text-gray-600">Actions</th>
              </tr>
              {showFilterRow&&<tr className="bg-gray-100">
                <th className="px-4 py-2"></th>
                <th className="px-4 py-2"><select value={columnFilters.customer} onChange={e=>setColumnFilters(p=>({...p,customer:e.target.value}))} className="w-full px-2 py-1 text-sm border border-gray-200 rounded text-gray-700 font-normal"><option value="">All</option>{uniqueCustomers.map(c=><option key={c} value={c}>{c}</option>)}</select></th>
                <th className="px-4 py-2"><select value={columnFilters.project} onChange={e=>setColumnFilters(p=>({...p,project:e.target.value}))} className="w-full px-2 py-1 text-sm border border-gray-200 rounded text-gray-700 font-normal"><option value="">All</option>{uniqueProjects.map(p=><option key={p} value={p}>{p}</option>)}</select></th>
                <th className="px-4 py-2"><select value={columnFilters.status} onChange={e=>setColumnFilters(p=>({...p,status:e.target.value}))} className="w-full px-2 py-1 text-sm border border-gray-200 rounded text-gray-700 font-normal"><option value="">All</option><option value="Draft">Draft</option><option value="Final">Final</option><option value="Change Order">Change Order</option></select></th>
                <th className="px-4 py-2"></th><th className="px-4 py-2"></th><th className="px-4 py-2"></th><th className="px-4 py-2"></th>
              </tr>}
            </thead>
            <tbody className="divide-y divide-gray-100">
              {sortedQuotes.length===0?<tr><td colSpan={8} className="px-4 py-8 text-center text-gray-400">No quotes found.</td></tr>:sortedQuotes.map(q=>(
                <tr key={q.id} className="hover:bg-gray-50 cursor-pointer" onDoubleClick={()=>loadQuote(q)}>
                  <td className="px-4 py-3 font-medium text-gray-800">{q.title||`${q.customer_name} - ${q.project_name}`}</td>
                  <td className="px-4 py-3 text-gray-600">{q.customer_name||'-'}</td>
                  <td className="px-4 py-3 text-gray-600">{q.project_name||'-'}</td>
                  <td className="px-4 py-3 text-center"><span className={`inline-block px-2 py-1 rounded text-xs font-medium ${getStatusBadge(q.status)}`}>{q.status||'Draft'}</span></td>
                  <td className="px-4 py-3 text-center text-gray-600">v{q.version||1}</td>
                  <td className="px-4 py-3 text-gray-600 text-sm whitespace-nowrap">{fmtDateTime(q.created_at)}</td>
                  <td className="px-4 py-3 text-gray-600 text-sm whitespace-nowrap">{fmtDateTime(q.updated_at)}</td>
                  <td className="px-4 py-3 text-right"><button onClick={()=>loadQuote(q)} className="text-blue-600 hover:text-gray-700 mr-3">Edit</button><button onClick={()=>copyQuote(q)} className="text-green-600 hover:text-gray-700 mr-3">Copy</button><button onClick={()=>deleteQuote(q.id)} className="text-red-600 hover:text-red-800">Delete</button></td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
      
      {/* Use Template Modal */}
      {showTemplateModal&&(
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={()=>setShowTemplateModal(false)}>
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden" onClick={e=>e.stopPropagation()}>
            <div className="px-5 py-4 flex items-center justify-between" style={{backgroundColor:'#802629'}}>
              <div className="flex items-center gap-3 text-white">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                <span className="font-semibold">Use Template</span>
              </div>
              <button onClick={()=>setShowTemplateModal(false)} className="text-white/80 hover:text-white"><CloseIcon/></button>
            </div>
            <div className="p-5 space-y-4">
              {templates.length===0?(
                <div className="text-center py-8 text-gray-500">
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1" className="mx-auto mb-3 opacity-50"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                  <p>No templates available</p>
                  <p className="text-sm mt-1">Create a template from the Templates page first</p>
                </div>
              ):(
                <>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Select Template *</label>
                    <select value={selectedTemplate?.id||''} onChange={e=>{const t=templates.find(t=>t.id===e.target.value);setSelectedTemplate(t||null);}} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                      <option value="">Choose a template...</option>
                      {templates.map(t=><option key={t.id} value={t.id}>{t.template_name||t.project_name||t.title||'Untitled Template'}</option>)}
                    </select>
                  </div>
                  {selectedTemplate&&(
                    <>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Customer (optional)</label>
                        <select value={templateCustomer} onChange={e=>{if(e.target.value==='__ADD__'){setShowAddCustomer(true);}else{setTemplateCustomer(e.target.value);}}} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                          <option value="">No customer</option>
                          {customers.filter(c=>c.name!=='__TEMPLATE__').map(c=><option key={c.id} value={c.name}>{c.name}</option>)}
                          <option value="__ADD__">+ Add New Customer</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Project Name (optional)</label>
                        <input type="text" value={templateProject} onChange={e=>setTemplateProject(e.target.value)} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="Enter project name"/>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Date</label>
                        <input type="date" value={templateDate} onChange={e=>setTemplateDate(e.target.value)} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"/>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <div className="flex gap-2">
                          {['Draft','Final','Change Order'].map(s=><button key={s} onClick={()=>setTemplateStatus(s)} className={`px-3 py-1.5 rounded text-sm font-medium ${templateStatus===s?(s==='Draft'?'bg-yellow-500 text-white':s==='Final'?'bg-green-600 text-white':'bg-blue-600 text-white'):'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>{s}</button>)}
                        </div>
                      </div>
                    </>
                  )}
                </>
              )}
            </div>
            <div className="px-5 py-4 bg-gray-50 border-t border-gray-200 flex justify-end gap-3">
              <button onClick={()=>setShowTemplateModal(false)} className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-100">Cancel</button>
              <button onClick={handleUseTemplate} disabled={!selectedTemplate} className="px-4 py-2 text-white rounded-lg font-medium hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed" style={{backgroundColor:'#802629'}}>Create Quote</button>
            </div>
          </div>
        </div>
      )}
      
      {/* Add Customer Modal */}
      {showAddCustomer&&(
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[60]" onClick={()=>setShowAddCustomer(false)}>
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden" onClick={e=>e.stopPropagation()}>
            <div className="px-5 py-4 flex items-center justify-between" style={{backgroundColor:'#802629'}}>
              <span className="font-semibold text-white">Add New Customer</span>
              <button onClick={()=>setShowAddCustomer(false)} className="text-white/80 hover:text-white"><CloseIcon/></button>
            </div>
            <div className="p-5 space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Company Name *</label>
                <input type="text" value={newCustomerName} onChange={e=>setNewCustomerName(e.target.value)} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="Enter company name" autoFocus/>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Industry</label>
                <select value={newCustomerIndustry} onChange={e=>setNewCustomerIndustry(e.target.value)} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                  <option>General Contractor</option><option>Developer</option><option>Design-Build</option><option>Electrical</option><option>Plumbing</option><option>HVAC</option><option>Roofing</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Annual Revenue *</label>
                <select value={newCustomerRevenue} onChange={e=>setNewCustomerRevenue(e.target.value)} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                  <option value="">Select revenue range...</option>
                  <option>Under $1M</option><option>$1M - $5M</option><option>$5M - $10M</option><option>$10M - $25M</option><option>$25M - $50M</option><option>$50M - $100M</option><option>$100M - $250M</option><option>Over $250M</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Software *</label>
                <select value={newCustomerSoftware} onChange={e=>setNewCustomerSoftware(e.target.value)} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                  {DEFAULT_SOFTWARE.map(s=><option key={s} value={s}>{s}</option>)}
                </select>
              </div>
            </div>
            <div className="px-5 py-4 bg-gray-50 border-t border-gray-200 flex justify-end gap-3">
              <button onClick={()=>setShowAddCustomer(false)} className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-100">Cancel</button>
              <button onClick={handleAddCustomer} disabled={!newCustomerName.trim()||!newCustomerRevenue||!newCustomerSoftware} className="px-4 py-2 text-white rounded-lg font-medium hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed" style={{backgroundColor:'#802629'}}>Add & Select</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// Home View - Dashboard
function HomeView(){
  const{savedQuotes,savedTemplates,customers,user,setView,newQuote}=useContext(AppContext);
  const[recentQuotes,setRecentQuotes]=useState([]);
  const[stats,setStats]=useState({quotes:0,customers:0,templates:0,drafts:0,finals:0});
  
  useEffect(()=>{
    // Calculate stats
    const quotes=savedQuotes||[];
    const drafts=quotes.filter(q=>q.status==='Draft').length;
    const finals=quotes.filter(q=>q.status==='Final').length;
    setStats({
      quotes:quotes.length,
      customers:(customers||[]).length,
      templates:0,
      drafts,
      finals
    });
    setRecentQuotes(quotes.slice(0,5));
    
    // Load template count from unified storage
    try{
      const allQuotes=JSON.parse(localStorage.getItem('rh_quotes')||'[]');
      const templateCount=allQuotes.filter(q=>q.is_template).length;
      setStats(s=>({...s,templates:templateCount}));
    }catch{}
  },[savedQuotes,customers]);
  
  const formatDate=(dateStr)=>{
    if(!dateStr)return'-';
    const d=new Date(dateStr);
    const now=new Date();
    const diff=now-d;
    if(diff<86400000)return 'Today';
    if(diff<172800000)return 'Yesterday';
    if(diff<604800000)return `${Math.floor(diff/86400000)} days ago`;
    return d.toLocaleDateString();
  };
  
  const getGreeting=()=>{
    const hour=new Date().getHours();
    if(hour<12)return'Good morning';
    if(hour<17)return'Good afternoon';
    return'Good evening';
  };
  
  return(
    <div className="space-y-6">
      {/* Welcome Header with Logo */}
      <div className="rounded-2xl p-8 text-white shadow-lg" style={{backgroundColor:'#333'}}>
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-6">
            <img src="https://cdn.prod.website-files.com/5f165d4a54d5863dea0e4a83/6887f69d61ac9cf5c9c5cf43_RedHammer%20Logo%20%23333.jpg" alt="RedHammer" className="h-16 rounded-lg shadow-lg object-contain"/>
            <div>
              <h1 className="text-3xl font-bold mb-2">{getGreeting()}, {user?.email?.split('@')[0]||'there'}!</h1>
              <p className="text-white/80 text-lg">Welcome to RedHammer Quote Builder</p>
            </div>
          </div>
          <div className="hidden md:block">
            <button onClick={()=>{newQuote();}} className="px-6 py-3 bg-white text-[#333] rounded-xl font-bold hover:bg-gray-100 transition-colors shadow-lg flex items-center gap-2">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              New Quote
            </button>
          </div>
        </div>
      </div>
      
      {/* Stats Cards - Maroon/Dark theme */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="bg-white rounded-xl p-5 border border-gray-200 shadow-sm hover:shadow-md transition-shadow cursor-pointer" onClick={()=>setView('quotes')}>
          <div className="flex items-center justify-between mb-3">
            <div className="w-12 h-12 bg-[#802629]/10 rounded-xl flex items-center justify-center">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#802629" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            </div>
            <span className="text-xs text-gray-400">Total</span>
          </div>
          <div className="text-3xl font-bold text-gray-800">{stats.quotes}</div>
          <div className="text-sm text-gray-500">Quotes</div>
        </div>
        
        <div className="bg-white rounded-xl p-5 border border-gray-200 shadow-sm hover:shadow-md transition-shadow cursor-pointer" onClick={()=>setView('customers')}>
          <div className="flex items-center justify-between mb-3">
            <div className="w-12 h-12 bg-[#4A1516]/10 rounded-xl flex items-center justify-center">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#4A1516" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            </div>
            <span className="text-xs text-gray-400">Active</span>
          </div>
          <div className="text-3xl font-bold text-gray-800">{stats.customers}</div>
          <div className="text-sm text-gray-500">Customers</div>
        </div>
        
        <div className="bg-white rounded-xl p-5 border border-gray-200 shadow-sm hover:shadow-md transition-shadow cursor-pointer" onClick={()=>setView('templates')}>
          <div className="flex items-center justify-between mb-3">
            <div className="w-12 h-12 bg-gray-800/10 rounded-xl flex items-center justify-center">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#1F2937" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
            </div>
            <span className="text-xs text-gray-400">Saved</span>
          </div>
          <div className="text-3xl font-bold text-gray-800">{stats.templates}</div>
          <div className="text-sm text-gray-500">Templates</div>
        </div>
        
        <div className="bg-white rounded-xl p-5 border border-gray-200 shadow-sm">
          <div className="flex items-center justify-between mb-3">
            <div className="w-12 h-12 bg-[#802629]/10 rounded-xl flex items-center justify-center">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#802629" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            </div>
            <span className="text-xs text-gray-400">Status</span>
          </div>
          <div className="flex items-center gap-3">
            <div>
              <div className="text-xl font-bold text-[#802629]">{stats.drafts}</div>
              <div className="text-xs text-gray-500">Drafts</div>
            </div>
            <div className="h-8 w-px bg-gray-200"></div>
            <div>
              <div className="text-xl font-bold text-gray-700">{stats.finals}</div>
              <div className="text-xs text-gray-500">Final</div>
            </div>
          </div>
        </div>
      </div>
      
      {/* Quick Actions & Recent Quotes */}
      <div className="grid md:grid-cols-3 gap-6">
        {/* Quick Actions */}
        <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
          <div className="px-5 py-4 border-b border-gray-200 bg-gray-50">
            <h3 className="font-bold text-gray-800">Quick Actions</h3>
          </div>
          <div className="p-4 space-y-2">
            <button onClick={()=>{newQuote();}} className="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-50 transition-colors text-left group">
              <div className="w-10 h-10 bg-[#802629]/10 rounded-lg flex items-center justify-center group-hover:bg-[#802629]/20 transition-colors">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#802629" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              </div>
              <div>
                <div className="font-medium text-gray-800">Create New Quote</div>
                <div className="text-xs text-gray-500">Start from scratch</div>
              </div>
            </button>
            
            <button onClick={()=>setView('templates')} className="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-50 transition-colors text-left group">
              <div className="w-10 h-10 bg-gray-800/10 rounded-lg flex items-center justify-center group-hover:bg-gray-800/20 transition-colors">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#1F2937" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
              </div>
              <div>
                <div className="font-medium text-gray-800">Use Template</div>
                <div className="text-xs text-gray-500">Start from a template</div>
              </div>
            </button>
            
            <button onClick={()=>setView('customers')} className="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-50 transition-colors text-left group">
              <div className="w-10 h-10 bg-[#4A1516]/10 rounded-lg flex items-center justify-center group-hover:bg-[#4A1516]/20 transition-colors">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#4A1516" strokeWidth="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
              </div>
              <div>
                <div className="font-medium text-gray-800">Add Customer</div>
                <div className="text-xs text-gray-500">New customer profile</div>
              </div>
            </button>
            
            <button onClick={()=>setView('admin')} className="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-50 transition-colors text-left group">
              <div className="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center group-hover:bg-gray-200 transition-colors">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6B7280" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
              </div>
              <div>
                <div className="font-medium text-gray-800">Settings</div>
                <div className="text-xs text-gray-500">Configure system</div>
              </div>
            </button>
          </div>
        </div>
        
        {/* Recent Quotes */}
        <div className="md:col-span-2 bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
          <div className="px-5 py-4 border-b border-gray-200 bg-gray-50 flex items-center justify-between">
            <h3 className="font-bold text-gray-800">Recent Quotes</h3>
            <button onClick={()=>setView('quotes')} className="text-sm text-[#802629] hover:underline">View All →</button>
          </div>
          <div className="divide-y divide-gray-100">
            {recentQuotes.length===0?(
              <div className="p-8 text-center text-gray-400">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" className="mx-auto mb-3 opacity-50"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                <p className="font-medium">No quotes yet</p>
                <p className="text-sm mt-1">Create your first quote to get started</p>
              </div>
            ):(
              recentQuotes.map(q=>(
                <div key={q.id} className="px-5 py-4 hover:bg-gray-50 transition-colors cursor-pointer flex items-center justify-between" onClick={()=>setView('quotes')}>
                  <div className="flex-1">
                    <div className="font-medium text-gray-800">{q.title||`${q.customer_name} - ${q.project_name}`}</div>
                    <div className="text-sm text-gray-500">{q.customer_name} • {q.project_name}</div>
                  </div>
                  <div className="flex items-center gap-3">
                    <span className={`px-2 py-1 rounded text-xs font-medium ${
                      q.status==='Final'?'bg-green-600 text-white':
                      q.status==='Change Order'?'bg-blue-600 text-white':
                      'bg-yellow-500 text-white'
                    }`}>{q.status||'Draft'}</span>
                    <span className="text-sm text-gray-400">{formatDate(q.updated_at)}</span>
                  </div>
                </div>
              ))
            )}
          </div>
        </div>
      </div>
      
      {/* Tips Section */}
      <div className="bg-gradient-to-r from-[#802629]/5 to-[#4A1516]/5 rounded-xl p-6 border border-[#802629]/20">
        <div className="flex items-start gap-4">
          <div className="w-12 h-12 bg-[#802629]/10 rounded-xl flex items-center justify-center flex-shrink-0">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#802629" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
          </div>
          <div>
            <h4 className="font-bold text-gray-800 mb-1">Pro Tip</h4>
            <p className="text-gray-600">Create templates for your most common quote types to save time. Templates preserve your task configurations, margins, and settings so you can quickly generate consistent quotes for similar projects.</p>
          </div>
        </div>
      </div>
    </div>
  );
}

// Templates View
function TemplatesView(){
  const{user,setView,logAudit,loadQuote,newTemplate:createNewTemplate,setIsTemplate,hasUnsavedChanges,saveCurrentQuote,savingQuote,savedTemplates,loadUserQuotes}=useContext(AppContext);
  const[searchTerm,setSearchTerm]=useState('');
  const[showUseTemplate,setShowUseTemplate]=useState(false);
  const[selectedTemplate,setSelectedTemplate]=useState(null);
  const[useTemplateData,setUseTemplateData]=useState({customerName:'',projectName:'',status:'Draft',date:new Date().toISOString().split('T')[0]});
  const[showUseAddCustomer,setShowUseAddCustomer]=useState(false);
  const[useNewCustomer,setUseNewCustomer]=useState({name:'',industry:'General Contractor',annual_revenue:'',software:'',contacts:[]});
  const[showApplyTemplate,setShowApplyTemplate]=useState(false);
  const[applyTemplateTarget,setApplyTemplateTarget]=useState(null);
  const{customers,setCustomers,industries}=useContext(AppContext);
  
  // Use savedTemplates from context
  const templates=savedTemplates||[];
  
  const handleDeleteTemplate=async(id)=>{
    if(!confirm('Delete this template?'))return;
    const tmpl=templates.find(t=>t.id===id);
    await QuoteStorage.deleteQuote(id);
    // Reload data via context
    if(user)loadUserQuotes(user.id);
    logAudit('template_deleted','template',id,{name:tmpl?.template_name||tmpl?.title},null,`Deleted template: ${tmpl?.template_name||tmpl?.title}`);
  };
  
  const handleEditTemplate=(template)=>{
    // Load template into quote builder
    loadQuote({...template,is_template:true});
    setIsTemplate(true);
  };
  
  const handleApplyTemplate=(template)=>{
    if(hasUnsavedChanges){
      setApplyTemplateTarget(template);
      setShowApplyTemplate(true);
    }else{
      openUseTemplate(template);
    }
  };
  
  const openUseTemplate=(template)=>{
    setSelectedTemplate(template);
    setUseTemplateData({customerName:'',projectName:'',status:'Draft',date:new Date().toISOString().split('T')[0]});
    setShowUseTemplate(true);
  };
  
  const handleUseTemplate=async()=>{
    // Create a new quote from template - customer/project optional
    const quoteData={
      isTemplate: false,
      title: useTemplateData.customerName && useTemplateData.projectName 
        ? `${useTemplateData.customerName} - ${useTemplateData.projectName} - ${useTemplateData.date} Quote`
        : `New Quote - ${useTemplateData.date}`,
      customerName: useTemplateData.customerName || '',
      projectName: useTemplateData.projectName || '',
      globals: selectedTemplate.globals,
      margins: selectedTemplate.margins,
      boxInputs: selectedTemplate.box_inputs,
      flexTasks: selectedTemplate.flex_tasks || {},
      visibleLevels: selectedTemplate.visible_levels || [1,2,3],
      status: useTemplateData.status,
      version: 1
    };
    const{data,error}=await QuoteStorage.saveQuote(user.id,quoteData);
    if(!error&&data){
      logAudit('quote_from_template','quote',data.id,null,{templateId:selectedTemplate.id,title:quoteData.title},`Created quote from template: ${selectedTemplate.template_name||selectedTemplate.title}`);
      setShowUseTemplate(false);
      setSelectedTemplate(null);
      setView('quotes');
    }
  };
  
  const handleUseAddCustomer=()=>{
    if(!useNewCustomer.name?.trim()||!useNewCustomer.annual_revenue||!useNewCustomer.software)return;
    const newCust={...useNewCustomer,id:'cust_'+Date.now(),created_at:new Date().toISOString(),updated_at:new Date().toISOString()};
    const updatedCustomers=[newCust,...customers];
    setCustomers(updatedCustomers);
    localStorage.setItem('rh_customers',JSON.stringify(updatedCustomers));
    setUseTemplateData(prev=>({...prev,customerName:newCust.name}));
    setUseNewCustomer({name:'',industry:'General Contractor',annual_revenue:'',software:'',contacts:[]});
    setShowUseAddCustomer(false);
  };
  
  const filteredTemplates=templates.filter(t=>
    (t.template_name||t.title||'').toLowerCase().includes(searchTerm.toLowerCase())||
    (t.template_description||'').toLowerCase().includes(searchTerm.toLowerCase())
  );
  const[sortConfig,setSortConfig]=useState({key:'updated_at',direction:'desc'});
  
  // Sort templates
  const sortedTemplates=[...filteredTemplates].sort((a,b)=>{
    let aVal=sortConfig.key==='name'?(a.template_name||a.project_name||a.title||''):a[sortConfig.key];
    let bVal=sortConfig.key==='name'?(b.template_name||b.project_name||b.title||''):b[sortConfig.key];
    if(sortConfig.key==='created_at'||sortConfig.key==='updated_at'){
      aVal=new Date(aVal||0).getTime();
      bVal=new Date(bVal||0).getTime();
    }
    if(aVal<bVal)return sortConfig.direction==='asc'?-1:1;
    if(aVal>bVal)return sortConfig.direction==='asc'?1:-1;
    return 0;
  });
  
  const handleSort=(key)=>{
    setSortConfig(prev=>({
      key,
      direction:prev.key===key&&prev.direction==='asc'?'desc':'asc'
    }));
  };
  
  const SortIcon=({columnKey})=>{
    if(sortConfig.key!==columnKey)return <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="opacity-30"><path d="M7 15l5 5 5-5M7 9l5-5 5 5"/></svg>;
    return sortConfig.direction==='asc'?
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M7 15l5 5 5-5"/></svg>:
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M7 9l5-5 5 5"/></svg>;
  };
  
  return(
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-xl font-bold text-gray-800">Templates</h2>
          <p className="text-sm text-gray-500">{templates.length} template{templates.length!==1?'s':''}</p>
        </div>
        <div className="flex items-center gap-2">
          <button onClick={createNewTemplate} className="px-4 py-2 text-white rounded-lg font-medium hover:opacity-90 flex items-center gap-2" style={{backgroundColor:'#802629'}}>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            New Template
          </button>
        </div>
      </div>
      
      <div className="bg-white rounded-lg border border-gray-200 overflow-hidden">
        <div className="p-4 border-b border-gray-200">
          <input type="text" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} placeholder="Search templates..." className="w-full max-w-sm px-3 py-2 border border-gray-200 rounded-lg text-sm"/>
        </div>
        <table className="w-full text-sm">
          <thead className="bg-gray-50">
            <tr>
              <th className="text-left px-4 py-3 font-semibold text-gray-600">
                <button onClick={()=>handleSort('name')} className="flex items-center gap-1 hover:text-gray-800">
                  Name <SortIcon columnKey="name"/>
                </button>
              </th>
              <th className="text-left px-4 py-3 font-semibold text-gray-600">Description</th>
              <th className="text-left px-4 py-3 font-semibold text-gray-600">
                <button onClick={()=>handleSort('created_at')} className="flex items-center gap-1 hover:text-gray-800">
                  Created <SortIcon columnKey="created_at"/>
                </button>
              </th>
              <th className="text-left px-4 py-3 font-semibold text-gray-600">
                <button onClick={()=>handleSort('updated_at')} className="flex items-center gap-1 hover:text-gray-800">
                  Modified <SortIcon columnKey="updated_at"/>
                </button>
              </th>
              <th className="text-right px-4 py-3 font-semibold text-gray-600">Actions</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-100">
            {sortedTemplates.length===0?(
              <tr><td colSpan={5} className="px-4 py-8 text-center text-gray-400">No templates found. Click "New Template" to create your first one.</td></tr>
            ):(
              sortedTemplates.map(t=>(
                <tr key={t.id} className="hover:bg-gray-50 cursor-pointer" onDoubleClick={()=>handleEditTemplate(t)}>
                  <td className="px-4 py-3 font-medium text-gray-800">{t.template_name||t.project_name||t.title||'Untitled'}</td>
                  <td className="px-4 py-3 text-gray-600">{t.template_description||'-'}</td>
                  <td className="px-4 py-3 text-gray-600 text-sm whitespace-nowrap">{fmtDateTime(t.created_at)}</td>
                  <td className="px-4 py-3 text-gray-600 text-sm whitespace-nowrap">{fmtDateTime(t.updated_at)}</td>
                  <td className="px-4 py-3 text-right">
                    <button onClick={()=>handleEditTemplate(t)} className="text-blue-600 hover:text-blue-800 mr-3 font-medium">Edit</button>
                    <button onClick={()=>handleApplyTemplate(t)} className="text-green-600 hover:text-green-800 mr-3 font-medium">Apply</button>
                    <button onClick={()=>handleDeleteTemplate(t.id)} className="text-red-600 hover:text-red-800">Delete</button>
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>
      
      {/* Use Template Modal */}
      {showUseTemplate && selectedTemplate && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={()=>setShowUseTemplate(false)}>
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden" onClick={e=>e.stopPropagation()}>
            <div className="px-4 py-3 text-white flex items-center gap-3" style={{backgroundColor:'#802629'}}>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
              <span className="font-semibold">Create Quote from Template</span>
            </div>
            <div className="p-5 space-y-4">
              <div className="bg-gray-100 rounded-lg p-3">
                <p className="text-gray-600">Using template: <span className="font-medium text-gray-800">{selectedTemplate.template_name||selectedTemplate.title}</span></p>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Customer <span className="text-gray-400 font-normal">(optional)</span></label>
                <select value={useTemplateData.customerName} onChange={e=>{if(e.target.value==='__ADD_NEW__'){setShowUseAddCustomer(true);}else{setUseTemplateData(p=>({...p,customerName:e.target.value}));}}} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                  <option value="">No customer</option>
                  {customers.filter(c=>c.name!=='__TEMPLATE__').map(c=>(<option key={c.id} value={c.name}>{c.name}</option>))}
                  <option value="__ADD_NEW__">+ Add New Customer</option>
                </select>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Project Name <span className="text-gray-400 font-normal">(optional)</span></label>
                <input type="text" value={useTemplateData.projectName} onChange={e=>setUseTemplateData(p=>({...p,projectName:e.target.value}))} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="Enter project name..."/>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Date</label>
                <input type="date" value={useTemplateData.date} onChange={e=>setUseTemplateData(p=>({...p,date:e.target.value}))} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"/>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <div className="flex gap-2">
                  {['Draft','Final','Change Order'].map(s=>(
                    <button key={s} onClick={()=>setUseTemplateData(p=>({...p,status:s}))} className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${useTemplateData.status===s?(s==='Draft'?'bg-yellow-500 text-white':s==='Final'?'bg-green-600 text-white':'bg-blue-600 text-white'):'bg-gray-100 text-gray-600 border border-gray-300 hover:bg-gray-200'}`}>{s}</button>
                  ))}
                </div>
              </div>
              
              <div className="bg-gray-100 rounded-lg p-3 text-sm text-gray-700">
                <p>This will create a new quote at <strong>Version 1</strong> using the template settings.</p>
              </div>
              
              <div className="flex gap-3 pt-2">
                <button onClick={()=>{setShowUseTemplate(false);setSelectedTemplate(null);}} className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50">Cancel</button>
                <button onClick={handleUseTemplate} className="flex-1 px-4 py-2 text-white rounded-lg font-medium hover:opacity-90" style={{backgroundColor:'#802629'}}>Create Quote</button>
              </div>
            </div>
          </div>
        </div>
      )}
      
      {/* Add Customer from Use Template */}
      {showUseAddCustomer && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[60]" onClick={()=>setShowUseAddCustomer(false)}>
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden" onClick={e=>e.stopPropagation()}>
            <div className="px-4 py-3 text-white flex items-center gap-3" style={{backgroundColor:'#802629'}}>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
              <span className="font-semibold">Add New Customer</span>
            </div>
            <div className="p-5 space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Company Name *</label>
                <input type="text" value={useNewCustomer.name} onChange={e=>setUseNewCustomer(p=>({...p,name:e.target.value}))} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="Company name"/>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Industry</label>
                <select value={useNewCustomer.industry} onChange={e=>setUseNewCustomer(p=>({...p,industry:e.target.value}))} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                  {industries.map(i=><option key={i} value={i}>{i}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Annual Revenue *</label>
                <select value={useNewCustomer.annual_revenue} onChange={e=>setUseNewCustomer(p=>({...p,annual_revenue:e.target.value}))} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                  <option value="">Select revenue range...</option>
                  <option value="Under $1M">Under $1M</option>
                  <option value="$1M - $5M">$1M - $5M</option>
                  <option value="$5M - $10M">$5M - $10M</option>
                  <option value="$10M - $25M">$10M - $25M</option>
                  <option value="$25M - $50M">$25M - $50M</option>
                  <option value="$50M - $100M">$50M - $100M</option>
                  <option value="$100M - $250M">$100M - $250M</option>
                  <option value="$250M+">$250M+</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Software *</label>
                <select value={useNewCustomer.software} onChange={e=>setUseNewCustomer(p=>({...p,software:e.target.value}))} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                  <option value="">Select software...</option>
                  {DEFAULT_SOFTWARE.map(s=><option key={s} value={s}>{s}</option>)}
                </select>
              </div>
              <div className="flex gap-3 pt-2">
                <button onClick={()=>setShowUseAddCustomer(false)} className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50">Cancel</button>
                <button onClick={handleUseAddCustomer} disabled={!useNewCustomer.name?.trim()||!useNewCustomer.annual_revenue||!useNewCustomer.software} className="flex-1 px-4 py-2 text-white rounded-lg font-medium hover:opacity-90 disabled:opacity-50" style={{backgroundColor:'#802629'}}>Add & Select</button>
              </div>
            </div>
          </div>
        </div>
      )}
      
      {/* Unsaved Changes Warning Modal */}
      {showApplyTemplate && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={()=>setShowApplyTemplate(false)}>
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden" onClick={e=>e.stopPropagation()}>
            <div className="px-4 py-3 bg-yellow-500 text-white flex items-center gap-3">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
              <span className="font-semibold">Unsaved Changes</span>
            </div>
            <div className="p-5 space-y-4">
              <p className="text-gray-700">You have unsaved changes. Would you like to save before applying this template?</p>
              <div className="flex flex-col gap-2">
                <button 
                  onClick={async()=>{
                    await saveCurrentQuote();
                    setShowApplyTemplate(false);
                    openUseTemplate(applyTemplateTarget);
                  }}
                  disabled={savingQuote}
                  className="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium flex items-center justify-center gap-2"
                >
                  <SaveIcon/>
                  {savingQuote?'Saving...':'Save & Continue'}
                </button>
                <button 
                  onClick={()=>{
                    setShowApplyTemplate(false);
                    openUseTemplate(applyTemplateTarget);
                  }}
                  className="w-full px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium"
                >
                  Discard & Continue
                </button>
                <button 
                  onClick={()=>setShowApplyTemplate(false)}
                  className="w-full px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
// Main App
function App(){
  // Auth state
  const[user,setUser]=useState(null);
  const[authLoading,setAuthLoading]=useState(true);
  const[authView,setAuthView]=useState('login'); // 'login' or 'signup'
  const[authError,setAuthError]=useState('');
  const[authEmail,setAuthEmail]=useState('');
  const[authPassword,setAuthPassword]=useState('');
  const[authFirstName,setAuthFirstName]=useState('');
  const[authLastName,setAuthLastName]=useState('');
  const[authPhone,setAuthPhone]=useState('');
  
  // Saved quotes state
  const[savedQuotes,setSavedQuotes]=useState([]);
  const[savedTemplates,setSavedTemplates]=useState([]);
  const[currentQuoteId,setCurrentQuoteId]=useState(null);
  const[showQuoteManager,setShowQuoteManager]=useState(false);
  const[savingQuote,setSavingQuote]=useState(false);
  const[loadingQuotes,setLoadingQuotes]=useState(false);
  
  // Check auth on mount (skip if Supabase not configured)
  useEffect(()=>{
    if(!SUPABASE_CONFIGURED){
      setAuthLoading(false);
      setUser({id:'local',email:'local-user'}); // Fake user for local mode
      return;
    }
    SupabaseAuth.getSession().then(session=>{
      setUser(session?.user||null);
      setAuthLoading(false);
    });
    const{data:{subscription}}=SupabaseAuth.onAuthStateChange((event,session)=>{
      setUser(session?.user||null);
      if(session?.user){
        loadUserQuotes(session.user.id);
      }
    });
    return()=>subscription.unsubscribe();
  },[]);
  
  // Load quotes when user logs in
  const loadUserQuotes=async(userId)=>{
    setLoadingQuotes(true);
    const{data,error}=await QuoteStorage.loadQuotes(userId);
    if(!error&&data){
      setSavedQuotes(data);
    }
    // Also load templates
    const templates=await QuoteStorage.loadTemplates(userId);
    if(templates.data){
      setSavedTemplates(templates.data);
    }
    // Also load customers
    const customersResult=await CustomerStorage.loadCustomers(userId);
    if(customersResult.data){
      setCustomers(customersResult.data);
    }
    setLoadingQuotes(false);
  };
  
  // Auth handlers
  const handleSignIn=async(e)=>{
    e.preventDefault();
    setAuthError('');
    const{error}=await SupabaseAuth.signIn(authEmail,authPassword);
    if(error)setAuthError(error.message);
    else{setAuthEmail('');setAuthPassword('');}
  };
  
  const handleSignUp=async(e)=>{
    e.preventDefault();
    setAuthError('');
    // Validate required fields
    if(!authFirstName.trim()||!authLastName.trim()||!authPhone.trim()){
      setAuthError('Please fill in all required fields');
      return;
    }
    const{error}=await SupabaseAuth.signUp(authEmail,authPassword,{
      first_name: authFirstName.trim(),
      last_name: authLastName.trim(),
      phone: authPhone.trim()
    });
    if(error)setAuthError(error.message);
    else{
      setAuthError('Check your email for confirmation link');
      setAuthView('login');
      setAuthFirstName('');
      setAuthLastName('');
      setAuthPhone('');
    }
  };
  
  const handleSignOut=async()=>{
    await SupabaseAuth.signOut();
    setSavedQuotes([]);
    setCurrentQuoteId(null);
  };
  
  // Quote management
  // Validation errors state
  const[validationErrors,setValidationErrors]=useState({});
  
  // Validation error popup state
  const[showValidationPopup,setShowValidationPopup]=useState(false);
  
  // Save popup state
  const[showSavePopup,setShowSavePopup]=useState(false);
  const[saveQuoteTitle,setSaveQuoteTitle]=useState('');
  const[quoteVersion,setQuoteVersion]=useState(1);
  const[quoteStatus,setQuoteStatus]=useState('Draft'); // Draft, Final, Change Order
  const[saveMode,setSaveMode]=useState('update'); // 'update' or 'new'
  const[isTemplate,setIsTemplate]=useState(false); // Is current quote a template?
  
  // Version history
  const[quoteVersionHistory,setQuoteVersionHistory]=useState([]);
  const[showVersionDropdown,setShowVersionDropdown]=useState(false);
  
  // Unsaved changes tracking
  const[hasUnsavedChanges,setHasUnsavedChanges]=useState(false);
  const[showUnsavedWarning,setShowUnsavedWarning]=useState(false);
  const[pendingNavigation,setPendingNavigation]=useState(null);
  
  // Undo/Redo state
  const[undoStack,setUndoStack]=useState([]);
  const[redoStack,setRedoStack]=useState([]);
  const[isUndoRedo,setIsUndoRedo]=useState(false);
  
  // Customers state
  const[customers,setCustomers]=useState([]);
  const[industries,setIndustries]=useState(DEFAULT_INDUSTRIES);
  const[showCustomerSelect,setShowCustomerSelect]=useState(false);
  
  // Copy quote popup state
  const[showCopyQuotePopup,setShowCopyQuotePopup]=useState(false);
  const[copyQuoteSource,setCopyQuoteSource]=useState(null);
  const[copyQuoteData,setCopyQuoteData]=useState({customerName:'',projectName:'',status:'Draft',date:new Date().toISOString().split('T')[0]});
  const[showCopyAddCustomer,setShowCopyAddCustomer]=useState(false);
  const[copyNewCustomer,setCopyNewCustomer]=useState({name:'',industry:'General Contractor',annual_revenue:'',software:'',contacts:[]});
  
  // Track form changes for unsaved warning
  useEffect(()=>{
    // Only mark as unsaved if we have a quote loaded or data entered
    if(quoteCustomerName || quoteProjectName || Object.keys(quoteBoxInputs).length>0){
      setHasUnsavedChanges(true);
    }
  },[quoteCustomerName,quoteProjectName,quoteGlobals,quoteMargins,quoteBoxInputs,flexTasks,quoteVisibleLevels]);
  
  // Generate default quote title
  const generateQuoteTitle=()=>{
    const date=quoteDate||new Date().toISOString().split('T')[0];
    return `${quoteCustomerName||'Client'} - ${quoteProjectName||'Project'} - ${date} Quote`;
  };
  
  // Trigger save popup (validation first)
  const saveCurrentQuote=()=>{
    if(!user)return;
    
    // No validation required - customer and project are optional
    setValidationErrors({});
    // Set default title and show save popup
    setSaveQuoteTitle(generateQuoteTitle());
    setShowSavePopup(true);
  };
  
  // Actually save the quote
  const confirmSaveQuote=async()=>{
    setSavingQuote(true);
    const isNew=!currentQuoteId;
    // If updating current version, keep same version number; if creating new version, increment
    const newVersion=isNew?1:(saveMode==='new'?quoteVersion+1:quoteVersion);
    
    // If creating new version, save current state to version history first
    if(!isNew && saveMode==='new'){
      const currentSnapshot={
        version:quoteVersion,
        title:saveQuoteTitle,
        status:quoteStatus,
        customerName:quoteCustomerName,
        projectName:quoteProjectName,
        globals:quoteGlobals,
        margins:quoteMargins,
        boxInputs:quoteBoxInputs,
        flexTasks:flexTasks,
        visibleLevels:quoteVisibleLevels,
        savedAt:new Date().toISOString()
      };
      setQuoteVersionHistory(prev=>[...prev,currentSnapshot]);
    }
    
    const quoteData={
      id:saveMode==='new'?null:currentQuoteId, // New ID for new version
      parentQuoteId:saveMode==='new'?currentQuoteId:null,
      title:saveQuoteTitle,
      customerName:isTemplate?'__TEMPLATE__':quoteCustomerName,
      projectName:quoteProjectName,
      globals:quoteGlobals,
      margins:quoteMargins,
      boxInputs:quoteBoxInputs,
      flexTasks:flexTasks,
      visibleLevels:quoteVisibleLevels,
      status:quoteStatus,
      version:newVersion,
      versionHistory:quoteVersionHistory,
      isTemplate:isTemplate,
      templateName:isTemplate?quoteProjectName:'',
      templateDescription:''
    };
    const{data,error}=await QuoteStorage.saveQuote(user.id,quoteData);
    if(!error&&data){
      setCurrentQuoteId(data.id);
      setQuoteVersion(newVersion);
      setHasUnsavedChanges(false);
      loadUserQuotes(user.id);
      // Log audit
      const entityType=isTemplate?'template':'quote';
      logAudit(
        isNew?(isTemplate?'template_created':'quote_created'):(saveMode==='new'?'quote_version_created':'quote_updated'),
        entityType,
        data.id,
        null,
        {title:saveQuoteTitle,version:newVersion,status:quoteStatus},
        `${isNew?'Created':saveMode==='new'?'Created new version':'Updated'} ${isTemplate?'template':'quote'} v${newVersion}: ${saveQuoteTitle}`
      );
      // Navigate back to appropriate list
      setView(isTemplate?'templates':'quotes');
      // Reset quote state
      setCurrentQuoteId(null);
      setQuoteCustomerName('');
      setQuoteProjectName('');
      setIsTemplate(false);
    }
    setSavingQuote(false);
    setShowSavePopup(false);
    setSaveMode('update'); // Reset to default
  };
  
  const loadQuote=(quote)=>{
    setCurrentQuoteId(quote.id);
    setQuoteCustomerName(quote.customer_name||'');
    setQuoteProjectName(quote.project_name||'');
    setQuoteGlobals(quote.globals||{software:'Quickbooks Online',staff_quality:'No Skills/Good Attitude',annual_revenue:'$5M - $10M',payroll_frequency:'Weekly',concurrent_jobs:10,employees:50});
    setQuoteMargins(quote.margins||{1:100,2:100,3:100});
    setQuoteBoxInputs(quote.box_inputs||{});
    setFlexTasks(quote.flex_tasks||{});
    setQuoteVisibleLevels(quote.visible_levels||[1,2,3]);
    setQuoteVersion(quote.version||1);
    setQuoteStatus(quote.status||'Draft');
    setSaveQuoteTitle(quote.title||quote.template_name||'');
    setQuoteVersionHistory(quote.version_history||[]);
    setIsTemplate(quote.is_template||false);
    setHasUnsavedChanges(false);
    setShowQuoteManager(false);
    setView('quote');
    // Clear undo/redo stacks when loading new quote
    setUndoStack([]);
    setRedoStack([]);
  };
  
  // Load a specific version from history
  const loadVersionFromHistory=(versionData)=>{
    setQuoteCustomerName(versionData.customerName||'');
    setQuoteProjectName(versionData.projectName||'');
    setQuoteGlobals(versionData.globals||{});
    setQuoteMargins(versionData.margins||{1:100,2:100,3:100});
    setQuoteBoxInputs(versionData.boxInputs||{});
    setFlexTasks(versionData.flexTasks||{});
    setQuoteVisibleLevels(versionData.visibleLevels||[1,2,3]);
    setQuoteVersion(versionData.version);
    setQuoteStatus(versionData.status||'Draft');
    setSaveQuoteTitle(versionData.title||'');
    setHasUnsavedChanges(true); // Mark as unsaved since we're loading old version
    setShowVersionDropdown(false);
  };
  
  const deleteQuote=async(quoteId)=>{
    if(!confirm('Delete this quote?'))return;
    const deletedQuote=savedQuotes.find(q=>q.id===quoteId);
    await QuoteStorage.deleteQuote(quoteId);
    if(currentQuoteId===quoteId)setCurrentQuoteId(null);
    loadUserQuotes(user.id);
    // Log audit
    logAudit(
      'quote_deleted',
      'quote',
      quoteId,
      {customerName:deletedQuote?.customer_name,projectName:deletedQuote?.project_name},
      null,
      `Deleted quote: ${deletedQuote?.customer_name||'Untitled'} - ${deletedQuote?.project_name||'No Project'}`
    );
  };
  
  // Open copy quote popup
  const copyQuote=(quote)=>{
    setCopyQuoteSource(quote);
    setCopyQuoteData({
      customerName:quote.customer_name||'',
      projectName:quote.project_name||'',
      status:'Draft',
      date:new Date().toISOString().split('T')[0]
    });
    setShowCopyQuotePopup(true);
  };
  
  // Actually perform the copy
  const confirmCopyQuote=async()=>{
    const isNewCustomer=!customers.find(c=>c.name===copyQuoteData.customerName);
    const copyData={
      title:`${copyQuoteData.customerName} - ${copyQuoteData.projectName} - ${copyQuoteData.date} Quote`,
      customerName:copyQuoteData.customerName,
      projectName:copyQuoteData.projectName,
      globals:copyQuoteSource.globals,
      margins:copyQuoteSource.margins,
      boxInputs:copyQuoteSource.box_inputs,
      flexTasks:copyQuoteSource.flex_tasks,
      visibleLevels:copyQuoteSource.visible_levels,
      status:copyQuoteData.status,
      version:1
    };
    const{data,error}=await QuoteStorage.saveQuote(user.id,copyData);
    if(!error&&data){
      loadUserQuotes(user.id);
      logAudit(
        'quote_copied',
        'quote',
        data.id,
        null,
        {originalId:copyQuoteSource.id,title:copyData.title},
        `Copied quote: ${copyData.title}`
      );
      setShowCopyQuotePopup(false);
      setCopyQuoteSource(null);
    }
  };
  
  // Add customer from copy popup
  const handleCopyAddCustomer=()=>{
    if(!copyNewCustomer.name?.trim()||!copyNewCustomer.annual_revenue||!copyNewCustomer.software)return;
    const newCust={
      ...copyNewCustomer,
      id:'cust_'+Date.now(),
      created_at:new Date().toISOString(),
      updated_at:new Date().toISOString()
    };
    const updatedCustomers=[newCust,...customers];
    setCustomers(updatedCustomers);
    localStorage.setItem('rh_customers',JSON.stringify(updatedCustomers));
    setCopyQuoteData(prev=>({...prev,customerName:newCust.name}));
    setCopyNewCustomer({name:'',industry:'General Contractor',annual_revenue:'',software:'',contacts:[]});
    setShowCopyAddCustomer(false);
  };
  
  const newQuote=()=>{
    setCurrentQuoteId(null);
    setQuoteCustomerName('');
    setQuoteProjectName('');
    setQuoteGlobals({software:'Quickbooks Online',staff_quality:'No Skills/Good Attitude',annual_revenue:'$5M - $10M',payroll_frequency:'Weekly',concurrent_jobs:10,employees:50});
    setQuoteMargins({1:100,2:100,3:100});
    // Reset box inputs
    const b={1:{},2:{},3:{}};
    tasks.forEach(t=>{[1,2,3].forEach(l=>{
      b[l][t.key]={enabled:true,adjHours:Object.fromEntries(Object.keys(roles).map(r=>[r,'']))};
      t.variables.forEach(v=>{b[l][t.key][v.key]=v.default});
    })});
    setQuoteBoxInputs(b);
    setFlexTasks({});
    setQuoteVisibleLevels([1,2,3]);
    setQuoteVersion(1);
    setQuoteStatus('Draft');
    setQuoteVersionHistory([]);
    setHasUnsavedChanges(false);
    setIsTemplate(false);
    setShowQuoteManager(false);
    setView('quote');
  };
  
  const newTemplate=()=>{
    setCurrentQuoteId(null);
    setQuoteCustomerName('__TEMPLATE__'); // Hidden template customer
    setQuoteProjectName('');
    setQuoteGlobals({software:'Quickbooks Online',staff_quality:'No Skills/Good Attitude',annual_revenue:'$5M - $10M',payroll_frequency:'Weekly',concurrent_jobs:10,employees:50});
    setQuoteMargins({1:100,2:100,3:100});
    // Reset box inputs
    const b={1:{},2:{},3:{}};
    tasks.forEach(t=>{[1,2,3].forEach(l=>{
      b[l][t.key]={enabled:true,adjHours:Object.fromEntries(Object.keys(roles).map(r=>[r,'']))};
      t.variables.forEach(v=>{b[l][t.key][v.key]=v.default});
    })});
    setQuoteBoxInputs(b);
    setFlexTasks({});
    setQuoteVisibleLevels([1,2,3]);
    setQuoteVersion(1);
    setQuoteStatus('Draft');
    setQuoteVersionHistory([]);
    setHasUnsavedChanges(false);
    setIsTemplate(true);
    setShowQuoteManager(false);
    setView('quote');
  };
  
  // Close quote/template and reset state
  const closeQuote=()=>{
    // Reset all quote state to defaults
    setCurrentQuoteId(null);
    setQuoteCustomerName('');
    setQuoteProjectName('');
    setQuoteGlobals({software:'Quickbooks Online',staff_quality:'No Skills/Good Attitude',annual_revenue:'$5M - $10M',payroll_frequency:'Weekly',concurrent_jobs:10,employees:50});
    setQuoteMargins({1:100,2:100,3:100});
    const b={1:{},2:{},3:{}};
    tasks.forEach(t=>{[1,2,3].forEach(l=>{
      b[l][t.key]={enabled:true,adjHours:Object.fromEntries(Object.keys(roles).map(r=>[r,'']))};
      t.variables.forEach(v=>{b[l][t.key][v.key]=v.default});
    })});
    setQuoteBoxInputs(b);
    setFlexTasks({});
    setQuoteVisibleLevels([1,2,3]);
    setQuoteVersion(1);
    setQuoteStatus('Draft');
    setQuoteVersionHistory([]);
    setHasUnsavedChanges(false);
    setIsTemplate(false);
    setSaveQuoteTitle('');
    setView('home');
  };
  
  // Apply current template to create a new quote
  const[showApplyTemplatePopup,setShowApplyTemplatePopup]=useState(false);
  const[applyTemplateData,setApplyTemplateData]=useState({customerName:'',projectName:'',status:'Draft',date:new Date().toISOString().split('T')[0]});
  
  const applyCurrentTemplate=()=>{
    // Open popup to create quote from current template
    setApplyTemplateData({customerName:'',projectName:'',status:'Draft',date:new Date().toISOString().split('T')[0]});
    setShowApplyTemplatePopup(true);
  };
  
  const confirmApplyTemplate=async()=>{
    // Create a new quote from current template data
    const quoteData={
      isTemplate: false,
      title: applyTemplateData.customerName && applyTemplateData.projectName 
        ? `${applyTemplateData.customerName} - ${applyTemplateData.projectName} - ${applyTemplateData.date} Quote`
        : `New Quote - ${applyTemplateData.date}`,
      customerName: applyTemplateData.customerName,
      projectName: applyTemplateData.projectName,
      globals: quoteGlobals,
      margins: quoteMargins,
      boxInputs: quoteBoxInputs,
      flexTasks: flexTasks,
      visibleLevels: quoteVisibleLevels,
      status: applyTemplateData.status,
      version: 1,
      versionHistory: []
    };
    const{data,error}=await QuoteStorage.saveQuote(user.id,quoteData);
    if(!error&&data){
      logAudit('quote_from_template','quote',data.id,null,{title:quoteData.title},'Created quote from template');
      // Load the new quote
      setCurrentQuoteId(data.id);
      setQuoteCustomerName(applyTemplateData.customerName);
      setQuoteProjectName(applyTemplateData.projectName);
      setQuoteStatus(applyTemplateData.status);
      setQuoteVersion(1);
      setQuoteVersionHistory([]);
      setIsTemplate(false);
      setHasUnsavedChanges(false);
      loadUserQuotes(user.id);
    }
    setShowApplyTemplatePopup(false);
  };

  const[view,setView]=useState('home');
  const[adminTab,setAdminTab]=useState('settings');
  const[roles,setRoles]=useState(DEFAULT_ROLES);
  const[variables,setVariables]=useState(DEFAULT_VARIABLES);
  const[tasks,setTasks]=useState(DEFAULT_TASKS);
  const[levels,setLevels]=useState(DEFAULT_LEVELS);
  const[saveVersion,setSaveVersion]=useState(0);
  const[sidebarPinned,setSidebarPinned]=useState(true);
  const[sidebarHover,setSidebarHover]=useState(false);
  const[adminHasChanges,setAdminHasChanges]=useState(false);
  const[appWindowWidth,setAppWindowWidth]=useState(typeof window!=='undefined'?window.innerWidth:1200);
  
  // Track window width and auto pin/unpin menu
  useEffect(()=>{
    const handleResize=()=>{
      const w=window.innerWidth;
      setAppWindowWidth(w);
      if(w<1250){
        setSidebarPinned(false);
      }else{
        setSidebarPinned(true);
      }
    };
    window.addEventListener('resize',handleResize);
    handleResize(); // Check on mount
    return()=>window.removeEventListener('resize',handleResize);
  },[]);
  
  // Settings state
  const[settings,setSettings]=useState({
    enableFlexTasks:true,
    defaultFlexHammerTime:'OH.080'
  });
  
  // Flex tasks state: {section: [{id, name, hours: {1:{role:hours}, 2:{}, 3:{}}, hammerTime}]}
  const[flexTasks,setFlexTasks]=useState({});
  
  // Quote Builder state lifted to App level to persist across tab switches
  const[quoteGlobals,setQuoteGlobals]=useState({
    software:'Quickbooks Online',
    staff_quality:'No Skills/Good Attitude',
    annual_revenue:'$5M - $10M',
    payroll_frequency:'Weekly',
    concurrent_jobs:10,
    employees:50
  });
  const[quoteBoxInputs,setQuoteBoxInputs]=useState(()=>{
    const b={1:{},2:{},3:{}};
    DEFAULT_TASKS.forEach(t=>{[1,2,3].forEach(l=>{
      b[l][t.key]={enabled:true,adjHours:Object.fromEntries(Object.keys(DEFAULT_ROLES).map(r=>[r,'']))};
      t.variables.forEach(v=>{b[l][t.key][v.key]=v.default});
    })});
    return b;
  });
  const[quoteMargins,setQuoteMargins]=useState({1:100,2:100,3:100});
  const[quoteCustomerName,setQuoteCustomerName]=useState('');
  const[quoteProjectName,setQuoteProjectName]=useState('');
  const[quoteDate,setQuoteDate]=useState(new Date().toISOString().split('T')[0]);
  const[quoteVisibleLevels,setQuoteVisibleLevels]=useState([1,2,3]);
  const[quoteExpandedTasks,setQuoteExpandedTasks]=useState(new Set());
  const[quoteActiveSection,setQuoteActiveSection]=useState('ap');
  
  // Comments state
  const[taskComments,setTaskComments]=useState({}); // {taskKey: [{id,user,content,createdAt,mentions}]}
  const[commentModalTask,setCommentModalTask]=useState(null); // task key for open comment modal
  const[newCommentText,setNewCommentText]=useState('');
  const[showMentionList,setShowMentionList]=useState(false);
  const[mentionSearch,setMentionSearch]=useState('');
  
  // Team state
  const[team,setTeam]=useState(null);
  const[teamMembers,setTeamMembers]=useState([]);
  const[showTeamModal,setShowTeamModal]=useState(false);
  const[inviteEmail,setInviteEmail]=useState('');
  const[inviteRole,setInviteRole]=useState('member');
  const[pendingInvites,setPendingInvites]=useState([]);
  
  // Audit log state
  const[auditLog,setAuditLog]=useState([]);
  const[showAuditLog,setShowAuditLog]=useState(false);
  
  // Audit log helper function
  const logAudit=(action,entityType,entityId,oldValue,newValue,details='')=>{
    const entry={
      id:Date.now(),
      userId:user?.id||'local',
      userEmail:user?.email||'Local User',
      action,
      entityType,
      entityId,
      oldValue,
      newValue,
      details,
      createdAt:new Date().toISOString()
    };
    setAuditLog(prev=>[entry,...prev].slice(0,500)); // Keep last 500 entries
  };
  
  const sidebarOpen=sidebarPinned||sidebarHover;
  
  // Handle navigation with unsaved changes check
  const handleNavigation=(newView)=>{
    // Check for unsaved admin changes
    if(view==='admin'&&adminHasChanges){
      if(!window.confirm('You have unsaved admin changes. Are you sure you want to leave without saving?')){
        return;
      }
      setAdminHasChanges(false);
    }
    // Check for unsaved quote changes
    if(view==='quote'&&hasUnsavedChanges){
      setPendingNavigation(newView);
      setShowUnsavedWarning(true);
      return;
    }
    setView(newView);
  };
  
  const confirmNavigation=()=>{
    setHasUnsavedChanges(false);
    setShowUnsavedWarning(false);
    if(pendingNavigation){
      setView(pendingNavigation);
      setPendingNavigation(null);
    }
  };
  
  const cancelNavigation=()=>{
    setShowUnsavedWarning(false);
    setPendingNavigation(null);
  };

  // Show loading while checking auth
  if(authLoading){
    return(
      <div className="h-screen flex items-center justify-center bg-gray-100">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-rh-maroon border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-gray-600">Loading...</p>
        </div>
      </div>
    );
  }
  
  // Show login screen if not authenticated
  if(!user){
    return(
      <div className="min-h-screen flex items-center justify-center p-4" style={{backgroundColor:'#333'}}>
        <div className="bg-white rounded-xl shadow-lg max-w-md w-full overflow-hidden">
          <div className="p-6 text-center" style={{backgroundColor:'#333'}}>
            <img src="https://cdn.prod.website-files.com/5f165d4a54d5863dea0e4a83/6887f69d61ac9cf5c9c5cf43_RedHammer%20Logo%20%23333.jpg" alt="RedHammer" className="h-12 mx-auto mb-3 rounded"/>
            <h1 className="text-white text-xl font-bold">RedHammer Platform</h1>
            <p className="text-white/70 text-sm">Construction Accounting Services</p>
          </div>
          <div className="p-6">
            <h2 className="text-lg font-semibold text-gray-800 mb-1">Sign In</h2>
            <p className="text-sm text-gray-500 mb-6">Access is by invitation only</p>
            {authError&&<div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">{authError}</div>}
            <form onSubmit={handleSignIn}>
              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input type="email" value={authEmail} onChange={e=>setAuthEmail(e.target.value)} required className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rh-maroon focus:border-transparent"/>
              </div>
              <div className="mb-6">
                <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <input type="password" value={authPassword} onChange={e=>setAuthPassword(e.target.value)} required minLength={6} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rh-maroon focus:border-transparent"/>
              </div>
              <button type="submit" className="w-full bg-rh-maroon text-white py-3 rounded-lg font-medium hover:bg-rh-maroon-dark transition-colors">
                Sign In
              </button>
            </form>
            <p className="text-xs text-gray-400 text-center mt-6">
              Don't have an account? Contact your administrator for an invitation.
            </p>
          </div>
        </div>
      </div>
    );
  }
  
  return(
    <AppContext.Provider value={{
      view,setView,
      user,loadUserQuotes,
      roles,setRoles,variables,setVariables,tasks,setTasks,levels,setLevels,sections:DEFAULT_SECTIONS,saveVersion,setSaveVersion,
      adminHasChanges,setAdminHasChanges,
      settings,setSettings,flexTasks,setFlexTasks,
      quoteGlobals,setQuoteGlobals,quoteBoxInputs,setQuoteBoxInputs,quoteMargins,setQuoteMargins,
      quoteCustomerName,setQuoteCustomerName,quoteProjectName,setQuoteProjectName,
      quoteDate,setQuoteDate,
      quoteVisibleLevels,setQuoteVisibleLevels,quoteExpandedTasks,setQuoteExpandedTasks,
      quoteActiveSection,setQuoteActiveSection,
      currentQuoteId,setCurrentQuoteId,
      taskComments,setTaskComments,commentModalTask,setCommentModalTask,
      newCommentText,setNewCommentText,showMentionList,setShowMentionList,mentionSearch,setMentionSearch,
      team,teamMembers,showTeamModal,setShowTeamModal,inviteEmail,setInviteEmail,
      inviteRole,setInviteRole,pendingInvites,
      auditLog,setAuditLog,logAudit,showAuditLog,setShowAuditLog,
      validationErrors,setValidationErrors,showValidationPopup,setShowValidationPopup,
      showSavePopup,setShowSavePopup,saveQuoteTitle,setSaveQuoteTitle,quoteVersion,setQuoteVersion,
      quoteStatus,setQuoteStatus,confirmSaveQuote,generateQuoteTitle,
      saveMode,setSaveMode,quoteVersionHistory,setQuoteVersionHistory,
      hasUnsavedChanges,setHasUnsavedChanges,showVersionDropdown,setShowVersionDropdown,
      undoStack,setUndoStack,redoStack,setRedoStack,
      customers,setCustomers,showCustomerSelect,setShowCustomerSelect,industries,setIndustries,
      savedQuotes,savedTemplates,loadQuote,deleteQuote,newQuote,newTemplate,copyQuote,loadVersionFromHistory,closeQuote,applyCurrentTemplate,
      isTemplate,setIsTemplate,saveCurrentQuote,savingQuote,
      showCopyQuotePopup,setShowCopyQuotePopup,copyQuoteData,setCopyQuoteData,confirmCopyQuote,
      showCopyAddCustomer,setShowCopyAddCustomer,copyNewCustomer,setCopyNewCustomer,handleCopyAddCustomer
    }}>
      {/* Save Quote Popup */}
      {showSavePopup && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={()=>setShowSavePopup(false)}>
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden" onClick={e=>e.stopPropagation()}>
            <div className="px-4 py-3 text-white flex items-center gap-3" style={{backgroundColor:isTemplate?'#333':'#333'}}>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
              <span className="font-semibold">{isTemplate?'Save Template':'Save Quote'}</span>
            </div>
            <div className="p-5 space-y-4">
              {/* Save Mode Toggle - only show for existing quotes */}
              {currentQuoteId && (
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Save Mode</label>
                  <div className="flex gap-2">
                    <button
                      onClick={()=>setSaveMode('update')}
                      className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                        saveMode==='update'
                          ? 'bg-gray-800 text-white border-2 border-gray-900'
                          : 'bg-gray-100 text-gray-600 border border-gray-300 hover:bg-gray-200'
                      }`}
                    >
                      Update v{quoteVersion}
                    </button>
                    <button
                      onClick={()=>setSaveMode('new')}
                      className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                        saveMode==='new'
                          ? 'bg-gray-800 text-white border-2 border-gray-900'
                          : 'bg-gray-100 text-gray-600 border border-gray-300 hover:bg-gray-200'
                      }`}
                    >
                      Create v{quoteVersion+1}
                    </button>
                  </div>
                  <p className="text-xs text-gray-500 mt-1">
                    {saveMode==='update' ? 'Overwrites current version' : 'Creates a new version, preserving current version in history'}
                  </p>
                </div>
              )}
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">{isTemplate?'Template Name':'Quote Title'}</label>
                <input 
                  type="text" 
                  value={saveQuoteTitle} 
                  onChange={e=>setSaveQuoteTitle(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder={isTemplate?"Enter template name...":"Enter quote title..."}
                />
                <button 
                  onClick={()=>setSaveQuoteTitle(generateQuoteTitle())}
                  className="mt-1 text-xs text-blue-600 hover:underline"
                >
                  Reset to default title
                </button>
              </div>
              
              {/* Status - only show for quotes, not templates */}
              {!isTemplate && (
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <div className="flex gap-2">
                  {['Draft','Final','Change Order'].map(s=>(
                    <button
                      key={s}
                      onClick={()=>setQuoteStatus(s)}
                      className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                        quoteStatus===s
                          ? (s==='Draft'?'bg-yellow-500 text-white border-2 border-yellow-600'
                            : s==='Final'?'bg-green-600 text-white border-2 border-green-700'
                            : 'bg-blue-600 text-white border-2 border-blue-700')
                          : 'bg-gray-100 text-gray-600 border border-gray-300 hover:bg-gray-200'
                      }`}
                    >
                      {s}
                    </button>
                  ))}
                </div>
              </div>
              )}
              
              <div className="bg-gray-50 rounded-lg p-3 text-sm">
                {isTemplate ? (
                  <>
                    <div className="flex justify-between text-gray-600 mb-1">
                      <span>Template Name:</span>
                      <span className="font-medium text-gray-800">{quoteProjectName||'Untitled'}</span>
                    </div>
                    <div className="flex justify-between text-gray-600">
                      <span>Version:</span>
                      <span className="font-medium text-gray-800">
                        {!currentQuoteId ? 'v1 (New)' : saveMode==='update' ? `v${quoteVersion} (Update)` : `v${quoteVersion} → v${quoteVersion+1}`}
                      </span>
                    </div>
                  </>
                ) : (
                  <>
                    <div className="flex justify-between text-gray-600 mb-1">
                      <span>Customer:</span>
                      <span className="font-medium text-gray-800">{quoteCustomerName||'No customer'}</span>
                    </div>
                    <div className="flex justify-between text-gray-600 mb-1">
                      <span>Project:</span>
                      <span className="font-medium text-gray-800">{quoteProjectName||'No project'}</span>
                    </div>
                    <div className="flex justify-between text-gray-600">
                      <span>Version:</span>
                      <span className="font-medium text-gray-800">
                        {!currentQuoteId ? 'v1 (New)' : saveMode==='update' ? `v${quoteVersion} (Update)` : `v${quoteVersion} → v${quoteVersion+1}`}
                      </span>
                    </div>
                  </>
                )}
              </div>
              
              <div className="flex gap-3 pt-2">
                <button 
                  onClick={()=>setShowSavePopup(false)}
                  className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50"
                >
                  Cancel
                </button>
                <button 
                  onClick={confirmSaveQuote}
                  disabled={savingQuote}
                  className="flex-1 px-4 py-2 text-white rounded-lg font-medium hover:opacity-90 disabled:opacity-50 flex items-center justify-center gap-2"
                  style={{backgroundColor:isTemplate?'#333':'#802629'}}
                >
                  {savingQuote ? (
                    <>
                      <svg className="animate-spin h-4 w-4" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                      Saving...
                    </>
                  ) : isTemplate ? 'Save Template' : 'Save Quote'}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
      
      {/* Apply Template Popup */}
      {showApplyTemplatePopup && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={()=>setShowApplyTemplatePopup(false)}>
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden" onClick={e=>e.stopPropagation()}>
            <div className="px-4 py-3 bg-[#333] text-white flex items-center gap-3">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
              <span className="font-semibold">Apply Template</span>
            </div>
            <div className="p-5 space-y-4">
              <p className="text-sm text-gray-600">Create a new quote using this template's settings.</p>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Customer (optional)</label>
                <select 
                  value={applyTemplateData.customerName} 
                  onChange={e=>setApplyTemplateData(p=>({...p,customerName:e.target.value}))}
                  className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"
                >
                  <option value="">No customer</option>
                  {customers.filter(c=>c.name!=='__TEMPLATE__').map(c=><option key={c.id} value={c.name}>{c.name}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Project Name (optional)</label>
                <input 
                  type="text" 
                  value={applyTemplateData.projectName} 
                  onChange={e=>setApplyTemplateData(p=>({...p,projectName:e.target.value}))}
                  className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"
                  placeholder="Enter project name..."
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Date</label>
                <input 
                  type="date" 
                  value={applyTemplateData.date} 
                  onChange={e=>setApplyTemplateData(p=>({...p,date:e.target.value}))}
                  className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <div className="flex gap-2">
                  {['Draft','Final','Change Order'].map(s=>(
                    <button
                      key={s}
                      onClick={()=>setApplyTemplateData(p=>({...p,status:s}))}
                      className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                        applyTemplateData.status===s
                          ? (s==='Draft'?'bg-yellow-500 text-white border-2 border-yellow-600'
                            : s==='Final'?'bg-green-600 text-white border-2 border-green-700'
                            : 'bg-blue-600 text-white border-2 border-blue-700')
                          : 'bg-gray-100 text-gray-600 border border-gray-300 hover:bg-gray-200'
                      }`}
                    >
                      {s}
                    </button>
                  ))}
                </div>
              </div>
              <div className="flex gap-3 pt-2">
                <button 
                  onClick={()=>setShowApplyTemplatePopup(false)}
                  className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50"
                >
                  Cancel
                </button>
                <button 
                  onClick={confirmApplyTemplate}
                  className="flex-1 px-4 py-2 bg-[#333] hover:bg-[#444] text-white rounded-lg font-medium"
                >
                  Create Quote
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
      
      {/* Copy Quote Popup */}
      {showCopyQuotePopup && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={()=>setShowCopyQuotePopup(false)}>
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden" onClick={e=>e.stopPropagation()}>
            <div className="px-4 py-3 text-white flex items-center gap-3" style={{backgroundColor:'#802629'}}>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
              <span className="font-semibold">Copy Quote</span>
            </div>
            <div className="p-5 space-y-4">
              <div className="bg-gray-50 rounded-lg p-3 text-sm mb-4">
                <p className="text-gray-600">Copying from: <span className="font-medium text-gray-800">{copyQuoteSource?.title||copyQuoteSource?.customer_name}</span></p>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Customer *</label>
                <div className="flex gap-2">
                  <select 
                    value={copyQuoteData.customerName}
                    onChange={e=>{
                      if(e.target.value==='__ADD_NEW__'){
                        setShowCopyAddCustomer(true);
                      }else{
                        setCopyQuoteData(prev=>({...prev,customerName:e.target.value}));
                      }
                    }}
                    className="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
                  >
                    <option value="">Select customer...</option>
                    {customers.map(c=>(<option key={c.id} value={c.name}>{c.name}</option>))}
                    <option value="__ADD_NEW__">+ Add New Customer</option>
                  </select>
                </div>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Project Name *</label>
                <input 
                  type="text"
                  value={copyQuoteData.projectName}
                  onChange={e=>setCopyQuoteData(prev=>({...prev,projectName:e.target.value}))}
                  className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"
                  placeholder="Enter project name..."
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Date</label>
                <input 
                  type="date"
                  value={copyQuoteData.date}
                  onChange={e=>setCopyQuoteData(prev=>({...prev,date:e.target.value}))}
                  className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <div className="flex gap-2">
                  {['Draft','Final','Change Order'].map(s=>(
                    <button
                      key={s}
                      onClick={()=>setCopyQuoteData(prev=>({...prev,status:s}))}
                      className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                        copyQuoteData.status===s
                          ? (s==='Draft'?'bg-yellow-500 text-white'
                            : s==='Final'?'bg-green-600 text-white'
                            : 'bg-blue-600 text-white')
                          : 'bg-gray-100 text-gray-600 border border-gray-300 hover:bg-gray-200'
                      }`}
                    >
                      {s}
                    </button>
                  ))}
                </div>
              </div>
              
              <div className="bg-gray-100 rounded-lg p-3 text-sm text-gray-700">
                <p>This will create a new quote at <strong>Version 1</strong></p>
              </div>
              
              <div className="flex gap-3 pt-2">
                <button 
                  onClick={()=>{setShowCopyQuotePopup(false);setCopyQuoteSource(null);}}
                  className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50"
                >
                  Cancel
                </button>
                <button 
                  onClick={confirmCopyQuote}
                  disabled={!copyQuoteData.customerName||!copyQuoteData.projectName}
                  className="flex-1 px-4 py-2 text-white rounded-lg font-medium hover:opacity-90 disabled:opacity-50"
                  style={{backgroundColor:'#802629'}}
                >
                  Copy Quote
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
      
      {/* Add Customer from Copy Popup */}
      {showCopyAddCustomer && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[60]" onClick={()=>setShowCopyAddCustomer(false)}>
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-hidden" onClick={e=>e.stopPropagation()}>
            <div className="px-4 py-3 text-white flex items-center justify-between" style={{backgroundColor:'#802629'}}>
              <span className="font-semibold">Add New Customer</span>
              <button onClick={()=>setShowCopyAddCustomer(false)} className="text-white/70 hover:text-white"><CloseIcon/></button>
            </div>
            <div className="p-5 overflow-y-auto max-h-[60vh]">
              <div className="grid grid-cols-2 gap-4">
                <div className="col-span-2">
                  <label className={`block text-sm font-medium mb-1 ${!copyNewCustomer.name?.trim()?'text-red-600':'text-gray-700'}`}>Company Name *</label>
                  <input type="text" value={copyNewCustomer.name} onChange={e=>setCopyNewCustomer(prev=>({...prev,name:e.target.value}))} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="Company name" autoFocus/>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Industry</label>
                  <select value={copyNewCustomer.industry} onChange={e=>setCopyNewCustomer(prev=>({...prev,industry:e.target.value}))} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                    <option value="">Select industry...</option>
                    {(industries||DEFAULT_INDUSTRIES).map(ind=>(<option key={ind} value={ind}>{ind}</option>))}
                  </select>
                </div>
                <div>
                  <label className={`block text-sm font-medium mb-1 ${!copyNewCustomer.annual_revenue?'text-red-600':'text-gray-700'}`}>Annual Revenue *</label>
                  <select value={copyNewCustomer.annual_revenue} onChange={e=>setCopyNewCustomer(prev=>({...prev,annual_revenue:e.target.value}))} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                    <option value="">Select revenue...</option>
                    <option>Under $1M</option>
                    <option>$1M - $5M</option>
                    <option>$5M - $10M</option>
                    <option>$10M - $25M</option>
                    <option>$25M - $50M</option>
                    <option>$50M - $100M</option>
                    <option>$100M - $250M</option>
                    <option>Over $250M</option>
                  </select>
                </div>
                <div className="col-span-2">
                  <label className={`block text-sm font-medium mb-1 ${!copyNewCustomer.software?'text-red-600':'text-gray-700'}`}>Software *</label>
                  <select value={copyNewCustomer.software} onChange={e=>setCopyNewCustomer(prev=>({...prev,software:e.target.value}))} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                    <option value="">Select software...</option>
                    {DEFAULT_SOFTWARE.map(s=>(<option key={s} value={s}>{s}</option>))}
                  </select>
                </div>
              </div>
            </div>
            <div className="px-5 py-4 bg-gray-50 border-t border-gray-200 flex items-center justify-between">
              <span className="text-xs text-gray-500">* Required fields</span>
              <div className="flex gap-3">
                <button onClick={()=>setShowCopyAddCustomer(false)} className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-100">Cancel</button>
                <button onClick={handleCopyAddCustomer} disabled={!copyNewCustomer.name?.trim()||!copyNewCustomer.annual_revenue||!copyNewCustomer.software} className="px-4 py-2 text-white rounded-lg font-medium hover:opacity-90 disabled:opacity-50" style={{backgroundColor:'#802629'}}>Add Customer</button>
              </div>
            </div>
          </div>
        </div>
      )}
      
      {/* Unsaved Changes Warning Popup */}
      {showUnsavedWarning && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm mx-4 overflow-hidden">
            <div className="px-4 py-3 text-white flex items-center gap-3" style={{backgroundColor:'#802629'}}>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
              </svg>
              <span className="font-semibold">Unsaved Changes</span>
            </div>
            <div className="p-5">
              <p className="text-gray-700 mb-4">You have unsaved changes to this quote. What would you like to do?</p>
              <div className="flex flex-col gap-2">
                <button 
                  onClick={()=>{setShowUnsavedWarning(false);saveCurrentQuote();}}
                  className="w-full px-4 py-2 text-white rounded-lg font-medium hover:opacity-90"
                  style={{backgroundColor:'#802629'}}
                >
                  Save Changes
                </button>
                <button 
                  onClick={confirmNavigation}
                  className="w-full px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50"
                >
                  Discard & Continue
                </button>
                <button 
                  onClick={cancelNavigation}
                  className="w-full px-4 py-2 text-gray-500 hover:text-gray-700 text-sm"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
      
      {/* Validation Error Popup */}
      {showValidationPopup && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={()=>setShowValidationPopup(false)}>
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm mx-4 overflow-hidden" onClick={e=>e.stopPropagation()}>
            <div className="px-4 py-3 text-white flex items-center gap-3" style={{backgroundColor:'#802629'}}>
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
              <span className="font-semibold">Required Fields Missing</span>
            </div>
            <div className="p-5">
              <p className="text-gray-700 mb-4">Please fill in the following required fields before saving:</p>
              <ul className="space-y-2 mb-5">
                {validationErrors?.customerName && (
                  <li className="flex items-center gap-2" style={{color:'#802629'}}>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                    <span className="font-medium">Customer Name</span>
                  </li>
                )}
                {validationErrors?.projectName && (
                  <li className="flex items-center gap-2" style={{color:'#802629'}}>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                    <span className="font-medium">Project Name</span>
                  </li>
                )}
              </ul>
              <button 
                onClick={()=>setShowValidationPopup(false)} 
                className="w-full px-4 py-2 text-white rounded-lg font-medium hover:opacity-90"
                style={{backgroundColor:'#802629'}}
              >
                OK, I'll Fix It
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* Comment Modal */}
      {commentModalTask && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={()=>{setCommentModalTask(null);setNewCommentText('');}}>
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[80vh] flex flex-col" onClick={e=>e.stopPropagation()}>
            <div className="px-4 py-3 bg-[#333] text-white flex items-center justify-between rounded-t-xl">
              <div className="flex items-center gap-2">
                <CommentIcon/>
                <span className="font-semibold">Comments</span>
                <span className="text-sm text-gray-300">- {
                  commentModalTask==='quote_general'?'Quote Discussion':
                  commentModalTask?.startsWith('level_')?'Level '+commentModalTask.slice(-1)+' Discussion':
                  commentModalTask?.startsWith('module_')?DEFAULT_SECTIONS[commentModalTask.slice(7)]?.name+' Module':
                  DEFAULT_TASKS.find(t=>t.key===commentModalTask)?.name||commentModalTask
                }</span>
              </div>
              <button onClick={()=>{setCommentModalTask(null);setNewCommentText('');}} className="text-gray-400 hover:text-white"><CloseIcon/></button>
            </div>
            <div className="flex-1 overflow-y-auto p-4 space-y-3 min-h-[200px] max-h-[400px]">
              {(taskComments[commentModalTask]||[]).length===0 ? (
                <div className="text-center text-gray-400 py-8">No comments yet. Start the conversation!</div>
              ) : (
                (taskComments[commentModalTask]||[]).map((c,i)=>(
                  <div key={i} className="flex gap-3">
                    <div className="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-sm font-semibold text-gray-600">
                      {(c.userName||c.userEmail||'?')[0].toUpperCase()}
                    </div>
                    <div className="flex-1">
                      <div className="flex items-center gap-2">
                        <span className="font-medium text-gray-800">{c.userName||c.userEmail}</span>
                        <span className="text-xs text-gray-400">{new Date(c.createdAt).toLocaleString()}</span>
                      </div>
                      <div className="text-sm text-gray-600 mt-1" dangerouslySetInnerHTML={{__html:c.content.replace(/@(\w+)/g,'<span class="text-blue-600 font-medium">@$1</span>')}}></div>
                    </div>
                  </div>
                ))
              )}
            </div>
            <div className="p-4 border-t border-gray-200">
              <div className="flex gap-2">
                <div className="flex-1 relative">
                  <textarea 
                    value={newCommentText} 
                    onChange={e=>{
                      setNewCommentText(e.target.value);
                      // Check for @ mention
                      const lastAt=e.target.value.lastIndexOf('@');
                      if(lastAt!==-1){
                        const afterAt=e.target.value.slice(lastAt+1);
                        if(!afterAt.includes(' ')){
                          setShowMentionList(true);
                          setMentionSearch(afterAt.toLowerCase());
                        }else{
                          setShowMentionList(false);
                        }
                      }else{
                        setShowMentionList(false);
                      }
                    }}
                    placeholder="Add a comment... Use @ to mention someone"
                    className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
                    rows={2}
                  />
                  {showMentionList && teamMembers.length>0 && (
                    <div className="absolute bottom-full left-0 mb-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-32 overflow-y-auto w-48">
                      {teamMembers.filter(m=>m.email.toLowerCase().includes(mentionSearch)||m.name?.toLowerCase().includes(mentionSearch)).slice(0,5).map(m=>(
                        <button key={m.id} onClick={()=>{
                          const lastAt=newCommentText.lastIndexOf('@');
                          setNewCommentText(newCommentText.slice(0,lastAt)+'@'+m.name+' ');
                          setShowMentionList(false);
                        }} className="w-full px-3 py-2 text-left text-sm hover:bg-gray-50 flex items-center gap-2">
                          <span className="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-xs">{(m.name||m.email)[0].toUpperCase()}</span>
                          <span>{m.name||m.email}</span>
                        </button>
                      ))}
                      {teamMembers.length===0 && <div className="px-3 py-2 text-sm text-gray-400">No team members</div>}
                    </div>
                  )}
                </div>
                <button onClick={()=>{
                  if(!newCommentText.trim())return;
                  const newComment={
                    id:Date.now(),
                    userEmail:user?.email||'You',
                    userName:user?.email?.split('@')[0]||'You',
                    content:newCommentText.trim(),
                    createdAt:new Date().toISOString(),
                    mentions:newCommentText.match(/@(\w+)/g)||[]
                  };
                  setTaskComments(p=>({...p,[commentModalTask]:[...(p[commentModalTask]||[]),newComment]}));
                  // Log audit
                  logAudit(
                    'comment_added',
                    'comment',
                    commentModalTask,
                    null,
                    {content:newCommentText.trim().slice(0,100)},
                    `Added comment on ${commentModalTask}`
                  );
                  setNewCommentText('');
                }} className="px-4 py-2 bg-rh-maroon hover:bg-rh-maroon-dark text-white rounded-lg flex items-center gap-1 self-end">
                  <SendIcon/>
                </button>
              </div>
              <div className="mt-2 text-xs text-gray-400 flex items-center gap-1">
                <AtIcon/> Type @ to mention team members
              </div>
            </div>
          </div>
        </div>
      )}
      
      {/* Team Modal */}
      {showTeamModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={()=>setShowTeamModal(false)}>
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[80vh] flex flex-col" onClick={e=>e.stopPropagation()}>
            <div className="px-4 py-3 bg-[#333] text-white flex items-center justify-between rounded-t-xl">
              <div className="flex items-center gap-2">
                <TeamIcon/>
                <span className="font-semibold">Team Members</span>
              </div>
              <button onClick={()=>setShowTeamModal(false)} className="text-gray-400 hover:text-white"><CloseIcon/></button>
            </div>
            <div className="p-4 border-b border-gray-200">
              <h4 className="text-sm font-semibold text-gray-700 mb-2">Invite by Email</h4>
              <div className="flex gap-2">
                <input 
                  type="email" 
                  value={inviteEmail} 
                  onChange={e=>setInviteEmail(e.target.value)} 
                  placeholder="colleague@company.com" 
                  className="flex-1 px-3 py-2 border border-gray-200 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <select value={inviteRole} onChange={e=>setInviteRole(e.target.value)} className="px-3 py-2 border border-gray-200 rounded text-sm">
                  <option value="viewer">Viewer</option>
                  <option value="member">Member</option>
                  <option value="admin">Admin</option>
                </select>
                <button onClick={()=>{
                  if(!inviteEmail.trim())return;
                  setPendingInvites(p=>[...p,{email:inviteEmail,role:inviteRole,status:'pending',invitedAt:new Date().toISOString()}]);
                  // Log audit
                  logAudit(
                    'team_invite_sent',
                    'team',
                    inviteEmail,
                    null,
                    {email:inviteEmail,role:inviteRole},
                    `Invited ${inviteEmail} as ${inviteRole}`
                  );
                  setInviteEmail('');
                  alert('Invitation sent to '+inviteEmail+'! (Note: Email sending requires Supabase Edge Functions setup)');
                }} className="px-4 py-2 bg-rh-maroon hover:bg-rh-maroon-dark text-white rounded text-sm font-medium">
                  Invite
                </button>
              </div>
            </div>
            <div className="flex-1 overflow-y-auto p-4">
              <h4 className="text-sm font-semibold text-gray-700 mb-3">Current Members</h4>
              <div className="space-y-2">
                {/* Current user */}
                <div className="flex items-center gap-3 p-2 rounded-lg bg-gray-50">
                  <div className="w-10 h-10 rounded-full bg-rh-maroon flex items-center justify-center text-white font-semibold">
                    {(user?.email||'U')[0].toUpperCase()}
                  </div>
                  <div className="flex-1">
                    <div className="font-medium text-gray-800">{user?.email?.split('@')[0]||'You'}</div>
                    <div className="text-xs text-gray-500">{user?.email}</div>
                  </div>
                  <span className="text-xs px-2 py-1 bg-rh-maroon text-white rounded">Owner</span>
                </div>
                {/* Team members */}
                {teamMembers.filter(m=>m.id!==user?.id).map(m=>(
                  <div key={m.id} className="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50">
                    <div className="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 font-semibold">
                      {(m.name||m.email||'?')[0].toUpperCase()}
                    </div>
                    <div className="flex-1">
                      <div className="font-medium text-gray-800">{m.name||m.email?.split('@')[0]}</div>
                      <div className="text-xs text-gray-500">{m.email}</div>
                    </div>
                    <span className="text-xs px-2 py-1 bg-gray-200 text-gray-600 rounded capitalize">{m.role}</span>
                  </div>
                ))}
                {teamMembers.length===0 && (
                  <div className="text-center text-gray-400 py-4">No team members yet. Invite someone above!</div>
                )}
              </div>
              {pendingInvites.length>0 && (
                <>
                  <h4 className="text-sm font-semibold text-gray-700 mt-4 mb-3">Pending Invitations</h4>
                  <div className="space-y-2">
                    {pendingInvites.map((inv,i)=>(
                      <div key={i} className="flex items-center gap-3 p-2 rounded-lg bg-yellow-50 border border-yellow-200">
                        <div className="w-10 h-10 rounded-full bg-yellow-200 flex items-center justify-center text-yellow-700 font-semibold">
                          {inv.email[0].toUpperCase()}
                        </div>
                        <div className="flex-1">
                          <div className="font-medium text-gray-800">{inv.email}</div>
                          <div className="text-xs text-yellow-600">Pending • Sent {new Date(inv.invitedAt).toLocaleDateString()}</div>
                        </div>
                        <button onClick={()=>setPendingInvites(p=>p.filter((_,j)=>j!==i))} className="text-xs text-red-600 hover:text-red-800">Cancel</button>
                      </div>
                    ))}
                  </div>
                </>
              )}
            </div>
          </div>
        </div>
      )}
      
      {/* Quote Manager Modal */}
      {showQuoteManager&&(
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={()=>setShowQuoteManager(false)}>
          <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden" onClick={e=>e.stopPropagation()}>
            <div className="px-6 py-4 bg-gray-800 text-white flex items-center justify-between">
              <h2 className="font-bold text-lg">My Quotes</h2>
              <button onClick={()=>setShowQuoteManager(false)} className="text-white/60 hover:text-white">
                <CloseIcon/>
              </button>
            </div>
            <div className="p-4 border-b border-gray-200 flex justify-between items-center">
              <span className="text-sm text-gray-600">{savedQuotes.length} saved quote{savedQuotes.length!==1?'s':''}</span>
              <button onClick={newQuote} className="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 flex items-center gap-2">
                <PlusIcon/>New Quote
              </button>
            </div>
            <div className="overflow-y-auto max-h-[50vh]">
              {loadingQuotes?(
                <div className="p-8 text-center text-gray-500">Loading quotes...</div>
              ):savedQuotes.length===0?(
                <div className="p-8 text-center text-gray-500">No saved quotes yet</div>
              ):(
                <div className="divide-y divide-gray-100">
                  {savedQuotes.map(q=>(
                    <div key={q.id} className={`p-4 hover:bg-gray-50 flex items-center justify-between ${currentQuoteId===q.id?'bg-red-50':''}`}>
                      <div className="flex-1 cursor-pointer" onClick={()=>loadQuote(q)}>
                        <div className="font-medium text-gray-800">{q.customer_name||'Untitled'}{q.project_name?` - ${q.project_name}`:''}</div>
                        <div className="text-sm text-gray-500">Updated {new Date(q.updated_at).toLocaleDateString()}</div>
                      </div>
                      <div className="flex items-center gap-2">
                        {currentQuoteId===q.id&&<span className="px-2 py-1 bg-rh-maroon text-white text-xs rounded">Current</span>}
                        <button onClick={()=>loadQuote(q)} className="p-2 text-blue-600 hover:bg-gray-100 rounded">
                          <EditIcon/>
                        </button>
                        <button onClick={()=>deleteQuote(q.id)} className="p-2 text-red-600 hover:bg-red-50 rounded">
                          <TrashIcon/>
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>
      )}
      
      <div className="flex h-screen">
        <aside 
          className="steel-gradient text-white flex flex-col transition-all duration-200 flex-shrink-0 h-screen" 
          style={{width:sidebarOpen?170:50}}
          onMouseEnter={()=>setSidebarHover(true)}
          onMouseLeave={()=>setSidebarHover(false)}
        >
          <div className="p-3 border-b border-white/10 flex items-center justify-center">
            <img src="https://cdn.prod.website-files.com/5f165d4a54d5863dea0e4a83/6887f69d61ac9cf5c9c5cf43_RedHammer%20Logo%20%23333.jpg" alt="RedHammer" className="h-10 rounded flex-shrink-0 object-contain"/>
          </div>
          <nav className="flex-1 py-2">
            {[{id:'home',label:'Home',Icon:HomeIcon},{id:'quotes',label:'Quotes',Icon:ReportIcon},{id:'templates',label:'Templates',Icon:ReportIcon},{id:'customers',label:'Customers',Icon:TeamIcon},{id:'report',label:'Reports',Icon:ReportIcon}].map(v=>(
              <button key={v.id} onClick={()=>handleNavigation(v.id)} className={`w-full px-4 py-2 text-left text-sm relative flex items-center gap-2 ${view===v.id?'bg-white/10 text-white nav-active':'text-white/60 hover:text-white'}`}>
                <v.Icon/>
                {sidebarOpen&&<span>{v.label}</span>}
                {v.id==='admin'&&adminHasChanges&&sidebarOpen&&<span className="w-2 h-2 bg-yellow-400 rounded-full ml-auto"></span>}
              </button>
            ))}
          </nav>
          {sidebarOpen&&(
            <div className="p-3 border-t border-white/10">
              <button 
                onClick={()=>setSidebarPinned(!sidebarPinned)} 
                className={`w-full px-3 py-1.5 text-xs rounded flex items-center justify-center gap-2 ${sidebarPinned?'bg-white/20 text-white':'bg-white/10 text-white/60 hover:text-white'}`}
                title={sidebarPinned?'Unpin sidebar':'Pin sidebar'}
              >
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{transform:sidebarPinned?'rotate(0deg)':'rotate(45deg)',transition:'transform 0.2s'}}>
                  <path d="M12 2v10M12 22v-6M4.93 10.93l1.41 1.41M17.66 12.34l1.41 1.41M2 18l4-4M18 18l4-4M12 12a2 2 0 100-4 2 2 0 000 4z"/>
                </svg>
                {sidebarPinned?'Pinned':'Pin Menu'}
              </button>
            </div>
          )}
          {/* User menu - Team and Admin */}
          <div className="p-3 border-t border-white/10 space-y-2">
            {sidebarOpen?(
              <>
                <button onClick={()=>{setView('admin');setAdminTab('users');}} className="w-full px-3 py-2 bg-white/10 hover:bg-white/20 text-white text-xs rounded flex items-center justify-center gap-2">
                  <TeamIcon/>
                  Team
                </button>
                <button onClick={()=>{setView('admin');setAdminTab('settings');}} className="w-full px-3 py-2 bg-white/10 hover:bg-white/20 text-white text-xs rounded flex items-center justify-center gap-2">
                  <GearIcon/>
                  Admin
                </button>
                <div className="pt-2 border-t border-white/10">
                  <div className="text-xs text-white/50 truncate mb-1">{user?.email}</div>
                  <button onClick={handleSignOut} className="w-full px-3 py-1.5 text-xs text-white/60 hover:text-white hover:bg-white/10 rounded">Sign Out</button>
                </div>
              </>
            ):(
              <>
                <button onClick={()=>{setView('admin');setAdminTab('users');}} className="w-full p-2 bg-white/10 hover:bg-white/20 text-white rounded flex items-center justify-center" title="Team">
                  <TeamIcon/>
                </button>
                <button onClick={()=>{setView('admin');setAdminTab('settings');}} className="w-full p-2 bg-white/10 hover:bg-white/20 text-white rounded flex items-center justify-center" title="Admin">
                  <GearIcon/>
                </button>
              </>
            )}
          </div>
        </aside>
        <main className={`flex-1 overflow-auto pb-20 bg-gray-50 ${view==='quote'?'lg:mr-[240px]':''}`}>
          {/* Sticky Header for all pages */}
          <div className="p-6">
          {view==='home'&&<HomeView/>}
          {view==='quote'&&<QuoteBuilderView/>}
          {view==='quotes'&&<QuotesView/>}
          {view==='templates'&&<TemplatesView/>}
          {view==='customers'&&<CustomersView/>}
          {view==='admin'&&<AdminView initialTab={adminTab} setAdminTab={setAdminTab}/>}
          </div>
          <footer className="mt-12 pt-6 border-t border-gray-200 text-center text-sm text-gray-400 px-6">
            <p>RedHammer Platform v2.0 • Construction Accounting Services</p>
          </footer>
        </main>
      </div>
    </AppContext.Provider>
  );
}

ReactDOM.render(<App/>,document.getElementById('root'));
</script>
</body>
</html>
